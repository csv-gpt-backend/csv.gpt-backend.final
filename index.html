<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta de Datos k</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --brand:#0b66ff;
      --ok:#16a34a; --err:#e11d48; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;padding:24px;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto}
    h1{font-size:40px;margin:0 0 16px;color:#0a2f7a}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 18px rgba(2,8,23,.06)}
    .pad{padding:20px}
    .row{display:grid;gap:16px}
    .grid-2{grid-template-columns:1.2fr .8fr}
    textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:12px;padding:14px;font-size:16px;resize:vertical}
    select,input{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:15px}
    label{font-size:13px;color:var(--muted)}
    .btn{appearance:none;border:1px solid transparent;background:var(--brand);color:#fff;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--border)}
    .btn.ghost{background:#fff;color:var(--brand);border-color:var(--brand)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .status{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .ok{background:var(--ok)} .err{background:var(--err)}
    .block{display:block}
    .section-title{font-weight:700;margin:8px 0 6px}
    .muted{color:var(--muted)}
    .result{margin-top:16px}
    .list{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .list-item{display:flex;justify-content:space-between;padding:10px 12px;border-top:1px solid var(--border)}
    .list-item:first-child{border-top:0}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-top:1px solid var(--border)}
    th{background:#f3f6ff;text-align:left;font-weight:700}
    tr:first-child td{border-top:0}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px dashed var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted);cursor:pointer;background:#fff}
    .flex{display:flex;gap:10px}
    @media (max-width: 920px){ .grid-2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Consulta de Datos</h1>

    <!-- CONFIG -->
    <div class="card pad">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div class="status">
          <span id="dot" class="dot"></span>
          <span id="status">Comprobando servicio…</span>
        </div>
        <div class="chips">
          <span class="chip" data-q="lista de estudiantes">lista de estudiantes</span>
          <span class="chip" data-q="promedio de AUTOESTIMA por paralelo">promedio de AUTOESTIMA por paralelo</span>
          <span class="chip" data-q="P90 de TENSIÓN por paralelo">P90 de TENSIÓN por paralelo</span>
          <span class="chip" data-q="estadisticos de AUTOESTIMA por paralelo">estadísticos AUTOESTIMA</span>
          <span class="chip" data-q="comparar medias de AUTOESTIMA entre A y B">t de AUTOESTIMA A vs B</span>
        </div>
      </div>
      <div class="row grid-2" style="margin-top:14px">
        <div>
          <label>Consulta libre</label>
          <textarea id="txt"></textarea>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn" id="btnSend">Enviar</button>
            <button class="btn secondary" id="btnClear">Limpiar</button>
          </div>
          <div class="hint">El resultado puede contener texto, listas y tablas con exportación a CSV.</div>
        </div>

        <div>
          <div class="section-title">Constructores de consulta</div>

          <div class="row" style="grid-template-columns:1fr 1fr">
            <div>
              <label>Columna</label>
              <select id="selCol"></select>
            </div>
            <div>
              <label>Percentil</label>
              <select id="selP">
                <option value="P10">P10</option>
                <option value="P25">P25</option>
                <option value="P50">P50 (Mediana)</option>
                <option value="P75">P75</option>
                <option value="P90">P90</option>
              </select>
            </div>
          </div>

          <div class="row" style="grid-template-columns:1fr 1fr">
            <div>
              <label>Grupo 1 (paralelo)</label>
              <select id="selA">
                <option>A</option><option>B</option>
              </select>
            </div>
            <div>
              <label>Grupo 2 (paralelo)</label>
              <select id="selB">
                <option>B</option><option>A</option>
              </select>
            </div>
          </div>

          <div class="toolbar" style="margin-top:10px;flex-wrap:wrap">
            <button class="btn ghost" id="qList">Lista de estudiantes</button>
            <button class="btn ghost" id="qAvg">Promedio por paralelo</button>
            <button class="btn ghost" id="qPct">Percentil por paralelo</button>
            <button class="btn ghost" id="qMed">Mediana por paralelo</button>
            <button class="btn ghost" id="qStats">Estadísticos / IC95</button>
            <button class="btn ghost" id="qT">t de Welch (A vs B)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RESULTADOS -->
    <div id="out" class="card pad result" hidden>
      <div id="general" class="section-title"></div>
      <div id="lists"></div>
      <div id="tables"></div>
    </div>
  </div>

<script>
/** CONFIG –– PON AQUÍ TU BACKEND **/
const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app";

/** UI refs **/
const txt = document.getElementById('txt');
const btnSend = document.getElementById('btnSend');
const btnClear = document.getElementById('btnClear');
const out = document.getElementById('out');
const general = document.getElementById('general');
const lists = document.getElementById('lists');
const tables = document.getElementById('tables');
const statusEl = document.getElementById('status');
const dot = document.getElementById('dot');
const selCol = document.getElementById('selCol');
const selP = document.getElementById('selP');
const selA = document.getElementById('selA');
const selB = document.getElementById('selB');

const chips = document.querySelectorAll('.chip');

/** helpers **/
function setStatus(ok, msg){
  statusEl.textContent = msg;
  dot.className = 'dot ' + (ok ? 'ok' : 'err');
}
function clearOutput(){
  general.textContent = '';
  lists.innerHTML = '';
  tables.innerHTML = '';
  out.hidden = true;
}
function showOutput(g, ls=[], tbs=[]){
  general.textContent = g || '';
  lists.innerHTML = '';
  tbs = tbs || [];

  // listas
  if (ls && ls.length){
    const wrap = document.createElement('div');
    wrap.className = 'list';
    ls.forEach(item=>{
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `<span class="muted">${item[0]||''}</span><strong>${item[1]||''}</strong>`;
      wrap.appendChild(div);
    });
    lists.appendChild(wrap);
  }

  // tablas
  tables.innerHTML = '';
  tbs.forEach(tb=>{
    const card = document.createElement('div');
    card.style.marginTop = '12px';
    const title = document.createElement('div');
    title.className = 'section-title';
    title.textContent = tb.title || 'Tabla';

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    (tb.columns||[]).forEach(c=>{
      const th = document.createElement('th'); th.textContent = c; trh.appendChild(th);
    });
    thead.appendChild(trh);
    const tbody = document.createElement('tbody');
    (tb.rows||[]).forEach(r=>{
      const tr = document.createElement('tr');
      r.forEach(cell=>{
        const td = document.createElement('td'); td.textContent = cell; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(thead); table.appendChild(tbody);

    const actions = document.createElement('div');
    actions.className = 'actions';
    const bCopy = document.createElement('button'); bCopy.className='btn secondary'; bCopy.textContent='Copiar';
    const bCsv = document.createElement('button'); bCsv.className='btn secondary'; bCsv.textContent='CSV';

    bCopy.onclick = ()=>{
      let txt = (tb.columns||[]).join('\t') + '\n';
      (tb.rows||[]).forEach(r => { txt += r.join('\t') + '\n'; });
      navigator.clipboard.writeText(txt);
      bCopy.textContent = '¡Copiado!';
      setTimeout(()=>bCopy.textContent='Copiar',1200);
    };
    bCsv.onclick = ()=>{
      const toCsv = (arr)=>arr.map(s=>`"${String(s).replaceAll('"','""')}"`).join(',');
      let csv = toCsv(tb.columns||[]) + '\n';
      (tb.rows||[]).forEach(r => { csv += toCsv(r) + '\n'; });
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (tb.title||'tabla') + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    actions.appendChild(bCopy); actions.appendChild(bCsv);
    card.appendChild(title);
    card.appendChild(table);
    card.appendChild(actions);
    tables.appendChild(card);
  });

  out.hidden = false;
}

/** fetch with timeout **/
async function withTimeout(promise, ms=90000){
  let t;
  return Promise.race([
    promise,
    new Promise((_,rej)=> t=setTimeout(()=>rej(new Error('Tiempo de espera agotado')), ms))
  ]).finally(()=>clearTimeout(t));
}

/** Call API **/
async function ask(q){
  clearOutput();
  setStatus(true, 'Consultando…');

  try{
    const url = `${API_BASE}/api/answer?q=${encodeURIComponent(q)}`;
    const res = await withTimeout(fetch(url,{headers:{Accept:'application/json'}}), 90000);
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); } catch{ data = { ok:true, general:text, lists:[], tables:[] }; }
    if(!res.ok || data.ok===false){
      setStatus(false, 'Error al consultar');
      showOutput(data.error || res.statusText || 'Error desconocido');
      return;
    }
    setStatus(true, 'Listo ✅');
    showOutput(data.general, data.lists, data.tables);
  }catch(err){
    setStatus(false, 'Error de red');
    showOutput(`Error de conexión: ${err.message}`);
  }
}

/** Eventos UI **/
btnSend.onclick = () => {
  const q = txt.value.trim();
  if(!q){ txt.focus(); return; }
  ask(q);
};
btnClear.onclick = () => { txt.value=''; clearOutput(); };

chips.forEach(chip=>{
  chip.onclick = () => {
    txt.value = chip.dataset.q || '';
    ask(txt.value);
  };
});

// Constructores
document.getElementById('qList').onclick = ()=> ask('lista de estudiantes');
document.getElementById('qAvg').onclick = ()=>{
  const c = selCol.value; if(!c) return;
  ask(`promedio de ${c} por paralelo`);
};
document.getElementById('qPct').onclick = ()=>{
  const c = selCol.value; const p = selP.value; if(!c) return;
  ask(`${p} de ${c} por paralelo`);
};
document.getElementById('qMed').onclick = ()=>{
  const c = selCol.value; if(!c) return;
  ask(`mediana de ${c} por paralelo`);
};
document.getElementById('qStats').onclick = ()=>{
  const c = selCol.value; if(!c) return;
  ask(`estadisticos de ${c} por paralelo`);
};
document.getElementById('qT').onclick = ()=>{
  const c = selCol.value; if(!c) return;
  const a = selA.value || 'A', b = selB.value || 'B';
  ask(`comparar medias de ${c} entre ${a} y ${b}`);
};

/** Carga columnas y healthcheck **/
async function boot(){
  try{
    const h = await fetch(`${API_BASE}/api/health`).then(r=>r.json());
    setStatus(true, 'Servicio en línea');
  }catch{ setStatus(false, 'No disponible'); }

  try{
    const data = await fetch(`${API_BASE}/api/columns`).then(r=>r.json());
    const cols = (data.columns||[]).filter(c=>c && c.trim()!=="");
    selCol.innerHTML = cols.map(c=>`<option>${c}</option>`).join('');
  }catch{
    selCol.innerHTML = `<option value="">(sin columnas)</option>`;
  }
}
boot();
</script>
</body>
</html>
