<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fffffccccccccddddddvvvvvffffLexiumhhh ‚Äî Consultas</title>
  <style>
    body{margin:0;font-family:system-ui,Inter,Segoe UI,Roboto,Arial;background:#0b1020;color:#e5e7eb}
    .wrap{max-width:980px;margin:18px auto;padding:0 14px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .chip{background:#1f2a4a;border:1px solid #223055;border-radius:999px;padding:6px 10px;font-size:12px}
    .card{background:#111832cc;border:1px solid #243152;border-radius:14px;padding:12px;margin-top:10px}
    textarea{width:100%;min-height:100px;background:#0e1530;color:#e5e7eb;border:1px solid #2a3a63;border-radius:12px;padding:12px;font-size:15px;resize:vertical}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{background:#13204a;border:1px solid #2a3a63;color:#e5e7eb;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    button.primary{background:#1b3a7a;border-color:#3959a2}
    .answer{white-space:pre-wrap;min-height:140px;max-height:380px;overflow:auto;border:1px solid #243152;background:#0d142e;border-radius:12px;padding:12px}
    .spinner{display:none;width:16px;height:16px;border:2px solid #3a4f86;border-top-color:#90b4ff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .small{font-size:12px;color:#9fb1d1}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 8px 0;font-size:18px">Lexium ‚Äî Consultas</h1>
    <div class="bar">
      <span class="chip">Ruta: <b id="badge-ruta">‚Äî</b></span>
      <span class="chip">Tiempo: <b id="badge-tiempo">‚Äî</b></span>
      <span class="chip">Voz: <b id="badge-voz">Silencio</b></span>
    </div>

    <div class="card">
      <label class="small">Escribe tu pregunta</label>
      <textarea id="q" placeholder="Ej.: ¬øQu√© es Lexium? ¬∑ Lista de evaluaciones ¬∑ ¬øC√≥mo se aplica la evaluaci√≥n emocional?"></textarea>
      <div class="small" style="margin-top:4px">Enter = Enviar ¬∑ Shift+Enter = salto de l√≠nea</div>
      <div class="actions">
        <button id="btn-enviar" class="primary">Enviar</button>
        <button id="btn-voz">‚èØ Voz</button>
        <button id="btn-clear">üßπ Limpiar</button>
        <div class="spinner" id="spinner"></div>
      </div>
    </div>

    <div class="card">
      <label class="small">Respuesta</label>
      <div id="answer" class="answer"></div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app"; // tu Cloud Run
    const GPT_PATH = "/api/gpt";         // preferido (POST cl√°sico fiable)
    const FALLBACK = "/api/answer";      // compat (GET, misma l√≥gica)

    // ===== Helpers UI =====
    const $ = (id)=>document.getElementById(id);
    const setTxt = (id,v)=>{ const el=$(id); if(el) el.textContent=v; };
    const spinner = $("spinner");
    const setBusy = (b)=> spinner.style.display = b ? "inline-block" : "none";
    const ms = (n)=> isFinite(n) ? `${Math.round(n)} ms` : "‚Äî";
    let speaking=false, lastAnswer="";

    function speakStop(){ window.speechSynthesis.cancel(); speaking=false; setTxt("badge-voz","Silencio"); }
    function speak(text){
      if(!text) return;
      speakStop();
      const u=new SpeechSynthesisUtterance(text);
      const voices=speechSynthesis.getVoices();
      const chosen=voices.find(v=>/^es[-_]/i.test(v.lang)) || voices[0];
      u.voice=chosen; u.lang=(chosen&&chosen.lang)||"es-ES"; u.rate=1; u.pitch=1; u.volume=1;
      u.onstart=()=>{ speaking=true; setTxt("badge-voz","Hablando"); };
      u.onend=()=>{ speaking=false; setTxt("badge-voz","Silencio"); };
      window.speechSynthesis.speak(u);
    }

    async function preguntar(){
      const q = ($("q").value||"").trim();
      if(!q){ $("q").focus(); return; }
      setBusy(true); setTxt("badge-ruta","‚Äî"); setTxt("badge-tiempo","‚Äî");
      $("answer").textContent = "‚Ä¶";

      const t0 = performance.now();
      try{
        // 1) POST /api/gpt (fiable)
        const r = await fetch(API_BASE + GPT_PATH, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ q })
        });
        let data = null;
        if (r.ok) data = await r.json();
        else throw new Error(`HTTP ${r.status}`);

        setTxt("badge-ruta", data?.ruta || "criterio");
        setTxt("badge-tiempo", ms(data?.tiempo_ms ?? (performance.now()-t0)));
        lastAnswer = (data && data.answer) ? String(data.answer) : "Sin respuesta.";
        $("answer").textContent = lastAnswer;
        if (lastAnswer) speak(lastAnswer);
      }catch(_e){
        // 2) Fallback GET /api/answer (misma l√≥gica)
        try{
          const r2 = await fetch(API_BASE + FALLBACK + "?q=" + encodeURIComponent(q));
          const data2 = await r2.json();
          setTxt("badge-ruta", data2?.ruta || "criterio");
          setTxt("badge-tiempo", ms(data2?.tiempo_ms ?? (performance.now()-t0)));
          lastAnswer = (data2 && data2.answer) ? String(data2.answer) : "Sin respuesta.";
          $("answer").textContent = lastAnswer;
          if (lastAnswer) speak(lastAnswer);
        }catch(e2){
          $("answer").textContent = "No se pudo contactar el servicio.";
          setTxt("badge-ruta","‚Äî"); setTxt("badge-tiempo","‚Äî");
        }
      }finally{
        setBusy(false);
      }
    }

    $("btn-enviar").onclick = preguntar;
    $("q").addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); preguntar(); } });
    $("btn-clear").onclick = ()=>{ $("q").value=""; $("q").focus(); $("answer").textContent=""; setTxt("badge-ruta","‚Äî"); setTxt("badge-tiempo","‚Äî"); speakStop(); };
    $("btn-voz").onclick = ()=> speaking ? speakStop() : speak(lastAnswer);
  </script>
</body>
</html>





