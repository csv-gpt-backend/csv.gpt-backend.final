<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>0947 Asistente Lexium</title>

<link rel="preconnect" href="https://lexium-gpt5-383217514425.southamerica-west1.run.app" crossorigin>
<link rel="dns-prefetch" href="//lexium-gpt5-383217514425.southamerica-west1.run.app">

<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#6b7280; --pri:#0d6efd; --bd:#e5e7eb;
    --ok:#16a34a; --err:#b91c1c;
    --heroH: 65vh;
    --wrapW: 1180px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;}

  .mediaBar{
    position:fixed; top:0; left:0; width:100vw; z-index:50;
    background:#fff; border-bottom:none; padding:0; margin:0;
    pointer-events:none;
  }
  .mediaBar *{ pointer-events:none; }
  .mediaInner{max-width:var(--wrapW); margin:0 auto; padding:12px;}
  .heroGrid{display:grid; grid-template-columns:1fr 3fr 1.16fr; align-items:center; gap:8px;}
  .sideImg{display:flex; justify-content:center; height:var(--heroH); margin:0;}
  .sideImg img{max-width:100%; height:100%; object-fit:contain; opacity:.95}
  .videoBox{height:var(--heroH); margin:0;}
  .videoBox video{width:100%; height:100%; object-fit:cover; border:none; display:block; border-radius:10px}

  .contentWrap{max-width:var(--wrapW); margin:0 auto; padding:12px; padding-top:calc(var(--heroH) + 8px);}

  .toolbar{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:8px 0}
  .toolbar button, .toolbar select{padding:9px 14px; border:1px solid var(--bd); border-radius:10px; background:#fff; cursor:pointer;}
  .toolbar button:hover{background:#f5f7fb}
  .toolbar button[disabled]{opacity:.6; cursor:not-allowed}

  .hist{position:fixed; right:14px; top:10px; z-index:60}
  .hist button{padding:8px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff}

  .query{
    width:100%;
    min-height:48px; max-height:200px;
    resize:vertical;
    border:1px solid var(--bd); border-radius:10px;
    padding:8px 10px; font-size:16px; line-height:1.35;
    overflow:auto;
  }

  .out{margin:8px 0; border:1px solid var(--bd); border-radius:12px; padding:12px; overflow:auto; white-space:pre-wrap; max-height:65vh; font-size:.95rem; line-height:1.5; scrollbar-gutter:stable;}
  .muted{color:var(--muted); font-size:.9rem}

  table{width:100%; border-collapse:collapse; margin:10px 0}
  th,td{border:1px solid var(--bd); padding:8px}
  th{background:#f8fafc; text-align:left}

  .loader{display:inline-flex; align-items:center; gap:8px; font-size:.95rem; color:var(--muted)}
  .dot{width:8px; height:8px; border-radius:50%; background:var(--pri); opacity:.7; animation:bounce 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}
  .dot:nth-child(3){animation-delay:.3s}
  @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

  #status { position:fixed; top:8px; left:12px; z-index:70; }

  .overlay{display:none; position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:80; align-items:center; justify-content:center; padding:24px;}
  .overlay.show{ display:flex; }
  .panel{background:#fff; border:1px solid var(--bd); border-radius:12px; width:min(900px, 92vw); max-height:80vh; overflow:auto; padding:16px;}
  .panel header{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
  .panel h2{margin:0; font-size:18px}
  .closeBtn{border:1px solid var(--bd); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer}
  .session{border-top:1px solid var(--bd); padding:10px 0; display:flex; align-items:center; gap:10px}
  .session .meta{flex:1}
  .viewBtn{border:1px solid var(--bd); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer}
  .linkBadge{font-size:.82rem; margin-left:6px}
  .okBadge{color:var(--ok)} .warnBadge{color:#b45309}
</style>
</head>
<body>

  <div class="hist">
    <button id="btnHist" title="Ver sesiones guardadas">Historial</button>
  </div>

  <div class="mediaBar" aria-label="cabecera">
    <div class="mediaInner">
      <div class="heroGrid">
        <div class="sideImg left"><img src="left.png" alt="Logo izquierdo"/></div>
        <div class="videoBox"><video id="vid" preload="auto" muted playsinline src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"></video></div>
        <div class="sideImg right"><img src="right.png" alt="Logo derecho"/></div>
      </div>
    </div>
  </div>

  <div class="contentWrap">
    <div style="margin:10px 0 6px">
      <textarea id="q" class="query" rows="2" placeholder="ESCRIBE O HABLA PARA PREGUNTAR‚Ä¶ (Shift+Enter = nueva l√≠nea, Ctrl/Cmd+Enter = enviar)"></textarea>
    </div>

    <div class="toolbar">
      <button id="btnSend" title="Enviar consulta al backend">Enviar</button>
      <button id="btnCancel" title="Cancelar consulta en curso">‚úñ Cancelar</button>
      <button id="btnDict" title="Dictar por voz (empieza / detiene)">üé§ Dictar</button>
      <button id="btnToggleAV" title="Parar/Activar voz">‚èØ Activar voz</button>
      <button id="btnReplay" title="Reproducir nuevamente la voz desde el principio">‚ü≥ Reproducir</button>
      <button id="btnNew" title="Nueva sesi√≥n (limpia y guarda la actual)">Ôºã Nueva sesi√≥n</button>
      <button id="btnClear" title="Limpiar pregunta y respuesta">üßπ Limpiar</button>
      <select id="selExport" title="Exportar lo generado (PDF muestra vista previa)">
        <option value="">Exportar‚Ä¶</option>
        <option value="pdf">PDF (vista previa)</option>
        <option value="csv">CSV</option>
        <option value="doc">DOC</option>
      </select>
    </div>

    <div id="out" class="out" aria-live="polite"></div>
    <div id="status" class="muted"></div>
  </div>

  <div id="histOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="panel">
      <header><h2>Sesiones</h2><button class="closeBtn" id="closeHist">Cerrar</button></header>
      <div id="histBody"></div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://lexium-gpt5-383217514425.southamerica-west1.run.app";
const GPT_PATH = "/api/gpt";
const STATUS_PATH = "/api/gpt/status";  // si tu server lo soporta
const FALLBACK_PATH = "/api/answer";

/* Ahorro de costos (true = respuestas compactas y sin expansi√≥n salvo caso extremo) */
const COST_SAVER = true;

/* Timeouts largos + polling (para evitar ‚ÄúFailed to fetch‚Äù) */
const TIMEOUT_GPT_MS = 240000;      // 4 min
const TIMEOUT_FALLBACK_MS = 180000; // 3 min
const JOB_POLL_MAX_MS = 10*60*1000; // 10 min
const JOB_POLL_INTERVAL_MS = 2500;  // 2.5s

/* Warm-up liviano (HEAD) para no gastar tokens */
(async()=>{ try{ await fetch(`${API_BASE}${FALLBACK_PATH}?q=ping`,{method:"HEAD"});}catch(_){}})();

/* ====== UI refs ====== */
const q = document.getElementById("q");
const out = document.getElementById("out");
const statusEl = document.getElementById("status");
const vid = document.getElementById("vid");
const btnSend = document.getElementById("btnSend");
const btnCancel = document.getElementById("btnCancel");
const btnDict = document.getElementById("btnDict");
const btnToggleAV = document.getElementById("btnToggleAV");
const btnReplay = document.getElementById("btnReplay");
const btnNew = document.getElementById("btnNew");
const btnClear = document.getElementById("btnClear");
const selExport = document.getElementById("selExport");
const btnHist = document.getElementById("btnHist");
const histOverlay = document.getElementById("histOverlay");
const histBody = document.getElementById("histBody");
const closeHist = document.getElementById("closeHist");

let isBusy=false, currentAbortCtrl=null, jobPollAbort=false;

/* ====== Utils ====== */
function esc(x){ return String(x).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }
function setStatusLoading(msg="Generando‚Ä¶"){
  statusEl.innerHTML = `<span class="loader" role="status" aria-busy="true"><span class="dot"></span><span class="dot"></span><span class="dot"></span>${esc(msg)}</span>`;
}
function clearStatus(){ statusEl.textContent=""; }
function setStatusText(msg=""){ statusEl.textContent = msg? String(msg):""; }
function detectLang(t){ t=(t||"").toLowerCase(); if(/\b(the|and|you|your|please|could|would)\b/.test(t)) return "en"; if(/[√°√©√≠√≥√∫√±√º]/.test(t)||/\b(el|la|de|que|para)\b/.test(t)) return "es"; return (navigator.language||"es").startsWith("en")?"en":"es"; }
function detectTextLang(s){ s=(s||"").toLowerCase(); const en=/( the | and | with | result | summary )/i.test(s); const es=/[√°√©√≠√≥√∫√±√º]/.test(s)||/\b(el|la|de|que|para|promedio)\b/.test(s); return en&&!es?"en":es?"es":"unknown"; }

const URL_RE=/\bhttps?:\/\/[^\s<>"']+/gi;
function linkifyHTML(html){ return html.replace(URL_RE,(u)=>{ const s=esc(u); return `<a href="${s}" target="_blank" rel="noopener">${s}</a><span class="linkBadge" data-url="${s}">‚è≥</span>`; }); }
async function verifyLinks(){ for(const b of document.querySelectorAll('.linkBadge[data-url]')){ const url=b.getAttribute('data-url'); try{ let ok=false; try{ok=(await fetch(url,{method:"HEAD"})).ok;}catch{ok=(await fetch(url,{method:"GET",mode:"cors"})).ok;} b.textContent=ok?"‚úÖ":"‚ö†Ô∏è"; b.classList.add(ok?"okBadge":"warnBadge"); }catch{ b.textContent="‚ö†Ô∏è"; b.classList.add("warnBadge"); } } }
const idle=window.requestIdleCallback||((fn)=>setTimeout(fn,120));

function friendlyApiError(status, bodyText){
  if(status===402) return "Saldo agotado o m√©todo de pago requerido (OpenAI API 402)";
  if(status===429) return "Cuota/velocidad alcanzada (429)";
  if(status===401) return "API key inv√°lida o sin permisos (401)";
  return bodyText||`HTTP ${status}`;
}

/* ====== Historial robusto ====== */
const SESS_KEY="lexium_sessions_v4"; const SESS_FBK="lexium_sessions_v4_fb";
const lsGet=k=>{try{return JSON.parse(localStorage.getItem(k)||"[]")}catch{return[]}};
const lsSet=(k,a)=>{try{localStorage.setItem(k,JSON.stringify(a));return true}catch{return false}};
const ssGet=k=>{try{return JSON.parse(sessionStorage.getItem(k)||"[]")}catch{return[]}};
const ssSet=(k,a)=>{try{sessionStorage.setItem(k,JSON.stringify(a));return true}catch{return false}};

function saveSession(question,data){
  const html=(out?.innerHTML||"").trim(), text=(out?.textContent||"").trim();
  const entry={id:new Date().toISOString(),question:question||"(sin pregunta)",html,text,payload:data||null,when:Date.now()};
  const cur=lsGet(SESS_KEY); if(!lsSet(SESS_KEY,[entry,...cur].slice(0,50))){ const fb=ssGet(SESS_FBK); ssSet(SESS_FBK,[entry,...fb].slice(0,50)); }
}
function readSessions(){
  let all=lsGet(SESS_KEY); if(!all.length) all=ssGet(SESS_FBK);
  try{ const a=JSON.parse(localStorage.getItem("lexium_sessions")||"[]"); const b=JSON.parse(sessionStorage.getItem("lexium_sessions_fallback")||"[]"); const m=[...all,...a,...b]; if(m.length) return m.slice(0,50);}catch{}
  return all;
}
function renderHistory(){
  const all=readSessions();
  if(!all.length){ histBody.innerHTML="<p class='muted'>Sin historial.</p>"; return; }
  histBody.innerHTML = all.map(s=>`
    <div class="session">
      <div class="meta">
        <b>${new Date(s.when).toLocaleString()}</b>
        <div><i>Pregunta:</i> ${esc(s.question)}</div>
        <div class="muted">${esc((s.text||"").slice(0,160))}${(s.text||"").length>160?"‚Ä¶":""}</div>
      </div>
      <button class="viewBtn" data-id="${esc(s.id)}">Ver</button>
    </div>`).join("");
}
function openHistory(){ renderHistory(); histOverlay.classList.add("show"); }
function closeHistoryOverlay(){ histOverlay.classList.remove("show"); }
btnHist.addEventListener("click", openHistory);
closeHist.addEventListener("click", closeHistoryOverlay);
histOverlay.addEventListener("click",(e)=>{ if(e.target===histOverlay) closeHistoryOverlay(); });

histBody.addEventListener("click",(e)=>{
  const btn=e.target.closest(".viewBtn"); if(!btn) return; e.preventDefault(); e.stopPropagation();
  const id=btn.getAttribute("data-id"); const sessions=readSessions(); if(!sessions.length){ alert("No hay sesiones guardadas."); return; }
  const match=sessions.find(x=>x.id===id); if(!match){ alert("No se encontr√≥ la sesi√≥n."); return; }
  let html=(match.html||"").trim();
  if(!html && match.payload){
    const d=match.payload, qst=match.question||""; if(qst) html+=`<h3>Pregunta</h3><p>${esc(qst)}</p>`;
    const g=d.general||d.answer||d.text||match.text||""; if(g) html+=generalToOrderedListHTML(g);
    (normalizeLists(d.lists||[])).forEach(l=>{ html+=`<h3>${esc(l.title||"Lista")}</h3><ol>${l.items.map(it=>`<li>${esc(it)}</li>`).join("")}</ol>`; });
    (d.tables||[]).forEach(t=>{ const cols=t.columns||[], rows=t.rows||[]; html+=`<h3>${esc(t.title||"Tabla")}</h3><table><thead><tr>${cols.map(c=>`<th>${esc(c)}</th>`).join("")}</tr></thead><tbody>${rows.map(r=>`<tr>${r.map(x=>`<td>${esc(x)}</td>`).join("")}</tr>`).join("")}</tbody></table>`; });
  }
  if(!html && match.text) html=`<pre>${esc(match.text)}</pre>`;
  out.innerHTML=html||"<em>Vac√≠o</em>"; out.scrollTop=0; clearStatus(); closeHistoryOverlay();
});

/* ====== Dictado ====== */
let recognizer=null;
function toggleDict(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert("Dictado no soportado en este navegador."); return; }
  if(!recognizer){ recognizer=new SR(); recognizer.lang="es-ES"; recognizer.continuous=false; recognizer.interimResults=false; recognizer.onresult=e=>{ const t=Array.from(e.results).map(r=>r[0].transcript).join(" "); q.value=(q.value? q.value+" " : "")+t; }; }
  if(recognizer.listening){ recognizer.stop(); recognizer.listening=false; btnDict.textContent="üé§ Dictar"; }
  else { recognizer.start(); recognizer.listening=true; btnDict.textContent="‚èπ Detener dictado"; }
}

/* ====== Voz/Video ====== */
const PREFERRED_NAMES_ES=["Microsoft Sabina","Microsoft Helena","Microsoft Laura","Microsoft Maria","Microsoft Lucia","Monica","Paulina","Camila","Sofia","Elena","Lucia","Maria","Carla","Google espa√±ol","Google espa√±ol de Estados","Google US Espa√±ol"];
const PREFERRED_NAMES_EN=["Microsoft Jenny","Microsoft Aria","Microsoft Zira","Microsoft Sara","Google US English","Google UK English"];
const SP_LANGS=["es","es-ES","es-MX","es-US","es-419","es-AR","es-CL","es-CO","es-PE","es-EC"]; const EN_LANGS=["en","en-US","en-GB","en-CA","en-AU","en-IN"];
function pickVoice(lang){ const vs=(speechSynthesis.getVoices()||[]); const pref=lang==="en"?PREFERRED_NAMES_EN:PREFERRED_NAMES_ES; const langs=lang==="en"?EN_LANGS:SP_LANGS; for(const n of pref){ const m=vs.find(v=>v.name?.toLowerCase().includes(n.toLowerCase())); if(m) return m; } return vs.find(v=>langs.some(l=>(v.lang||"").toLowerCase().startsWith(l)))||vs[0]||null; }

const BULLET_RE=/^(?:[‚Ä¢\-‚Äì*]|\d+\.)\s+/u;
function generalToOrderedListHTML(g){
  if(!g) return "";
  const lines=g.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const bulletLike=lines.filter(s=>BULLET_RE.test(s)).length;
  const manyPlain=lines.filter(s=>!/[.!?;:]\s*$/.test(s)&&s.length<=80).length;
  const should=(lines.length>=3)&&(bulletLike>0||manyPlain>=Math.ceil(lines.length*0.6));
  if(should){ const items=lines.map(s=>s.replace(BULLET_RE,"")).filter(Boolean); return `<ol>${items.map(it=>`<li>${esc(it)}</li>`).join("")}</ol>`; }
  return `<p>${esc(g).replace(/\n/g,"<br>")}</p>`;
}

function buildTTSTextFromOut(){
  const c=document.createElement("div"); c.innerHTML=out.innerHTML; const parts=[];
  c.querySelectorAll("h1,h2,h3,h4").forEach(h=>{ const t=h.textContent.trim(); if(t) parts.push(t); });
  c.querySelectorAll("p").forEach(p=>{ const t=p.textContent.trim(); if(t) parts.push(t); });
  c.querySelectorAll("ol,ul").forEach(list=>{ const items=[...list.querySelectorAll("li")].map(li=>li.textContent.trim()).filter(Boolean); if(items.length){ parts.push(items.map((t,i)=>`${i+1}. ${t}.`).join("\n")); } });
  c.querySelectorAll("table").forEach(tbl=>{ const hh=[...tbl.querySelectorAll("thead th")].map(th=>th.textContent.trim()).filter(Boolean); if(hh.length) parts.push(`Tabla: ${hh.join(", ")}`); const rows=[...tbl.querySelectorAll("tbody tr")]; rows.forEach((tr,ri)=>{ const cells=[...tr.querySelectorAll("td")].map(td=>td.textContent.trim()); parts.push(`${ri+1}. ${cells.join(" | ")}`); }); });
  return (parts.join("\n\n")||(out.textContent||"").trim()).trim();
}
function fixSpanishDiacritics(s){ if(!s) return s; return s.replace(/\bdecimo(s|a|as)?\b/gi,(m)=>m.replace(/decimo/i,'d√©cimo')).replace(/\bseptimo(s|a|as)?\b/gi,(m)=>m.replace(/septimo/i,'s√©ptimo')).replace(/\bundecimo(s|a|as)?\b/gi,(m)=>m.replace(/undecimo/i,'und√©cimo')); }

const TTS={enabled:false,chunks:[],i:0,utter:null,paused:false,speaking:false,textCache:"",lang:"es",
  makeChunks(t,maxLen=360){const res=[];const parts=String(t).split(/(\.|\?|!|\n)/);let buf="";for(let i=0;i<parts.length;i+=2){const seg=(parts[i]||"")+(parts[i+1]||""); if((buf+seg).length<=maxLen) buf+=seg; else{ if(buf.trim()) res.push(buf.trim()); buf=seg; }} if(buf.trim()) res.push(buf.trim()); return res;},
  loadFromOut(){ let t=buildTTSTextFromOut(); if((this.lang||"es").startsWith("es")) t=fixSpanishDiacritics(t); this.textCache=t; this.chunks=this.makeChunks(t); this.i=0; },
  speakNext(){ if(!this.enabled||this.i>=this.chunks.length){ this.finish(); return; } const u=new SpeechSynthesisUtterance(this.chunks[this.i++]); const v=pickVoice(this.lang||"es"); if(v) u.voice=v; u.lang=(v?.lang)||(this.lang==="en"?"en-US":"es-ES"); u.rate=.98; u.pitch=1.08; u.volume=1; u.onstart=()=>{ this.speaking=true; this.paused=false; if(vid){ vid.loop=true; vid.muted=true; vid.play().catch(()=>{});} }; u.onend =()=>{ this.speakNext(); }; u.onerror=()=>{ this.speakNext(); }; this.utter=u; speechSynthesis.speak(u); },
  start(from=0,lang="es"){ if(typeof speechSynthesis==="undefined") return; this.lang=lang||"es"; if(!this.chunks.length) this.loadFromOut(); this.enabled=true; if(from>=0) this.i=from; speechSynthesis.cancel(); this.speakNext(); },
  pause(){ if(this.speaking&&!this.paused){ speechSynthesis.pause(); this.paused=true; if(vid) vid.pause(); } },
  resume(){ if(this.paused){ speechSynthesis.resume(); this.paused=false; if(vid) vid.play().catch(()=>{});} else if(!this.speaking&&this.enabled){ this.speakNext(); } },
  restartFromStart(lang){ this.enabled=true; this.loadFromOut(); this.start(0,lang||this.lang); },
  finish(){ this.speaking=false; this.paused=false; this.utter=null; if(vid){ vid.loop=false; vid.pause(); } },
  stopAll(){ this.enabled=false; this.paused=false; this.speaking=false; this.utter=null; if(typeof speechSynthesis!=="undefined") speechSynthesis.cancel(); if(vid){ vid.loop=false; vid.pause(); } }
};

/* ====== Normalizar listas/tablas ====== */
function normalizeLists(lists){
  if(!Array.isArray(lists)) return [];
  return lists.map((entry,i)=>{
    if(Array.isArray(entry)){
      const flat=entry.every(x=>typeof x==="string"||typeof x==="number");
      return {title:`Lista ${i+1}`, items: flat? entry : entry.map(x=>Array.isArray(x)? x.join(" ") : String(x))};
    }else if(entry && typeof entry==="object"){
      return {title: entry.title||`Lista ${i+1}`, items: Array.isArray(entry.items)? entry.items: []};
    }else{
      return {title:`Lista ${i+1}`, items:[String(entry)]};
    }
  });
}

/* ====== Render ====== */
function renderAnswer(data, userQuestion, langHint){
  let html=""; if(userQuestion){ html+=`<h3>Pregunta</h3><p>${esc(userQuestion)}</p>`; }
  const g=data.general||data.answer||data.text||""; if(g) html+=generalToOrderedListHTML(g);
  (normalizeLists(data.lists||[])).forEach(l=>{ html+=`<h3>${esc(l.title||"Lista")}</h3><ol>${l.items.map(it=>`<li>${esc(it)}</li>`).join("")}</ol>`; });
  (data.tables||[]).forEach(t=>{ const cols=t.columns||[], rows=t.rows||[]; html+=`<h3>${esc(t.title||"Tabla")}</h3><table><thead><tr>${cols.map(c=>`<th>${esc(c)}</th>`).join("")}</tr></thead><tbody>${rows.map(r=>`<tr>${r.map(x=>`<td>${esc(x)}</td>`).join("")}</tr>`).join("")}</tbody></table>`; });
  out.innerHTML=linkifyHTML(html||"<em>Sin contenido.</em>"); idle(()=>verifyLinks());
  TTS.enabled=true; TTS.loadFromOut(); TTS.start(0, langHint||"es");
}

/* ====== fetch helpers ====== */
async function fetchJSON(url, opts={}){ const r=await fetch(url,opts); let data={}; try{ data=await r.json(); }catch{} return {r,data}; }
function runWithMaybeTimeout(factory, ms, externalSignal){
  if(!ms||ms<=0) return factory(externalSignal);
  const ctrl=new AbortController(); const link=()=>{try{ctrl.abort();}catch{}}; if(externalSignal){ if(externalSignal.aborted) ctrl.abort(); else externalSignal.addEventListener("abort",link,{once:true}); }
  const t=setTimeout(()=>ctrl.abort(),ms);
  return factory(ctrl.signal).finally(()=>{ clearTimeout(t); externalSignal?.removeEventListener?.("abort",link); });
}

/* ====== Traducci√≥n (√∫ltimo recurso, cost-saver: desactivada salvo fuerza mayor) ====== */
async function forceTranslateText(text,target,headers,signal){
  if (COST_SAVER) return { general: text }; // no gastar tokens si estamos ahorrando
  const sys=target==="en"?"Translate to English only.":"Traduce al espa√±ol √∫nicamente.";
  const body={ q:(target==="en"?"Translate to English:\n\n":"Traduce al espa√±ol:\n\n")+String(text), lang:target, force_lang:true, system_hint:sys };
  const {r,data}=await fetchJSON(`${API_BASE}${GPT_PATH}`,{method:"POST",headers:{...headers,"Accept-Language":target==="en"?"en-US,en;q=0.9":"es-ES,es;q=0.9","X-Force-Language":target,"Prefer":`respond-language=${target};low_cost=1`},body:JSON.stringify(body),signal});
  if(!r.ok) throw new Error(data?.error||`HTTP ${r.status} in translation`); return data;
}

/* ====== Expansi√≥n si qued√≥ MUY corto (una sola vez y moderada) ====== */
async function expandIfTooShort(originalText, userQuestion, langHint, headers, signal){
  const words=String(originalText||"").trim().split(/\s+/).filter(Boolean);
  const minWords = COST_SAVER ? 80 : 200;          // umbral
  if(words.length>=minWords) return null;
  if (COST_SAVER) return null; // no expandir en modo ahorro
  const sys=(langHint==="en")?"Expand substantially in English; keep it concise but complete.":"Ampl√≠a en espa√±ol; conciso pero completo.";
  const {r,data}=await fetchJSON(`${API_BASE}${GPT_PATH}`,{
    method:"POST",
    headers:{...headers,"Accept-Language":langHint==="en"?"en-US,en;q=0.9":"es-ES,es;q=0.9","X-Force-Language":langHint,"Prefer":`respond-language=${langHint};low_cost=1`},
    body:JSON.stringify({ q:(langHint==="en"?`User question:\n${userQuestion}\n\nShort answer to expand:\n${originalText}\n\nDeliver a more complete answer.`:`Pregunta:\n${userQuestion}\n\nRespuesta breve a ampliar:\n${originalText}\n\nEntrega una respuesta m√°s completa.`), lang:langHint, force_lang:true, system_hint:sys, detail_level:"medium", response_size:"short", min_words:180, max_words:450 }),
    signal
  });
  if(!r.ok) return null; return data;
}

/* ====== Polling async job ====== */
async function pollJob(jobId, startedAt, langHint){
  const deadline=startedAt+JOB_POLL_MAX_MS; jobPollAbort=false;
  while(Date.now()<deadline){ if(jobPollAbort) throw new Error("Cancelado por el usuario"); await new Promise(r=>setTimeout(r,JOB_POLL_INTERVAL_MS));
    try{ const {r,data}=await fetchJSON(`${API_BASE}${STATUS_PATH}?id=${encodeURIComponent(jobId)}`,{method:"GET",signal:currentAbortCtrl?.signal});
      if(r.ok && (data?.done||data?.status==="done"||data?.result)){ const payload=data.result||data; renderAnswer(payload,payload.question||"",langHint); saveSession(payload.question||"",payload); return true; }
    }catch(e){ if(e?.name==="AbortError") throw e; }
  }
  throw new Error("Tiempo de espera de job excedido");
}

/* ====== ASK ====== */
async function ask(){
  if(isBusy) return;
  const text=q.value.trim(); if(!text) return;
  const langHint=detectLang(text); isBusy=true; currentAbortCtrl=new AbortController(); jobPollAbort=false;

  btnSend.disabled=true; btnCancel.disabled=false; const old=btnSend.textContent; btnSend.textContent="Enviando‚Ä¶";
  setStatusLoading(langHint==="en"?"Consulting‚Ä¶":"Consultando‚Ä¶");
  const t0=performance.now(); let mode="gpt";

  const commonHeaders={
    "Content-Type":"application/json",
    "Accept":"application/json",
    "Accept-Language": langHint==="en"?"en-US,en;q=0.9":"es-ES,es;q=0.9",
    "X-Force-Language": langHint,
    "Prefer": `respond-language=${langHint};respond-async=1;low_cost=1` // se√±ales de ahorro + async
  };

  const bodyBase={
    q:text, lang:langHint, force_lang:true,
    system_hint: langHint==="en" ? "Answer strictly in English." : "Responde estrictamente en espa√±ol.",
    detail_level: COST_SAVER ? "medium" : "high",
    response_size: COST_SAVER ? "short" : "full",
    min_words: COST_SAVER ? 120 : 250,
    max_words: COST_SAVER ? 450 : 800,   // tope prudente para costo
    temperature: 0.2                      // m√°s estable y barato en tokens repetidos
  };

  const doGpt=(signal)=>fetchJSON(`${API_BASE}${GPT_PATH}`,{method:"POST",headers:commonHeaders,body:JSON.stringify(bodyBase),signal});

  try{
    let res=await runWithMaybeTimeout(doGpt, TIMEOUT_GPT_MS, currentAbortCtrl.signal);

    // job por header
    const jobIdHeader=res.r.headers?.get?.("x-job-id");
    if(jobIdHeader && STATUS_PATH){ setStatusText((langHint==="en"?"Queued. Tracking ":"En cola. Seguimiento ")+jobIdHeader); await pollJob(jobIdHeader,Date.now(),langHint); setStatusText("‚úî via job"); return; }

    // job por body o 202
    if(res.r.status===202 || (res.data && res.data.job_id)){ const jobId=res.data.job_id||res.data.id||res.data.jobId; setStatusText((langHint==="en"?"Queued. Tracking ":"En cola. Seguimiento ")+jobId); await pollJob(jobId,Date.now(),langHint); setStatusText("‚úî via job"); return; }

    // fallback si 404/405
    if(res.r.status===404 || res.r.status===405){
      mode="fallback";
      const doFb=(signal)=>fetchJSON(`${API_BASE}${FALLBACK_PATH}?q=${encodeURIComponent(text)}&lang=${langHint}&force_lang=1`,{headers:{"Accept":"application/json","Accept-Language":commonHeaders["Accept-Language"],"X-Force-Language":langHint,"Prefer":`respond-language=${langHint};low_cost=1`},signal});
      res=await runWithMaybeTimeout(doFb,TIMEOUT_FALLBACK_MS,currentAbortCtrl.signal);
    }

    // errores HTTP con mensaje amable
    if(!res.r.ok){
      let raw=""; try{ raw=await res.r.text(); }catch{}
      throw new Error(friendlyApiError(res.r.status, raw || (res.data && JSON.stringify(res.data))));
    }

    let data=res.data||{}; if(data.ok===false) throw new Error(data.error||data.general||"Error");

    // idioma de salida err√≥neo ‚Üí solo traducimos si NO hay cost_saver
    try{
      const txt=(data.general||data.answer||data.text||""); const outLang=detectTextLang(txt);
      if(langHint==="en" && outLang!=="en"){ data = await forceTranslateText(txt,"en",commonHeaders,currentAbortCtrl?.signal); }
      else if(langHint==="es" && outLang!=="es"){ data = await forceTranslateText(txt,"es",commonHeaders,currentAbortCtrl?.signal); }
    }catch{ /* ignore in ahorro */ }

    // expansi√≥n moderada (si muy corto y cost_saver=false)
    try{
      const raw=(data.general||data.answer||data.text||"");
      const expanded=await expandIfTooShort(raw,text,langHint,commonHeaders,currentAbortCtrl?.signal);
      if(expanded && (expanded.general||expanded.answer||expanded.text)) data=expanded;
    }catch{}

    renderAnswer(data,text,langHint); saveSession(text,data);
    setStatusText(`‚úî ${mode==="gpt"?"GPT":"fallback"} ¬∑ ${Math.round(performance.now()-t0)} ms`);
  }catch(e1){
    const msg=String(e1||""); const isAbort=(e1?.name==="AbortError"); const looksTimeout=isAbort||/timed\s?out|user aborted|network\s?timeout/i.test(msg);
    if(looksTimeout && !currentAbortCtrl?.signal?.aborted){
      setStatusText(langHint==="en"?"Slow network, single retry‚Ä¶":"Red lenta, reintento √∫nico‚Ä¶");
      try{
        const res2=await runWithMaybeTimeout(doGpt,TIMEOUT_GPT_MS,currentAbortCtrl.signal);
        if(res2.r.status===202 || res2.data?.job_id){ const jobId=res2.data.job_id||res2.data.id||res2.data.jobId; await pollJob(jobId,Date.now(),langHint); setStatusText("‚úî via job"); return; }
        if(!res2.r.ok){ let raw=""; try{ raw=await res2.r.text(); }catch{}; throw new Error(friendlyApiError(res2.r.status, raw || (res2.data && JSON.stringify(res2.data)))); }
        let d2=res2.data||{}; // sin expansi√≥n/traducci√≥n adicional en reintento para ahorrar
        renderAnswer(d2,text,langHint); saveSession(text,d2); setStatusText(`‚úî retry ¬∑ ${Math.round(performance.now()-t0)} ms`); return;
      }catch(e2){ handleAskError(e2,t0,mode,langHint); }
      return;
    }
    handleAskError(e1,t0,mode,langHint);
  }finally{
    isBusy=false; btnSend.disabled=false; btnCancel.disabled=true; btnSend.textContent="Enviar"; currentAbortCtrl=null; jobPollAbort=false;
  }
}

function handleAskError(err,t0,mode,langHint){
  const dt=Math.round(performance.now()-t0); try{ TTS.stopAll(); }catch{}
  const msg=String(err||""); const isAbort=(err?.name==="AbortError");
  const looksTimeout=isAbort||/network\s?timeout|timed\s?out|user aborted request/i.test(msg);
  let friendly;
  if(currentAbortCtrl?.signal?.aborted && !looksTimeout) friendly=langHint==="en"?"Canceled by user":"Cancelado por el usuario";
  else if(looksTimeout) friendly=langHint==="en"?"Timeout: browser/proxy cut the connection.":"Tiempo de espera agotado: el navegador/proxy cort√≥ la conexi√≥n.";
  else if(/Failed to fetch/i.test(msg)) friendly=langHint==="en"?"Connection interrupted":"Conexi√≥n interrumpida";
  else friendly=msg;
  out.innerHTML=`<pre style="color:var(--err)">Error: ${esc(friendly)}\n(${dt} ms)</pre>`; saveSession(q.value.trim(),{}); setStatusText(`${friendly} ¬∑ ${dt} ms`);
}

/* ====== Exportar ====== */
function htmlToCSV(includeQuestion=true){
  const rows=[]; if(includeQuestion){ const pq=(document.querySelector("h3+ p")?.textContent||"").trim(); if(pq) rows.push(["PREGUNTA",pq]); }
  out.querySelectorAll("p").forEach(p=>{ const t=p.textContent.trim(); if(t) rows.push(["TEXTO",t]); });
  out.querySelectorAll("ol,ul").forEach(list=>{ const items=[...list.querySelectorAll("li")].map((li,i)=>`${i+1}. ${li.textContent.trim()}`); if(items.length){ rows.push(["LISTA",items.join(" \\ ")]); } });
  out.querySelectorAll("table").forEach(tbl=>{ const head=[...tbl.querySelectorAll("thead th")].map(th=>th.textContent.trim()); if(head.length) rows.push(["TABLA CABECERAS",...head]); const trs=[...tbl.querySelectorAll("tbody tr")]; trs.forEach((tr,ri)=>{ const cells=[...tr.querySelectorAll("td")].map(td=>td.textContent.trim()); rows.push([`FILA ${ri+1}`,...cells]); }); });
  return rows.map(r=>r.map(c=>{const v=String(c??""); return /[",\n]/.test(v)?`"${v.replace(/"/g,'""')}"`:v;}).join(",")).join("\n");
}
function download(filename,blob){ const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },500); }
function printHTML(html){ const iframe=document.createElement('iframe'); Object.assign(iframe.style,{position:'fixed',right:'0',bottom:'0',width:'0',height:'0',border:'0'}); document.body.appendChild(iframe); const idoc=(iframe.contentWindow||iframe.contentDocument); const d=idoc.document||idoc; d.open(); d.write(html); d.close(); setTimeout(()=>{ try{ (iframe.contentWindow||iframe).focus(); (iframe.contentWindow||iframe).print(); }catch{} },60); setTimeout(()=>{ try{ document.body.removeChild(iframe);}catch{} },30000); }

/* ====== Botones ====== */
btnSend.addEventListener("click", ask);
btnCancel.disabled=true;
btnCancel.addEventListener("click",()=>{ if(currentAbortCtrl) try{currentAbortCtrl.abort();}catch{} jobPollAbort=true; try{TTS.stopAll();}catch{} setStatusText("Cancelado"); });
btnDict.addEventListener("click", toggleDict);
btnToggleAV.addEventListener("click", ()=>{ if(!TTS.enabled){ TTS.enabled=true; TTS.loadFromOut(); TTS.start(TTS.i, TTS.lang); btnToggleAV.textContent="‚è∏ Silenciar voz"; return;} if(TTS.paused){ TTS.resume(); btnToggleAV.textContent="‚è∏ Silenciar voz"; } else if(TTS.speaking){ TTS.pause(); btnToggleAV.textContent="‚ñ∂ Reanudar voz"; } else { TTS.resume(); btnToggleAV.textContent="‚è∏ Silenciar voz"; } });
btnReplay.addEventListener("click", ()=>{ const lang=detectLang((document.querySelector("h3+ p")?.textContent||q.value||"").trim()); TTS.restartFromStart(lang); btnToggleAV.textContent="‚è∏ Silenciar voz"; });
btnClear.addEventListener("click", ()=>{ q.value=""; out.innerHTML=""; clearStatus(); TTS.stopAll(); });
btnNew.addEventListener("click", ()=>{ saveSession(q.value.trim()||"(sin pregunta)",{}); TTS.stopAll(); q.value=""; out.innerHTML=""; clearStatus(); });

q.addEventListener("keydown",(e)=>{ if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); if(!isBusy) ask(); } });

selExport.addEventListener("change", ()=>{ const v=selExport.value; selExport.value=""; if(!out.innerHTML.trim()){ alert("No hay contenido que exportar."); return; } const question=(document.querySelector("h3+ p")?.textContent||"").trim();
  if(v==="pdf"){ const html = `<!doctype html><html><head><meta charset="utf-8"><title>Lexium - Export PDF</title><style>body{font:16px/1.5 system-ui;margin:28px;color:#111} h3{margin-top:0} table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:6px}</style></head><body>${question?`<h3>Pregunta</h3><p>${esc(question)}</p>`:""}${out.innerHTML}</body></html>`; try{ printHTML(html);}catch{ const w=window.open("", "_blank","noopener,noreferrer"); if(w){ w.document.open(); w.document.write(html); w.document.close(); w.focus(); w.print(); } } return; }
  if(v==="csv"){ const csv=htmlToCSV(true); download("export.csv", new Blob([csv],{type:"text/csv;charset=utf-8"})); return; }
  if(v==="doc"){ const html = `<!doctype html><html><head><meta charset="utf-8"></head><body>${question?`<h3>Pregunta</h3><p>${esc(question)}</p>`:""}${out.innerHTML}</body></html>`; download("export.doc", new Blob([html],{type:"application/msword"})); return; }
});

/* ====== Errores JS ====== */
window.addEventListener("error",(e)=>{ const msg=(e?.error?.stack||e?.message||String(e)).slice(0,600); statusEl.innerHTML='<span class="loader" role="status" aria-busy="true"><span class="dot"></span><span class="dot"></span><span class="dot"></span>'+esc('JS error: '+msg)+'</span>'; },{once:false});
</script>
</body>
</html>

