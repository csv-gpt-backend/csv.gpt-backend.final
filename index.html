<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Asistente ¬∑ Lexium2</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --ink:#111; --muted:#6b7280;
      --line:#e5e7eb; --accent:#f7c948; --accent-ink:#3a2d00;
      --btn:#f3f4f6; --btn-ink:#111; --btn-line:#e5e7eb;
      --brand:#0f6fff;
    }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui}
    .shell{max-width:1200px;margin:0 auto;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center}
    .logo img{height:28px}
    .videoWrap{margin-top:12px;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    video{display:block;width:100%;height:auto}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px;border:1px solid var(--line);border-top:none;border-radius:0 0 10px 10px;background:#fafafa}
    .bar .sp{flex:1}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--btn);color:var(--btn-ink);border:1px solid var(--btn-line);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(0.97)}
    .btn-acc{background:var(--accent);color:var(--accent-ink);border-color:#dfb436}
    .btn-blue{background:var(--brand);color:#fff;border-color:#0b4ad6}
    .muted{color:var(--muted);font-size:12px}
    .askRow{margin-top:12px;display:flex;gap:10px}
    .askRow input{flex:1;padding:11px 12px;border:1px solid var(--line);border-radius:10px;font-size:15px}
    .respTitle{margin:16px 0 8px;font-weight:700}
    .out{display:grid;gap:12px;margin-bottom:24px}
    .card{border:1px solid var(--line);border-radius:10px;padding:12px;background:#fff}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{border:1px solid var(--line);padding:8px}
    .tbl th{background:#f8fafc;text-align:left}
    .small{font-size:12px}
    .right{margin-left:auto}
    .exportMenu{position:relative}
    .menu{position:absolute;right:0;top:38px;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08);display:none;min-width:140px}
    .menu button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;cursor:pointer}
    .menu button:hover{background:#f3f4f6}
    .camPreview{position:fixed;right:18px;bottom:18px;background:#000;border:2px solid #fff;border-radius:10px;overflow:hidden;display:none}
    .camPreview video{width:280px;height:auto;display:block}
    .help{margin-top:6px}
  </style>
</head>
<body>
<div class="shell">
  <!-- Barra superior -->
  <div class="top">
    <div class="logo">
      <!-- CAMBIA EL LOGO AQU√ç -->
      <img src="https://upload.wikimedia.org/wikipedia/commons/4/4f/Santillana_logo.svg" alt="Santillana"/>
    </div>
    <div class="muted small">Backend: <span id="apiHost"></span></div>
  </div>

  <!-- Video principal -->
  <div class="videoWrap">
    <!-- CAMBIA EL VIDEO AQU√ç (src y/o poster) -->
    <video id="mainVideo" controls playsinline
           poster="https://images.unsplash.com/photo-1524253482453-3fed8d2fe12b?q=80&w=1200"
           src="https://cdn.coverr.co/videos/coverr-woman-at-home-5864/1080p.mp4"></video>
    <div class="bar">
      <div class="controls">
        <button class="btn btn-blue" id="btnSend">Enviar</button>
        <button class="btn" id="btnDictar">üéôÔ∏è Dictar</button>
        <button class="btn btn-acc" id="btnAV">‚è∫Ô∏è Voz/Video</button>
        <button class="btn" id="btnTTS">üîà Reproducir voz</button>
        <button class="btn" id="btnClear">üßπ Limpiar</button>
        <button class="btn" id="btnNew">üÜï Nueva sesi√≥n</button>
        <div class="exportMenu">
          <button class="btn" id="btnExport">‚§ì Exportar‚Ä¶ ‚ñæ</button>
          <div class="menu" id="menuExport">
            <button data-x="txt">TXT (respuesta)</button>
            <button data-x="csv">CSV (√∫ltima tabla)</button>
          </div>
        </div>
      </div>
      <div class="sp"></div>
      <div id="status" class="muted small">Listo</div>
    </div>
  </div>

  <!-- Entrada de consulta -->
  <div class="askRow">
    <input id="ask" type="text" placeholder="Escribe tu pregunta (ej.: promedio de AUTOESTIMA por paralelo)‚Ä¶">
  </div>

  <!-- Ayuda -->
  <div class="help muted small">
    <b>Ayuda:</b> <a href="javascript:void(0)" onclick="preset('lista de estudiantes')">Enviar</a> analiza; 
    <a href="javascript:void(0)" onclick="toggleDictado()">Dictar</a> voz‚Üítexto; 
    <a href="javascript:void(0)" onclick="toggleAV()">Voz/Video</a> locuci√≥n y video; 
    <a href="javascript:void(0)" onclick="tts()">Reproducir voz</a> lee todo; 
    <a href="javascript:void(0)" onclick="clearAll()">Limpiar</a> borra; 
    <a href="javascript:void(0)" onclick="newSession()">Nueva sesi√≥n</a> reinicia; 
    <a href="javascript:void(0)" onclick="openExport()">Exportar‚Ä¶</a> descarga.
  </div>

  <!-- Respuesta -->
  <div class="respTitle">Respuesta (texto, listas y tablas)</div>
  <div id="out" class="out"></div>
</div>

<!-- Vista previa c√°mara/mic -->
<div class="camPreview" id="camBox"><video id="cam" muted autoplay playsinline></video></div>

<script>
  // ========= CONFIG =========
  const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app"; // Cambia si usas otra URL
  document.getElementById('apiHost').textContent = API_BASE.replace(/^https?:\/\//,'');

  // ========= Refs UI =========
  const $ask = document.getElementById('ask');
  const $out = document.getElementById('out');
  const $status = document.getElementById('status');
  const $btnSend = document.getElementById('btnSend');
  const $btnDictar = document.getElementById('btnDictar');
  const $btnAV = document.getElementById('btnAV');
  const $btnTTS = document.getElementById('btnTTS');
  const $btnClear = document.getElementById('btnClear');
  const $btnNew = document.getElementById('btnNew');
  const $btnExport = document.getElementById('btnExport');
  const $menuExport = document.getElementById('menuExport');
  const $mainVideo = document.getElementById('mainVideo');
  const $camBox = document.getElementById('camBox');
  const $cam = document.getElementById('cam');

  // ========= Estado =========
  let lastGeneral = "";
  let lastTable = null;
  let rec = null;         // SpeechRecognition
  let recOn = false;
  let mediaStream = null; // getUserMedia

  // ========= Helpers =========
  const esc = s => String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  function setStatus(t){ $status.textContent = t; }
  function addCard(html){ const d=document.createElement('div'); d.className='card'; d.innerHTML=html; $out.appendChild(d); }
  function clearAll(){ $out.innerHTML=''; $ask.value=''; lastGeneral=""; lastTable=null; setStatus('Listo'); }
  function newSession(){ clearAll(); speechSynthesis.cancel(); }
  function preset(q){ $ask.value=q; send(); }

  // ========= Backend =========
  async function send(){
    const q = $ask.value.trim();
    if(!q){ setStatus('Escribe una consulta‚Ä¶'); return; }
    setStatus('Consultando‚Ä¶');
    try{
      const res = await fetch(`${API_BASE}/api/answer?q=${encodeURIComponent(q)}`, {headers:{Accept:'application/json'}});
      const txt = await res.text();
      let data; try{ data = JSON.parse(txt); } catch{ data = { ok:true, general:txt, lists:[], tables:[] }; }
      render(data);
      setStatus('Listo');
    }catch(e){
      console.error(e);
      setStatus('Error de conexi√≥n');
    }
  }

  function render(data){
    $out.innerHTML='';
    if(data.general){
      lastGeneral = data.general;
      addCard(`<div>${esc(data.general)}</div>`);
    }else{ lastGeneral = ""; }

    (data.lists||[]).forEach(lst=>{
      addCard(`<div style="font-weight:700;margin-bottom:6px">${esc(lst.title||'Lista')}</div>
               <ul>${lst.items.map(i=>`<li>${esc(i)}</li>`).join('')}</ul>`);
    });

    lastTable = null;
    (data.tables||[]).forEach(tbl=>{
      lastTable = tbl; // guarda la √∫ltima
      const thead = `<tr>${tbl.columns.map(c=>`<th>${esc(c)}</th>`).join('')}</tr>`;
      const tbody = (tbl.rows||[]).map(r=>`<tr>${r.map(c=>`<td>${esc(c)}</td>`).join('')}</tr>`).join('');
      addCard(`${tbl.title?`<div style="font-weight:700;margin-bottom:6px">${esc(tbl.title)}</div>`:''}
              <div class="small muted">Filas: ${(tbl.rows||[]).length}</div>
              <table class="tbl"><thead>${thead}</thead><tbody>${tbody}</tbody></table>`);
    });
  }

  // ========= Dictado (Web Speech API) =========
  function toggleDictado(){
    try{
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ alert('Este navegador no soporta reconocimiento de voz.'); return; }
      if(recOn){ rec.stop(); return; }
      rec = new SR(); rec.lang='es-ES'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult = e => {
        const t = e.results[0][0].transcript;
        $ask.value = ($ask.value? $ask.value+' ' : '') + t;
      };
      rec.onend = () => { recOn=false; $btnDictar.textContent='üéôÔ∏è Dictar'; setStatus('Dictado detenido'); };
      rec.onerror = () => { recOn=false; $btnDictar.textContent='üéôÔ∏è Dictar'; setStatus('Error dictado'); };
      rec.start(); recOn=true; $btnDictar.textContent='‚èπÔ∏è Detener dictado'; setStatus('Dictando‚Ä¶');
    }catch(e){ console.error(e); alert('No se pudo iniciar el dictado.'); }
  }

  // ========= Voz/Video (getUserMedia) =========
  async function toggleAV(){
    if(mediaStream){
      mediaStream.getTracks().forEach(t=>t.stop());
      mediaStream = null; $camBox.style.display='none';
      $btnAV.textContent='‚è∫Ô∏è Voz/Video'; setStatus('Voz/Video apagado'); return;
    }
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({audio:true, video:true});
      $cam.srcObject = mediaStream; $camBox.style.display='block';
      $btnAV.textContent='‚èπÔ∏è Detener Voz/Video'; setStatus('Voz/Video encendido');
    }catch(e){ console.error(e); alert('Permite acceso al micr√≥fono/c√°mara para usar Voz/Video.'); }
  }

  // ========= Texto a voz (Speech Synthesis) =========
  function tts(){
    if(!lastGeneral){ setStatus('No hay texto para leer'); return; }
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(lastGeneral);
    u.lang = 'es-ES'; u.rate=1; u.pitch=1; u.onend=()=>setStatus('Listo');
    speechSynthesis.speak(u); setStatus('Leyendo respuesta‚Ä¶');
  }

  // ========= Exportar =========
  function openExport(){ $menuExport.style.display = ($menuExport.style.display==='block'?'none':'block'); }
  function closeExport(){ $menuExport.style.display='none'; }
  function exportTXT(){
    const blob = new Blob([(lastGeneral||'')], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='respuesta.txt'; a.click();
  }
  function exportCSV(){
    if(!lastTable){ alert('No hay tabla disponible.'); return; }
    const rows = [lastTable.columns, ...(lastTable.rows||[])];
    const csv = rows.map(r => r.map(x => {
      const s = String(x??''); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download=(lastTable.title||'tabla')+'.csv'; a.click();
  }

  // ========= Wire-up =========
  $btnSend.onclick = send;
  $btnDictar.onclick = toggleDictado;
  $btnAV.onclick = toggleAV;
  $btnTTS.onclick = tts;
  $btnClear.onclick = clearAll;
  $btnNew.onclick = newSession;
  $btnExport.onclick = openExport;
  $menuExport.addEventListener('click', e=>{
    const t = e.target.closest('button'); if(!t) return;
    if(t.dataset.x==='txt') exportTXT();
    if(t.dataset.x==='csv') exportCSV();
    closeExport();
  });
  document.addEventListener('click', e=>{
    if(!e.target.closest('.exportMenu')) closeExport();
  });

  // Enter para enviar
  $ask.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

  // Presets r√°pidos v√≠a click en ayuda
  window.preset = preset;
  window.toggleDictado = toggleDictado;
  window.toggleAV = toggleAV;
  window.tts = tts;
  window.clearAll = clearAll;
  window.newSession = newSession;
  window.openExport = openExport;
</script>
</body>
</html>
