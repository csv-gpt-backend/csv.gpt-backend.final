<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LUN 1036Asistente Lexium</title>
<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#6b7280; --pri:#0d6efd; --bd:#e5e7eb;
    --ok:#16a34a; --err:#b91c1c;
    --heroH: 65vh;
    --wrapW: 1180px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;}

  .mediaBar{position:fixed; top:0; left:0; width:100vw; z-index:50; background:#fff;}
  .mediaInner{max-width:var(--wrapW); margin:0 auto; padding:12px;}
  .heroGrid{display:grid; grid-template-columns:1fr 3fr 1.16fr; align-items:center; gap:8px;}
  .sideImg{display:flex; justify-content:center; height:var(--heroH); margin:0;}
  .sideImg img{max-width:100%; height:100%; object-fit:contain; opacity:.95}
  .videoBox{height:var(--heroH); margin:0;}
  .videoBox video{width:100%; height:100%; object-fit:cover; border:none; display:block; border-radius:10px}

  .contentWrap{max-width:var(--wrapW); margin:0 auto; padding:12px; padding-top:calc(var(--heroH) + 8px);}

  .toolbar{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:8px 0}
  .toolbar button, .toolbar select{padding:9px 14px; border:1px solid var(--bd); border-radius:10px; background:#fff; cursor:pointer;}
  .toolbar button:hover{background:#f5f7fb}
  .toolbar button[disabled]{opacity:.6; cursor:not-allowed}

  .hist{position:fixed; right:14px; top:10px; z-index:60}
  .hist button{padding:8px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff}

  .query{width:100%; height:48px; min-height:48px; max-height:48px; resize:none; border:1px solid var(--bd); border-radius:10px; padding:10px; font-size:16px; line-height:1.4;}
  .out{margin:8px 0; border:1px solid var(--bd); border-radius:12px; padding:12px; overflow:auto; white-space:pre-wrap; max-height:65vh;}
  .muted{color:var(--muted); font-size:.9rem}

  table{width:100%; border-collapse:collapse; margin:10px 0}
  th,td{border:1px solid var(--bd); padding:8px}
  th{background:#f8fafc; text-align:left}

  .loader{display:inline-flex; align-items:center; gap:8px; font-size:.95rem; color:var(--muted)}
  .dot{width:8px; height:8px; border-radius:50%; background:var(--pri); opacity:.7; animation:bounce 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}
  .dot:nth-child(3){animation-delay:.3s}
  @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
</style>
</head>
<body>

  <div class="hist">
    <button id="btnHist" title="Ver sesiones guardadas">Historial</button>
  </div>

  <div class="mediaBar" aria-label="cabecera">
    <div class="mediaInner">
      <div class="heroGrid">
        <div class="sideImg left">
          <img src="left.png" alt="Logo izquierdo"/>
        </div>
        <div class="videoBox">
          <video id="vid" preload="auto" muted playsinline src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"></video>
        </div>
        <div class="sideImg right">
          <img src="right.png" alt="Logo derecho"/>
        </div>
      </div>
    </div>
  </div>

  <div class="contentWrap">
    <div style="margin:10px 0 6px">
      <textarea id="q" class="query" rows="2" placeholder="ESCRIBE O HABLA PARA PREGUNTAR‚Ä¶ (Ctrl/Cmd+Enter = enviar)"></textarea>
    </div>

    <div class="toolbar">
      <button id="btnSend" title="Enviar consulta al backend">Enviar</button>
      <button id="btnCancel" title="Cancelar consulta en curso">‚úñ Cancelar</button>
      <button id="btnDict" title="Dictar por voz (empieza / detiene)">üé§ Dictar</button>
      <button id="btnToggleAV" title="Parar/Activar voz">‚èØ Activar voz</button>
      <button id="btnReplay" title="Reproducir nuevamente la voz desde el principio">‚ü≥ Reproducir</button>
      <button id="btnNew" title="Nueva sesi√≥n (limpia y guarda la actual)">Ôºã Nueva sesi√≥n</button>
      <button id="btnClear" title="Limpiar pregunta y respuesta">üßπ Limpiar</button>
      <select id="selExport" title="Exportar lo generado (PDF muestra vista previa)">
        <option value="">Exportar‚Ä¶</option>
        <option value="pdf">PDF (vista previa)</option>
        <option value="csv">CSV</option>
        <option value="doc">DOC</option>
      </select>
    </div>

    <div id="out" class="out" aria-live="polite"></div>
    <div id="status" class="muted"></div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://lexium-gpt5-383217514425.southamerica-west1.run.app";
const GPT_PATH = "/api/gpt";
const FALLBACK_PATH = "/api/answer";

/* ====== Estado ====== */
let isBusy = false;
let currentAbortCtrl = null;

/* ====== UI refs ====== */
const q = document.getElementById("q");
const out = document.getElementById("out");
const statusEl = document.getElementById("status");
const vid = document.getElementById("vid");
const btnSend = document.getElementById("btnSend");
const btnCancel = document.getElementById("btnCancel");
const btnDict = document.getElementById("btnDict");
const btnToggleAV = document.getElementById("btnToggleAV");
const btnReplay = document.getElementById("btnReplay");
const btnNew = document.getElementById("btnNew");
const btnClear = document.getElementById("btnClear");
const selExport = document.getElementById("selExport");
const btnHist = document.getElementById("btnHist");

/* ====== Utils ====== */
function esc(x){ return String(x).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }
function setStatusLoading(msg="Consultando‚Ä¶"){
  statusEl.innerHTML = `<span class="loader" role="status" aria-live="polite" aria-busy="true">
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>${esc(msg)}</span>`;
}
function clearStatus(){ statusEl.textContent = ""; }

/* ====== Detect idioma agresivo ====== */
function detectLang(text){
  const t=(text||"").trim().toLowerCase();
  if(!t) return "es";
  const enHits=(t.match(/\b(the|and|you|your|please|could|would|with|from|to|of|in|on|are|is|can|help|explain|summary|benefits)\b/g)||[]).length;
  const esHits=(t.match(/\b(el|la|de|y|que|para|con|desde|a|en|son|es|por favor|podr√≠a|ser√≠a|ayuda|explica|resumen|beneficios)\b/g)||[]).length;
  if(enHits > esHits*1.2) return "en";
  if(esHits > enHits*1.2) return "es";
  return "es"; // por defecto
}

/* ====== HISTORIAL ====== */
const SESS_KEY="lexium_sessions_v5";
function saveSession(question, data){
  const html=(document.getElementById('out')?.innerHTML||"").trim();
  const text=(document.getElementById('out')?.textContent||"").trim();
  const entry={id:new Date().toISOString(),question:question||"(sin pregunta)",html,text,when:Date.now()};
  try{
    const all=JSON.parse(localStorage.getItem(SESS_KEY)||"[]");
    all.unshift(entry); localStorage.setItem(SESS_KEY, JSON.stringify(all.slice(0,100)));
  }catch(_){}
}
function readSessions(){
  try{ return JSON.parse(localStorage.getItem(SESS_KEY)||"[]"); }catch(_){ return []; }
}
function openHistory(){
  const all=readSessions();
  if(!all.length){ alert("Sin historial."); return; }
  const w=window.open("", "_blank", "noopener,noreferrer");
  if(!w){ alert("El navegador bloque√≥ la ventana. Habilita pop-ups para este sitio."); return; }
  const rows = all.map((s,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${esc(new Date(s.when).toLocaleString())}</td>
      <td>${esc(s.question)}</td>
      <td><button data-id="${esc(s.id)}" class="viewBtn">Ver</button></td>
    </tr>
  `).join("");
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Historial</title>
    <style>
      body{font:14px system-ui;margin:16px;color:#111}
      table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:6px;text-align:left}
      th{background:#f8fafc}
      #viewer{border:1px solid #ddd;margin-top:12px;padding:10px;border-radius:8px;max-height:65vh;overflow:auto;}
      .topbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
      .closeBtn{border:1px solid #ddd;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
      .muted{color:#6b7280}
      .viewBtn{padding:4px 10px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
    </style>
  </head><body>
    <div class="topbar">
      <button class="closeBtn" onclick="window.close()">‚ùå Cerrar</button>
      <div class="muted">Haz clic en ‚ÄúVer‚Äù para abrir una sesi√≥n</div>
    </div>
    <table>
      <thead><tr><th>#</th><th>Fecha</th><th>Pregunta</th><th>Acci√≥n</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <h3>Vista previa</h3>
    <div id="viewer" class="muted">Sin selecci√≥n.</div>
    <script>
      const data = ${JSON.stringify(all)};
      const viewer = document.getElementById('viewer');
      document.body.addEventListener('click', (e)=>{
        const btn = e.target.closest('.viewBtn');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const s = data.find(x=>x.id===id);
        if(!s){ viewer.textContent='No encontrado'; return; }
        viewer.innerHTML = '<h4>Pregunta</h4><p>'+escapeHtml(s.question)+'</p>' + (s.html||'<em>Vac√≠o</em>');
        viewer.scrollTop = 0;
      });
      function escapeHtml(x){ return String(x).replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }
    <\/script>
  </body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
}
btnHist.addEventListener("click", openHistory);

/* ====== Dictado ====== */
let recognizer=null;
function toggleDict(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert("Dictado no soportado en este navegador."); return; }
  if(!recognizer){
    recognizer=new SR(); recognizer.lang="es-ES"; recognizer.continuous=false; recognizer.interimResults=false;
    recognizer.onresult=e=>{
      const t=Array.from(e.results).map(r=>r[0].transcript).join(" ");
      q.value=(q.value? q.value+" " : "") + t;
    };
  }
  if(recognizer.listening){ recognizer.stop(); recognizer.listening=false; btnDict.textContent="üé§ Dictar";}
  else { recognizer.start(); recognizer.listening=true; btnDict.textContent="‚èπ Detener dictado";}
}
btnDict.addEventListener("click", toggleDict);

/* ====== TTS + Video ====== */
const PREFERRED_ES = ["Microsoft Sabina","Microsoft Helena","Microsoft Laura","Microsoft Maria","Microsoft Lucia","Monica","Paulina","Camila","Sofia","Elena","Lucia","Maria","Carla","Google espa√±ol","Google US Espa√±ol"];
const PREFERRED_EN = ["Microsoft Jenny","Microsoft Aria","Microsoft Zira","Microsoft Sara","Google US English"];
function pickVoice(lang){
  const vs = speechSynthesis.getVoices()||[];
  const prefs = lang==="en" ? PREFERRED_EN : PREFERRED_ES;
  for(const name of prefs){
    const v = vs.find(x => (x.name||"").toLowerCase().includes(name.toLowerCase()));
    if(v) return v;
  }
  const byLang = vs.find(v => (v.lang||"").toLowerCase().startsWith(lang==="en"?"en":"es"));
  return byLang || vs[0] || null;
}
function waitForVoices(){
  return new Promise((resolve)=>{
    let tries=0;
    function check(){
      const vs=speechSynthesis.getVoices();
      if(vs && vs.length){ resolve(); }
      else if(++tries>50){ resolve(); } // ~5s m√°x
      else setTimeout(check,100);
    }
    check();
  });
}
const TTS={
  enabled:true, chunks:[], i:0, utter:null, paused:false, speaking:false, textCache:"", voice:null, lang:"es",
  makeChunks(text,maxLen=360){
    const res=[]; const parts=String(text).split(/(\.|\?|!|\n)/);
    let buf=""; for(let i=0;i<parts.length;i+=2){ const seg=(parts[i]||"")+(parts[i+1]||"");
      if((buf+seg).length<=maxLen) buf+=seg; else{ if(buf.trim()) res.push(buf.trim()); buf=seg; } }
    if(buf.trim()) res.push(buf.trim()); return res;
  },
  async ensureVoice(){
    await waitForVoices();
    this.voice = pickVoice(this.lang) || null;
  },
  buildTTSTextFromOut(){
    const c=document.createElement("div"); c.innerHTML=out.innerHTML;
    const parts=[];
    // t√≠tulos y p√°rrafos
    c.querySelectorAll("h1,h2,h3,h4,p").forEach(node=>{
      const t=(node.textContent||"").trim();
      if(t) parts.push(t);
    });
    // listas: evitar doble numeraci√≥n
    c.querySelectorAll("ol,ul").forEach(list=>{
      const items=[...list.querySelectorAll("li")].map(li=>(li.textContent||"").trim()).filter(Boolean);
      if(items.length){
        const spoken = items.map((t,i)=>{
          if(/^\d+\.\s/.test(t)) return t;      // ya viene numerado ‚Üí no duplicar
          return `${i+1}. ${t}`;
        }).join("\n");
        parts.push(spoken);
      }
    });
    // tablas: leer cabeceras y filas (con n√∫meros)
    c.querySelectorAll("table").forEach(tbl=>{
      const headers=[...tbl.querySelectorAll("thead th")].map(th=>(th.textContent||"").trim()).filter(Boolean);
      if(headers.length) parts.push(`Tabla: ${headers.join(", ")}`);
      const rows=[...tbl.querySelectorAll("tbody tr")];
      rows.forEach((tr,ri)=>{
        const cells=[...tr.querySelectorAll("td")].map(td=>(td.textContent||"").trim());
        if(cells.length) parts.push(`${ri+1}. ${cells.join(" | ")}`);
      });
    });
    const fallback=(out.textContent||"").trim();
    this.textCache = (parts.join("\n\n") || fallback).replace(/\s+/g,' ').trim();
    this.chunks = this.makeChunks(this.textCache);
    this.i = 0;
  },
  async start(fromIndex=0){
    if(typeof speechSynthesis==="undefined") return;
    this.enabled = true;
    await this.ensureVoice();        // ‚Üê garantiza que arrancamos con la voz correcta (evita voz de hombre ‚Üí mujer)
    if(!this.chunks.length) this.buildTTSTextFromOut();
    if(fromIndex>=0) this.i=fromIndex;
    speechSynthesis.cancel();
    this.speakNext();
  },
  speakNext(){
    if(!this.enabled || this.i>=this.chunks.length){ this.finish(); return; }
    const u=new SpeechSynthesisUtterance(this.chunks[this.i++]);
    if(this.voice) u.voice=this.voice;
    u.lang = this.voice?.lang || (this.lang==="en"?"en-US":"es-ES");
    u.rate=0.98; u.pitch=1.05; u.volume=1;
    u.onstart=()=>{ this.speaking=true; this.paused=false; if(vid){ vid.loop=true; vid.play().catch(()=>{});} };
    u.onend =()=>{ this.speakNext(); };
    u.onerror=()=>{ this.speakNext(); };
    this.utter=u; speechSynthesis.speak(u);
  },
  pause(){ if(this.speaking && !this.paused){ speechSynthesis.pause(); this.paused=true; if(vid) vid.pause(); } },
  resume(){ if(this.paused){ speechSynthesis.resume(); this.paused=false; if(vid) vid.play().catch(()=>{}); }
           else if(!this.speaking && this.enabled){ this.speakNext(); } },
  async restartFromStart(){ this.enabled=true; this.buildTTSTextFromOut(); await this.start(0); },
  finish(){ this.speaking=false; this.paused=false; this.utter=null; if(vid){ vid.loop=false; vid.pause(); } },
  stopAll(){ this.enabled=false; this.paused=false; this.speaking=false; this.utter=null;
             if(typeof speechSynthesis!=="undefined") speechSynthesis.cancel();
             if(vid){ vid.loop=false; vid.pause(); } }
};
btnToggleAV.addEventListener("click", ()=>{
  if(!TTS.enabled){ TTS.enabled=true; TTS.restartFromStart(); btnToggleAV.textContent="‚è∏ Silenciar voz"; return; }
  if(TTS.paused){ TTS.resume(); btnToggleAV.textContent="‚è∏ Silenciar voz"; }
  else if(TTS.speaking){ TTS.pause(); btnToggleAV.textContent="‚ñ∂ Reanudar voz"; }
  else { TTS.resume(); btnToggleAV.textContent="‚è∏ Silenciar voz"; }
});
btnReplay.addEventListener("click", ()=>{ TTS.restartFromStart(); btnToggleAV.textContent="‚è∏ Silenciar voz"; });

/* ====== Render ====== */
function generalToOrderedListHTML(g){
  if (!g) return "";
  const lines = g.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const bulletRe = /^(?:[‚Ä¢\-‚Äì*]|\d+\.)\s+/u;
  const hasBullets = lines.filter(s=>bulletRe.test(s)).length>0;
  const manyPlain = lines.filter(s=>!/[.!?;:]\s*$/.test(s) && s.length<=80).length >= Math.ceil(lines.length*0.6);
  if (lines.length>=3 && (hasBullets || manyPlain)) {
    const items = lines.map(s=>s.replace(bulletRe,"")).filter(Boolean);
    return `<ol>${items.map(it=>`<li>${esc(it)}</li>`).join("")}</ol>`;
  }
  return `<p>${esc(g).replace(/\n/g,"<br>")}</p>`;
}
function stripDisclaimers(html){
  return html.replace(/no constituye un diagn√≥stico (cl√≠nico|psicol√≥gico)[^.<]*[.\n]?/gi, "");
}
function renderAnswer(data, langHint){
  let html="";
  const generalTxt = data.general || data.answer || data.text || "";
  if(generalTxt){ html += generalToOrderedListHTML(generalTxt); }

  (data.lists||[]).forEach((l,i)=>{
    const title = l.title || `Lista ${i+1}`;
    const items = Array.isArray(l.items) ? l.items : (Array.isArray(l) ? l : []);
    if(items && items.length){
      html += `<h3>${esc(title)}</h3><ol>${items.map(it=>`<li>${esc(String(it))}</li>`).join("")}</ol>`;
    }
  });

  (data.tables||[]).forEach(t=>{
    const cols=t.columns||[]; const rows=t.rows||[];
    html += `<h3>${esc(t.title||"Tabla")}</h3><table><thead><tr>`;
    html += cols.map(c=>`<th>${esc(c)}</th>`).join("");
    html += `</tr></thead><tbody>`;
    rows.forEach(r=>{ html += `<tr>` + r.map(x=>`<td>${esc(x)}</td>`).join("") + `</tr>`; });
    html += `</tbody></table>`;
  });

  // Limpia disclaimers
  html = stripDisclaimers(html);

  out.innerHTML = html || "<em>Sin contenido.</em>";

  // TTS con idioma correcto
  TTS.lang = (langHint==="en" ? "en" : "es");
  TTS.restartFromStart();
}

/* ====== Backend ====== */
function detectTextLang(s){
  const t=(s||"").toLowerCase();
  if(!t.trim()) return "unknown";
  const enHits=(t.match(/\b(the|and|with|from|to|of|in|on|are|is|can|please|could|would|analysis|summary|result|average|benefits)\b/g)||[]).length;
  const esHits=(t.match(/\b(el|la|de|y|que|para|con|desde|a|en|son|es|por|promedio|beneficios|resultado|an√°lisis|resumen)\b/g)||[]).length;
  if(enHits>esHits) return "en"; if(esHits>enHits) return "es";
  const nonASCII=(t.match(/[√°√©√≠√≥√∫√±√º]/g)||[]).length; if(nonASCII>0) return "es";
  return "en";
}

async function ask(){
  const text=q.value.trim(); if(!text || isBusy) return;
  isBusy = true;
  btnSend.disabled = true;
  btnCancel.disabled = false;
  const prev = btnSend.textContent;
  btnSend.textContent = "Enviando‚Ä¶";
  setStatusLoading("Consultando‚Ä¶");

  // cancelar petici√≥n anterior si la hubiera
  if(currentAbortCtrl){ try{ currentAbortCtrl.abort(); }catch{} }
  currentAbortCtrl = new AbortController();

  const langHint = detectLang(text); // "es" | "en"
  const headers = {
    "Content-Type":"application/json",
    "Accept":"application/json",
    "Accept-Language": langHint==="en" ? "en-US,en;q=0.9" : "es-ES,es;q=0.9",
    "Prefer": `respond-language=${langHint}`
  };

  try{
    let r = await fetch(`${API_BASE}${GPT_PATH}`, {
      method:"POST", headers, body: JSON.stringify({ q: text }),
      signal: currentAbortCtrl.signal
    });
    if(r.status===404 || r.status===405){
      r = await fetch(`${API_BASE}${FALLBACK_PATH}?q=${encodeURIComponent(text)}`, { headers:{ "Accept":"application/json" }, signal: currentAbortCtrl.signal });
    }
    const data = await r.json().catch(()=>({}));
    if(!r.ok || data.ok===false) throw new Error(data.error || data.general || `HTTP ${r.status}`);

    // Si mezcl√≥ idiomas, intento ‚Äúforzar‚Äù: si langHint es EN y detecto ES, muestro igual pero TTS en EN
    const rawTxt = (data.general || data.answer || data.text || "");
    const outLang = detectTextLang(rawTxt);
    renderAnswer(data, outLang || langHint);

    // Guarda historial
    saveSession(text, data);
  }catch(e){
    out.innerHTML = `<pre style="color:var(--err)">${esc(String(e))}</pre>`;
  }finally{
    isBusy = false;
    btnSend.disabled = false;
    btnCancel.disabled = true;
    btnSend.textContent = prev;
    clearStatus();
    currentAbortCtrl = null;
  }
}

/* ====== Cancelar ====== */
btnCancel.disabled = true;
btnCancel.addEventListener("click", ()=>{
  try{ currentAbortCtrl?.abort(); }catch{}
  TTS.stopAll();
  clearStatus();
  statusEl.textContent = "Cancelado";
});

/* ====== Exportar ====== */
function htmlToCSV(includeQuestion=true){
  const rows=[];
  if(includeQuestion){
    const pq=(document.querySelector("h3+ p")?.textContent || "").trim();
    const fromHist = (document.querySelector(".questionHeader")?.textContent || "");
    const qText = pq || fromHist || (document.querySelector("#q")?.value || "");
    if(qText) rows.push(["PREGUNTA", qText]);
  }
  out.querySelectorAll("p").forEach(p=>{ const t=p.textContent.trim(); if(t) rows.push(["TEXTO", t]); });
  out.querySelectorAll("ol,ul").forEach(list=>{
    const items=[...list.querySelectorAll("li")].map((li,i)=>`${i+1}. ${li.textContent.trim()}`);
    if(items.length) rows.push(["LISTA", items.join(" \\ ")]);
  });
  out.querySelectorAll("table").forEach(tbl=>{
    const head=[...tbl.querySelectorAll("thead th")].map(th=>th.textContent.trim());
    if(head.length) rows.push(["TABLA CABECERAS", ...head]);
    const trs=[...tbl.querySelectorAll("tbody tr")];
    trs.forEach((tr,ri)=>{
      const cells=[...tr.querySelectorAll("td")].map(td=>td.textContent.trim());
      rows.push([`FILA ${ri+1}`, ...cells]);
    });
  });
  return rows.map(r => r.map(cell=>{
    const v=String(cell??"");
    if (/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
    return v;
  }).join(",")).join("\n");
}
function download(filename, blob){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}
function printHTML(html){
  const iframe=document.createElement('iframe');
  iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
  iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
  document.body.appendChild(iframe);
  const doc=iframe.contentWindow||iframe.contentDocument;
  const idoc=doc.document||doc;
  idoc.open(); idoc.write(html); idoc.close();
  setTimeout(()=>{ try{ (iframe.contentWindow||iframe).focus(); (iframe.contentWindow||iframe).print(); }catch{} }, 60);
  setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch{} }, 30000);
}
selExport.addEventListener("change", ()=>{
  const v=selExport.value; selExport.value="";
  if(!out.innerHTML.trim()){ alert("No hay contenido que exportar."); return; }
  const questionText=(q.value||"").trim();
  if(v==="pdf"){
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Lexium - Export PDF</title>
      <style>body{font:16px/1.5 system-ui;margin:28px;color:#111}
             h3{margin-top:0}
             table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:6px}</style>
      </head><body>
      ${questionText ? `<h3>Pregunta</h3><p>${esc(questionText)}</p>` : ""}
      ${out.innerHTML}
      </body></html>`;
    try{ printHTML(html); }catch(_){
      const w=window.open("", "_blank", "noopener,noreferrer");
      if(w){ w.document.open(); w.document.write(html); w.document.close(); w.focus(); w.print(); }
    }
    return;
  }
  if(v==="csv"){
    const csv=htmlToCSV(true);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    download("lexium_export.csv", blob);
    return;
  }
  if(v==="doc"){
    const html = `<!doctype html><html><head><meta charset="utf-8"></head><body>
      ${questionText ? `<h3>Pregunta</h3><p>${esc(questionText)}</p>` : ""}
      ${out.innerHTML}
    </body></html>`;
    const blob=new Blob([html],{type:"application/msword"});
    download("lexium_export.doc", blob);
    return;
  }
});

/* ====== Botones ====== */
btnSend.addEventListener("click", ask);
q.addEventListener("keydown",(e)=>{ if ((e.ctrlKey||e.metaKey) && e.key==="Enter") ask(); });
btnClear.addEventListener("click", ()=>{ q.value=""; out.innerHTML=""; clearStatus(); TTS.stopAll(); });
btnNew.addEventListener("click", ()=>{ saveSession(q.value.trim()||"(sin pregunta)", {}); TTS.stopAll(); q.value=""; out.innerHTML=""; clearStatus(); });

/* Mostrar errores JS */
window.addEventListener("error",(e)=>{
  const msg=(e?.error?.stack||e?.message||String(e)).slice(0,600);
  statusEl.innerHTML = '<span class="loader" role="status" aria-busy="true">'
    + '<span class="dot"></span><span class="dot"></span><span class="dot"></span>'
    + 'JS error: '+esc(msg) + '</span>';
},{once:false});
</script>
</body>
</html>
