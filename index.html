<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MMMMLexium ‚Äî Consulta</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111832; --muted:#94a3b8;
      --text:#e5e7eb; --accent:#60a5fa; --ok:#34d399; --warn:#f59e0b;
      --danger:#ef4444; --chip:#1f2a4a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#0a0f1e 0%, #0e1630 100%);
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
    .header{display:flex; align-items:center; gap:12px; margin-bottom:14px}
    .logo{width:36px; height:36px; border-radius:10px; background:#1a2547; display:grid; place-items:center; font-weight:700; color:#93c5fd}
    h1{font-size:18px; margin:0}
    .bar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0}
    .chip{
      background:var(--chip); color:#cbd5e1; border:1px solid #223055;
      padding:6px 10px; border-radius:999px; font-size:12px; display:flex; align-items:center; gap:6px;
    }
    .chip b{color:#e2e8f0}
    .card{
      background:rgba(17,24,50,.7); border:1px solid #243152;
      border-radius:16px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,.35);
    }
    .row{display:grid; grid-template-columns:1.3fr .7fr; gap:14px}
    @media (max-width:900px){ .row{grid-template-columns:1fr} }

    textarea, input[type="text"]{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid #2a3a63;
      background:#0e1530; color:var(--text); outline:none; font-size:15px;
    }
    textarea{min-height:84px; resize:vertical}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid #2a3a63; background:#13204a; color:#e5e7eb;
      padding:10px 12px; border-radius:12px; font-weight:600; cursor:pointer
    }
    button:hover{filter:brightness(1.05)}
    button.ghost{background:#0e1530}
    button.primary{background:#1b3a7a; border-color:#3959a2}
    button.danger{background:#3a1620; border-color:#5a2430}
    .status{display:flex; gap:8px; align-items:center; margin-top:8px; font-size:12px; color:var(--muted)}
    .answer{
      white-space:pre-wrap; line-height:1.45; font-size:15px;
      min-height:130px; max-height:360px; overflow:auto; padding:12px;
      border-radius:12px; border:1px solid #243152; background:#0d142e;
    }
    .panel{
      display:flex; flex-direction:column; gap:8px;
    }
    .small{font-size:12px; color:#9fb1d1}
    .hint{font-size:12px; color:#8aa0c8; margin-top:-2px}
    .split{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    @media (max-width:640px){ .split{grid-template-columns:1fr} }
    .video-wrap{background:#0d142e; border:1px solid #243152; border-radius:12px; padding:8px}
    video{width:100%; border-radius:8px; display:block}
    select{
      background:#0e1530; border:1px solid #2a3a63; color:var(--text);
      padding:8px 10px; border-radius:10px; font-size:14px; width:100%;
    }
    .spinner{display:none; width:16px; height:16px; border:2px solid #3a4f86; border-top-color:#90b4ff; border-radius:50%; animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">Lx</div>
      <h1>Lexium ‚Äî Consultas</h1>
    </div>

    <div class="bar">
      <div class="chip">Ruta: <b id="badge-ruta">‚Äî</b></div>
      <div class="chip">Tiempo: <b id="badge-tiempo">‚Äî</b></div>
      <div class="chip">Voz: <b id="badge-voz">Silencio</b></div>
      <div class="chip">Mic: <b id="badge-mic">Off</b></div>
    </div>

    <div class="row">
      <!-- Columna izquierda: interacci√≥n -->
      <div class="card">
        <div class="panel">
          <label class="small">Escribe tu pregunta</label>
          <textarea id="q" placeholder="Ej.: ¬øQu√© es Lexium? o ¬øC√≥mo se aplica la evaluaci√≥n emocional?"></textarea>
          <div class="hint">Enter = Enviar. Shift+Enter = salto de l√≠nea.</div>

          <div class="actions">
            <button class="primary" id="btn-enviar">Enviar</button>
            <button id="btn-mic">üé§ Dictar</button>
            <button id="btn-voz">‚èØ Voz</button>
            <button id="btn-replay">‚ü≥ Reproducir nuevamente</button>
            <button class="ghost" id="btn-new">Ôºã Nueva sesi√≥n</button>
            <button class="ghost" id="btn-clear">üßπ Limpiar</button>
            <button class="ghost" id="btn-export">Exportar‚Ä¶</button>
            <div class="spinner" id="spinner"></div>
          </div>

          <div class="split">
            <div>
              <label class="small">Selecciona voz (nativo del navegador)</label>
              <select id="voice-select"></select>
            </div>
            <div>
              <label class="small">Volumen</label>
              <input id="voice-volume" type="range" min="0" max="1" step="0.05" value="1" style="width:100%">
            </div>
          </div>
        </div>
      </div>

      <!-- Columna derecha: video / salida -->
      <div class="card">
        <div class="panel">
          <label class="small">Respuesta</label>
          <div id="answer" class="answer"></div>

          <div class="video-wrap">
            <label class="small">Video (opcional)</label>
            <video id="video" src="" controls preload="metadata" playsinline></video>
            <div class="actions">
              <button id="btn-video-toggle">‚èØ Parar/Activar video</button>
              <input id="video-src" type="text" placeholder="Pega la URL/archivo del video (opcional)">
            </div>
          </div>

          <div class="status mono" id="status-line">Listo.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======== Config ========
    const API_BASE = ""; // vac√≠o = mismo origen. Si usas Cloud Run con dominio, pega aqu√≠ la URL base.
    const ENDPOINT = "/api/answer";

    // ======== Elementos ========
    const elQ = document.getElementById("q");
    const elSend = document.getElementById("btn-enviar");
    const elMic = document.getElementById("btn-mic");
    const elVoz = document.getElementById("btn-voz");
    const elReplay = document.getElementById("btn-replay");
    const elNew = document.getElementById("btn-new");
    const elClear = document.getElementById("btn-clear");
    const elExport = document.getElementById("btn-export");
    const elSpinner = document.getElementById("spinner");
    const elAnswer = document.getElementById("answer");
    const elRuta = document.getElementById("badge-ruta");
    const elTiempo = document.getElementById("badge-tiempo");
    const elVozBadge = document.getElementById("badge-voz");
    const elMicBadge = document.getElementById("badge-mic");
    const elStatus = document.getElementById("status-line");
    const elVoiceSelect = document.getElementById("voice-select");
    const elVoiceVolume = document.getElementById("voice-volume");
    const elVideo = document.getElementById("video");
    const elVideoSrc = document.getElementById("video-src");
    const elVideoToggle = document.getElementById("btn-video-toggle");

    // ======== Estado ========
    let lastAnswer = "";
    let speaking = false;
    let recognizing = false;
    let recognizer = null;

    // ======== Util ========
    function setBusy(b){ elSpinner.style.display = b ? "inline-block" : "none"; }
    function setStatus(msg){ elStatus.textContent = msg; }
    function speakStop(){
      window.speechSynthesis.cancel();
      speaking = false;
      elVozBadge.textContent = "Silencio";
    }
    function ms(n){
      if (n == null) return "‚Äî";
      const s = Number(n);
      if (!isFinite(s)) return "‚Äî";
      return s.toFixed(0) + " ms";
    }

    // ======== Voz (TTS) ========
    function loadVoices(){
      const voices = window.speechSynthesis.getVoices();
      elVoiceSelect.innerHTML = "";
      // Prioriza voces en espa√±ol (es-ES, es-MX, es-US, es-419)
      const pref = v => /(^es[-_]|Spanish)/i.test(v.lang) || /Spanish/i.test(v.name);
      const sorted = [...voices].sort((a,b) => (pref(b)-pref(a)) || a.name.localeCompare(b.name));
      for(const v of sorted){
        const opt = document.createElement("option");
        opt.value = v.name;
        opt.textContent = `${v.name} ‚Äî ${v.lang}`;
        elVoiceSelect.appendChild(opt);
      }
      // Selecci√≥n por defecto: primera en espa√±ol si existe
      const def = [...elVoiceSelect.options].find(o => /es/i.test(o.textContent)) || elVoiceSelect.options[0];
      if(def){ elVoiceSelect.value = def.value; }
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    function speak(text){
      if(!text || !window.speechSynthesis) return;
      speakStop();
      const u = new SpeechSynthesisUtterance(text);
      const sel = elVoiceSelect.value;
      const voices = window.speechSynthesis.getVoices();
      u.voice = voices.find(v => v.name === sel) || voices.find(v => /^es[-_]/i.test(v.lang)) || voices[0];
      u.lang = (u.voice && u.voice.lang) || "es-ES";
      u.rate = 1; u.pitch = 1; u.volume = parseFloat(elVoiceVolume.value || "1");
      u.onstart = () => { speaking = true; elVozBadge.textContent = "Hablando"; };
      u.onend   = () => { speaking = false; elVozBadge.textContent = "Silencio"; };
      window.speechSynthesis.speak(u);
    }

    // ======== Dictado (STT) ========
    function ensureRecognizer(){
      const R = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!R) return null;
      const r = new R();
      r.lang = "es-ES";
      r.interimResults = true;
      r.maxAlternatives = 1;
      return r;
    }
    function micToggle(){
      if(recognizing){ recognizer.stop(); return; }
      recognizer = ensureRecognizer();
      if(!recognizer){ alert("Dictado no soportado por este navegador."); return; }
      elMicBadge.textContent = "On";
      recognizing = true;
      elMic.textContent = "‚èπ Detener";
      setStatus("Escuchando‚Ä¶");
      recognizer.onresult = e => {
        let finalText = "";
        for(let i= e.resultIndex; i<e.results.length; i++){
          const tr = e.results[i][0].transcript;
          if(e.results[i].isFinal){ finalText += tr + " "; }
        }
        if(finalText) elQ.value = (elQ.value + " " + finalText).trim();
      };
      recognizer.onend = () => {
        recognizing = false;
        elMic.textContent = "üé§ Dictar";
        elMicBadge.textContent = "Off";
        setStatus("Dictado detenido.");
      };
      recognizer.onerror = () => {
        recognizing = false;
        elMic.textContent = "üé§ Dictar";
        elMicBadge.textContent = "Off";
        setStatus("Error de dictado.");
      };
      recognizer.start();
    }

    // ======== Llamada al backend ========
    async function preguntar(){
      const q = (elQ.value || "").trim();
      if(!q){ elQ.focus(); return; }
      setBusy(true);
      setStatus("Consultando‚Ä¶");
      elRuta.textContent = "‚Äî";
      elTiempo.textContent = "‚Äî";

      const t0 = performance.now();
      try{
        const url = (API_BASE || "") + ENDPOINT + "?q=" + encodeURIComponent(q);
        const resp = await fetch(url, { method:"GET" });
        const data = await resp.json();
        const t1 = performance.now();

        elRuta.textContent = data.ruta || "criterio";
        elTiempo.textContent = (data.tiempo_ms != null) ? ms(data.tiempo_ms) : ms(t1 - t0);

        const text = (data && data.answer) ? String(data.answer) : "";
        lastAnswer = text;
        elAnswer.textContent = text;
        setStatus("OK");
        // Habla autom√°ticamente si hay respuesta
        if(text) speak(text);
      }catch(err){
        console.error(err);
        elAnswer.textContent = "Hubo un problema al contactar el servicio.";
        elRuta.textContent = "‚Äî";
        elTiempo.textContent = "‚Äî";
        setStatus("Error");
      }finally{
        setBusy(false);
      }
    }

    // ======== Controles ========
    elSend.onclick = preguntar;
    elQ.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        preguntar();
      }
    });

    elMic.onclick = micToggle;

    elVoz.onclick = ()=>{
      if(speaking){ speakStop(); }
      else if(lastAnswer){ speak(lastAnswer); }
    };

    elReplay.onclick = ()=>{ if(lastAnswer){ speak(lastAnswer); } };

    elNew.onclick = ()=>{
      // Si en el futuro manejas sesi√≥n en backend, aqu√≠ podr√≠as resetear el id.
      elQ.value = "";
      lastAnswer = "";
      elAnswer.textContent = "";
      elRuta.textContent = "‚Äî";
      elTiempo.textContent = "‚Äî";
      setStatus("Nueva sesi√≥n local iniciada.");
      speakStop();
    };

    elClear.onclick = ()=>{
      elQ.value = "";
      elQ.focus();
    };

    elExport.onclick = ()=>{
      const ts = new Date().toISOString().replace(/[:.]/g,"-");
      const txt = [
        "Pregunta:",
        (elQ.value || "").trim(),
        "",
        "Respuesta:",
        lastAnswer,
        "",
        `Ruta: ${elRuta.textContent} | Tiempo: ${elTiempo.textContent}`
      ].join("\n");
      const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `lexium-respuesta-${ts}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // Video
    elVideoToggle.onclick = ()=>{
      if(elVideo.paused) elVideo.play(); else elVideo.pause();
    };
    elVideoSrc.addEventListener("change", ()=>{
      const v = (elVideoSrc.value||"").trim();
      if(v){ elVideo.src = v; setStatus("Video cargado."); }
    });
  </script>
</body>
</html>
