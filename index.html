<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fLexium ‚Äî Consultas</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
      --primary:#60a5fa; --primary-2:#7dd3fc; --border:#1f2937;
      --ok:#22c55e; --warn:#eab308; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#0b1020 0%,#0b1020 60%,#0a0f1f 100%); color:var(--text);
    }
    header{
      display:flex; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid var(--border);
      background:rgba(15,23,42,.6); position:sticky; top:0; backdrop-filter: blur(6px);
    }
    header .title{font-weight:700; letter-spacing:.3px}
    header .badge{font-size:12px; color:var(--muted)}
    main{padding:20px; max-width:1200px; margin:0 auto}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:18px}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg,rgba(17,24,39,.7),rgba(17,24,39,.4));
      border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow: 0 6px 28px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
    }
    label{display:block; color:var(--muted); margin:4px 0 8px}
    textarea{
      width:100%; min-height:140px; resize:vertical; border-radius:12px; padding:14px 12px;
      border:1px solid var(--border); outline:none; color:var(--text);
      background:rgba(15,23,42,.5);
    }
    textarea:focus{border-color:var(--primary)}
    .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px}
    button,.btn{
      appearance:none; border:1px solid var(--border); background:#121a2e; color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:all .15s ease; box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    button:hover{transform:translateY(-1px); border-color:#2a3758; background:#121b34}
    button.primary{background:linear-gradient(180deg,#1d4ed8,#1e40af); border-color:#1d4ed8}
    button.primary:hover{filter:brightness(1.05)}
    select{
      background:#121a2e; color:var(--text); border:1px solid var(--border);
      padding:10px 12px; border-radius:10px;
    }
    .status{font-size:12px; color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    #out{
      white-space:pre-wrap; /* mantiene saltos de l√≠nea */
      min-height:360px; border-radius:12px; padding:14px; border:1px solid var(--border);
      background:rgba(15,23,42,.45); overflow:auto; line-height:1.5;
    }
    .caption{font-size:12px; color:var(--muted); margin-top:6px}
    .toolbar{display:flex; align-items:center; gap:10px; justify-content:space-between; margin-top:6px}
    .left, .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    video{width:100%; max-height:200px; border-radius:12px; display:block; border:1px solid var(--border)}
  </style>
</head>
<body>
  <header>
    <div class="title">Lexium ‚Äî Consultas</div>
    <div class="badge" id="status"></div>
  </header>

  <main>
    <div class="grid">
      <!-- Entrada -->
      <section class="card">
        <label for="q">Escribe tu pregunta</label>
        <textarea id="q" placeholder="Ej: lista de estudiantes, promedio de Autoestima, calificaciones &quot;Castillo D Julia&quot;, percentil 90 de Asertividad por paralelo‚Ä¶"></textarea>

        <div class="row">
          <button id="btnSend" class="primary">Enviar</button>
          <button id="btnDict">üéôÔ∏è Dictar</button>
          <button id="btnToggleAV">‚èØ Parar/Activar voz y video</button>
          <button id="btnReplay">‚ü≥ Reproducir nuevamente</button>
          <button id="btnNew">Ôºã Nueva sesi√≥n</button>
          <button id="btnClear">üßπ Limpiar</button>

          <span style="flex:1"></span>

          <label for="exportSel" style="margin:0">Exportar‚Ä¶</label>
          <select id="exportSel">
            <option value="txt">Respuesta (.txt)</option>
            <option value="json">Payload (.json)</option>
          </select>
          <button id="btnExport" class="btn">Guardar</button>
        </div>

        <div class="caption">Enter = Enviar ¬∑ Shift+Enter = salto de l√≠nea</div>
      </section>

      <!-- Respuesta -->
      <section class="card">
        <label>Respuesta</label>
        <div id="out">‚Äî</div>

        <div class="toolbar">
          <div class="left">
            <div class="status">Ruta: <span id="rutaHint" class="warn">‚Äî</span></div>
          </div>
          <div class="right">
            <span class="status">Tiempo: <span id="tiempoHint">‚Äî</span></span>
          </div>
        </div>

        <label style="margin-top:14px">Video (opcional)</label>
        <video id="vid" controls muted playsinline></video>
      </section>
    </div>
  </main>

  <!-- ====== SCRIPT ====== -->
  <script>
  /* ===== CONFIG ===== */
  const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app"; // URL de Cloud Run
  const GPT_PATH = "/api/gpt";          // endpoint preferido
  const FALLBACK_PATH = "/api/answer";  // compatibilidad si /api/gpt no existe

  /* ===== UI refs ===== */
  const qEl       = document.getElementById("q");
  const outEl     = document.getElementById("out");
  const statusEl  = document.getElementById("status");
  const rutaHint  = document.getElementById("rutaHint");
  const tiempoEl  = document.getElementById("tiempoHint");
  const btnSend   = document.getElementById("btnSend");
  const btnDict   = document.getElementById("btnDict");
  const btnToggle = document.getElementById("btnToggleAV");
  const btnReplay = document.getElementById("btnReplay");
  const btnNew    = document.getElementById("btnNew");
  const btnClear  = document.getElementById("btnClear");
  const btnExport = document.getElementById("btnExport");
  const exportSel = document.getElementById("exportSel");
  const vidEl     = document.getElementById("vid");

  function setStatus(txt, cls=""){ if(!statusEl) return; statusEl.className="badge "+cls; statusEl.textContent=txt; }
  function setBusy(b){ if(btnSend) btnSend.disabled=b; }

  /* ===== Fetch helpers ===== */
  async function fetchJSON(url, opts = {}) {
    const r = await fetch(url, opts);
    const ct = r.headers.get("content-type") || "";
    if (!r.ok) {
      const body = ct.includes("application/json") ? await r.json().catch(()=>({})) : await r.text().catch(()=> "");
      throw new Error(`${r.status} ${r.statusText} | ${typeof body==="string"?body:JSON.stringify(body)}`);
    }
    if (ct.includes("application/json")) return r.json();
    return { answer: await r.text() };
  }

  async function callAPI(question) {
    // 1) POST /api/gpt
    try {
      return await fetchJSON(API_BASE + GPT_PATH, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ q: question })
      });
    } catch (e1) {
      console.warn("POST /api/gpt fall√≥:", e1.message);
      // 2) GET /api/answer?q=
      try {
        return await fetchJSON(API_BASE + FALLBACK_PATH + "?q=" + encodeURIComponent(question));
      } catch (e2) {
        console.warn("GET /api/answer fall√≥:", e2.message);
        // 3) POST /api/answer
        return await fetchJSON(API_BASE + FALLBACK_PATH, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ q: question })
        });
      }
    }
  }

  /* ===== Render ===== */
  function renderAnswer(data) {
    const text = (data && (data.answer || data.text)) || "Sin contenido.";
    outEl.textContent = text;
    if ("value" in outEl) outEl.value = text; // por si fuera <textarea>
    if (rutaHint) rutaHint.textContent = data?.ruta ?? "‚Äî";
    if (tiempoEl) tiempoEl.textContent = data?.tiempo_ms ? (data.tiempo_ms + " ms") : "‚Äî";
  }

  /* ===== Env√≠o principal ===== */
  async function send() {
    const question = (qEl.value || "").trim();
    if (!question) return;
    setStatus("Consultando‚Ä¶","warn"); setBusy(true);
    try {
      const data = await callAPI(question);
      renderAnswer(data);
      setStatus("OK","ok");
    } catch (err) {
      console.error(err);
      renderAnswer({ answer: "‚ö†Ô∏è Error consultando el servicio.\n" + err.message });
      setStatus("Error","err");
    } finally {
      setBusy(false);
    }
  }

  /* ===== Export ===== */
  function download(filename, text) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], {type:"text/plain;charset=utf-8"}));
    a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }
  function exportAnswer() {
    const mode = exportSel.value;
    if (mode === "json") {
      const payload = { answer: outEl.textContent, at: new Date().toISOString() };
      download("lexium_respuesta.json", JSON.stringify(payload, null, 2));
    } else {
      download("lexium_respuesta.txt", outEl.textContent || "");
    }
  }

  /* ===== Dictado (opcional) ===== */
  let recog=null, recogOn=false; // Web Speech API si existe
  function initSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return null;
    const r = new SR();
    r.lang = "es-ES"; r.continuous=false; r.interimResults=false;
    r.onresult = (e)=>{ const tx = e.results?.[0]?.[0]?.transcript || ""; if(tx){ qEl.value = (qEl.value+" "+tx).trim(); } };
    r.onerror = ()=>{};
    r.onend = ()=>{ recogOn=false; btnDict && (btnDict.textContent="üéôÔ∏è Dictar"); };
    return r;
  }

  /* ===== Voz de respuesta (opcional) ===== */
  let ttsOn=false;
  function speak(text){
    if(!("speechSynthesis" in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "es-ES"; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
  }

  /* ===== Eventos ===== */
  btnSend?.addEventListener("click", send);
  btnClear?.addEventListener("click", ()=>{ outEl.textContent=""; if("value" in outEl) outEl.value=""; setStatus(""); });
  btnExport?.addEventListener("click", exportAnswer);
  qEl?.addEventListener("keydown",(e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); } });

  btnDict?.addEventListener("click", ()=>{
    if(!recog) recog = initSTT();
    if(!recog){ alert("Dictado no disponible en este navegador."); return; }
    if(recogOn){ recog.stop(); return; }
    recogOn=true; btnDict.textContent="‚èπÔ∏è Detener dictado"; recog.start();
  });

  btnToggle?.addEventListener("click", ()=>{
    ttsOn = !ttsOn;
    btnToggle.textContent = ttsOn ? "‚è∏Ô∏è Silenciar voz" : "‚èØ Parar/Activar voz y video";
    if(ttsOn && outEl.textContent) speak(outEl.textContent);
  });

  btnReplay?.addEventListener("click", ()=>{ if(ttsOn && outEl.textContent) speak(outEl.textContent); });

  btnNew?.addEventListener("click", ()=>{
    qEl.value=""; outEl.textContent="‚Äî"; setStatus("");
    rutaHint.textContent="‚Äî"; tiempoEl.textContent="‚Äî";
  });

  // Si necesitas precargar algo, deja aqu√≠.
  setStatus("");
  </script>
</body>
</html>
