<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asistente Lexium 1156</title>
<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#6b7280; --pri:#0d6efd; --bd:#e5e7eb;
    --ok:#16a34a; --err:#b91c1c;
    --heroH: 65vh;
    --wrapW: 1180px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;}

  /* Aviso superior izquierdo */
  .processingBadge{
    position:fixed; top:8px; left:10px; z-index:70;
    display:none; padding:6px 10px; border-radius:8px;
    background:#fffbeb; border:1px solid #f59e0b; color:#92400e;
    font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,.05)
  }

  .mediaBar{
    position:fixed; top:0; left:0; width:100vw; z-index:50;
    background:#fff; border-bottom:none; padding:0; margin:0;
    pointer-events:none;
  }
  .mediaBar *{ pointer-events:none; }
  .mediaInner{max-width:var(--wrapW); margin:0 auto; padding:12px;}
  .heroGrid{display:grid; grid-template-columns:1fr 3fr 1.16fr; align-items:center; gap:8px;}
  .sideImg{display:flex; justify-content:center; height:var(--heroH); margin:0;}
  .sideImg img{max-width:100%; height:100%; object-fit:contain; opacity:.95}
  .videoBox{height:var(--heroH); margin:0;}
  .videoBox video{width:100%; height:100%; object-fit:cover; border:none; display:block; border-radius:10px}

  .contentWrap{max-width:var(--wrapW); margin:0 auto; padding:12px; padding-top:calc(var(--heroH) + 8px);}

  .toolbar{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:8px 0}
  .toolbar button, .toolbar select{padding:9px 14px; border:1px solid var(--bd); border-radius:10px; background:#fff; cursor:pointer;}
  .toolbar button:hover{background:#f5f7fb}
  .toolbar button[disabled]{opacity:.6; cursor:not-allowed}

  .hist{position:fixed; right:14px; top:10px; z-index:60}
  .hist button{padding:8px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff}

  .query{width:100%; height:48px; min-height:48px; max-height:48px; resize:none; border:1px solid var(--bd); border-radius:10px; padding:10px; font-size:16px; line-height:1.4;}
  .out{margin:8px 0; border:1px solid var(--bd); border-radius:12px; padding:12px; overflow:auto; white-space:pre-wrap; max-height:65vh;}
  .muted{color:var(--muted); font-size:.9rem}

  table{width:100%; border-collapse:collapse; margin:10px 0}
  th,td{border:1px solid var(--bd); padding:8px}
  th{background:#f8fafc; text-align:left}

  .loader{display:none} /* se desactiva el loader antiguo */

  /* Modal historial */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; place-items:center; z-index:80}
  .modalBox{background:#fff; width:min(920px, 94vw); max-height:88vh; overflow:auto; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.18); padding:14px}
  .modalBox h3{margin:0 0 8px}
  .histItem{border:1px dashed var(--bd); border-radius:10px; padding:8px; margin:8px 0}
  .histItem pre{white-space:pre-wrap}
</style>
</head>
<body>

  <!-- Procesando (arriba izquierda) -->
  <div id="processing" class="processingBadge">Procesando‚Ä¶</div>

  <div class="hist">
    <button id="btnHist" title="Ver sesiones guardadas">Historial</button>
  </div>

  <div class="mediaBar" aria-label="cabecera">
    <div class="mediaInner">
      <div class="heroGrid">
        <div class="sideImg left">
          <img src="left.png" alt="Logo izquierdo"/>
        </div>
        <div class="videoBox">
          <video id="vid" preload="auto" muted playsinline src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"></video>
        </div>
        <div class="sideImg right">
          <img src="right.png" alt="Logo derecho"/>
        </div>
      </div>
    </div>
  </div>

  <div class="contentWrap">
    <div style="margin:10px 0 6px">
      <textarea id="q" class="query" rows="2" placeholder="ESCRIBE O HABLA PARA PREGUNTAR‚Ä¶"></textarea>
    </div>

    <div class="toolbar">
      <button id="btnSend" title="Enviar consulta al backend">Enviar</button>
      <button id="btnDict" title="Dictar por voz (empieza / detiene)">üé§ Dictar</button>
      <button id="btnToggleAV" title="Parar/Activar voz">‚èØ Activar voz</button>
      <button id="btnReplay" title="Reproducir nuevamente la voz desde el principio">‚ü≥ Reproducir</button>
      <button id="btnNew" title="Nueva sesi√≥n (limpia y guarda la actual)">Ôºã Nueva sesi√≥n</button>
      <button id="btnClear" title="Limpiar pregunta y respuesta">üßπ Limpiar</button>
      <select id="selExport" title="Exportar lo generado (PDF muestra vista previa)">
        <option value="">Exportar‚Ä¶</option>
        <option value="pdf">PDF (vista previa)</option>
        <option value="xls">XLS</option>
        <option value="doc">DOC</option>
      </select>
    </div>

    <div id="out" class="out" aria-live="polite"></div>
    <div id="status" class="muted"></div>
  </div>

  <!-- Modal Historial -->
  <div id="histModal" class="modal" aria-hidden="true">
    <div class="modalBox">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
        <h3>Historial de sesi√≥n</h3>
        <div style="display:flex; gap:8px">
          <button id="btnHistDownload">‚¨áÔ∏è Descargar</button>
          <button id="btnHistClear">üßπ Borrar todo</button>
          <button id="btnHistClose">‚úñ Cerrar</button>
        </div>
      </div>
      <div id="histBody"></div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app";
const GPT_PATH = "/api/gpt";
const FALLBACK_PATH = "/api/answer";

/* ====== UI refs ====== */
const q = document.getElementById("q");
const out = document.getElementById("out");
const statusEl = document.getElementById("status");
const vid = document.getElementById("vid");
const btnSend = document.getElementById("btnSend");
const btnDict = document.getElementById("btnDict");
const btnToggleAV = document.getElementById("btnToggleAV");
const btnReplay = document.getElementById("btnReplay");
const btnNew = document.getElementById("btnNew");
const btnClear = document.getElementById("btnClear");
const selExport = document.getElementById("selExport");
const btnHist = document.getElementById("btnHist");

const processingBadge = document.getElementById("processing");
const histModal = document.getElementById("histModal");
const histBody  = document.getElementById("histBody");
const btnHistClose = document.getElementById("btnHistClose");
const btnHistClear = document.getElementById("btnHistClear");
const btnHistDownload = document.getElementById("btnHistDownload");

/* ====== Utilidades ====== */
function esc(x){ return String(x).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }
function showProcessing(show){ processingBadge.style.display = show? "block":"none"; }
function isUnrecognized(data){
  const t = (data?.general || "").toLowerCase();
  return t.includes("consulta no reconocida");
}

/* ====== Historial ====== */
const SKEY="lexium_sessions_v2";
function persistSession(question, data, renderedHTML){
  const all = getSessions();
  const item = { id: new Date().toISOString(), question, data, html: renderedHTML };
  all.unshift(item);
  try{ localStorage.setItem(SKEY, JSON.stringify(all.slice(0,120))); }catch(_){}
}
function getSessions(){
  try{ return JSON.parse(localStorage.getItem(SKEY)||"[]"); }catch(_){ return []; }
}
function openHistory(){
  const all = getSessions();
  histBody.innerHTML = all.length? all.map((s,i)=>`
    <div class="histItem">
      <div><b>${i+1}.</b> <b>Pregunta:</b> ${esc(s.question)}</div>
      <details>
        <summary>Ver respuesta</summary>
        <div>${s.html||"<em>(sin html)</em>"}</div>
      </details>
      <div class="muted" style="margin-top:4px">${new Date(s.id).toLocaleString()}</div>
    </div>
  `).join("") : "<em>Sin historial.</em>";
  histModal.style.display="grid"; histModal.setAttribute("aria-hidden","false");
}
function closeHistory(){ histModal.style.display="none"; histModal.setAttribute("aria-hidden","true"); }
function clearHistory(){
  localStorage.removeItem(SKEY);
  histBody.innerHTML="<em>Historial borrado.</em>";
}
function downloadHistory(){
  const blob = new Blob([localStorage.getItem(SKEY)||"[]"],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="historial_lexium.json"; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),500);
}

/* ====== Dictado ====== */
let recognizer=null;
function toggleDict(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert("Dictado no soportado en este navegador."); return; }
  if(!recognizer){
    recognizer=new SR(); recognizer.lang="es-ES"; recognizer.continuous=false; recognizer.interimResults=false;
    recognizer.onresult=e=>{
      const t=Array.from(e.results).map(r=>r[0].transcript).join(" ");
      q.value=(q.value? q.value+" " : "") + t;
    };
  }
  if(recognizer.listening){ recognizer.stop(); recognizer.listening=false; btnDict.textContent="üé§ Dictar"; }
  else { recognizer.start(); recognizer.listening=true; btnDict.textContent="‚èπ Detener dictado"; }
}

/* ====== Voz femenina + TTS ====== */
const PREFERRED_NAMES=[
  "Microsoft Sabina","Microsoft Helena","Microsoft Laura","Microsoft Dalia","Microsoft Elvira","Microsoft Paloma","Microsoft Maria","Microsoft Lucia",
  "Google espa√±ol","Google espa√±ol de Estados","Google US Espa√±ol",
  "Monica","Paulina","Camila","Sofia","Elena","Isabella","Lucia","Maria","Carla"
];
const SP_LANGS=["es","es-ES","es-MX","es-US","es-419","es-AR","es-CL","es-CO","es-PE","es-EC"];

let selectedVoice=null;
function scoreVoice(v){
  const name=(v.name||"").toLowerCase(), lang=(v.lang||"").toLowerCase();
  let s=0;
  if (SP_LANGS.some(l=>lang.startsWith(l.toLowerCase()))) s+=5;
  if (PREFERRED_NAMES.some(n=>name.includes(n.toLowerCase()))) s+=6;
  if (name.includes("female")||name.includes("femenina")||name.includes("mujer")) s+=4;
  if (name.includes("google")) s+=2; if (name.includes("microsoft")) s+=2;
  return s;
}
function chooseFemaleES(){
  if(typeof speechSynthesis==="undefined") return null;
  const vs=speechSynthesis.getVoices(); if(!vs.length) return null;
  for(const n of PREFERRED_NAMES){ const m=vs.find(v=>v.name.toLowerCase().includes(n.toLowerCase())); if(m) return m; }
  return vs.slice().sort((a,b)=>scoreVoice(b)-scoreVoice(a))[0]||null;
}
function initVoice(){ selectedVoice=chooseFemaleES(); }
if(typeof speechSynthesis!=="undefined"){ speechSynthesis.onvoiceschanged=initVoice; setTimeout(initVoice,150); }

/* === Regex bullets === */
const BULLET_RE = /^(?:[‚Ä¢\-‚Äì*]|\d+\.)\s+/u;

/* === Numeraci√≥n uniforme de texto general === */
function generalToOrderedListHTML(g){
  if (!g) return "";
  const lines = g.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const bulletLike = lines.filter(s=>BULLET_RE.test(s)).length;
  const manyPlainLines = lines.filter(s=>!/[.!?;:]\s*$/.test(s) && s.length<=80).length;
  const shouldNumber = (lines.length>=3) && (bulletLike>0 || manyPlainLines >= Math.ceil(lines.length*0.6));
  if (shouldNumber) {
    const items = lines.map(s=>s.replace(BULLET_RE,"")).filter(Boolean);
    return `<ol>${items.map(it=>`<li>${esc(it)}</li>`).join("")}</ol>`;
  }
  return `<p>${esc(g).replace(/\n/g,"<br>")}</p>`;
}

/* === Construir TTS con TODO el contenido === */
function textForTTSFromHTML(html){
  const c=document.createElement("div"); c.innerHTML=html;
  const parts=[];
  c.querySelectorAll("h3,h4").forEach(h=>{ const t=h.textContent.trim(); if(t) parts.push(t+"."); });
  c.querySelectorAll("p").forEach(p=>{const t=p.textContent.trim(); if(t) parts.push(t);});
  c.querySelectorAll("ol,ul").forEach(list=>{
    const items=[...list.querySelectorAll("li")].map(li=>li.textContent.trim()).filter(Boolean);
    if(items.length){ parts.push(items.map((t,i)=>`${i+1}. ${t}.`).join("\n")); }
  });
  c.querySelectorAll("table").forEach(tbl=>{
    const title=tbl.previousElementSibling && /H3|H4/.test(tbl.previousElementSibling.tagName)? tbl.previousElementSibling.textContent.trim() : "Tabla";
    parts.push(title+".");
    const rows=[...tbl.querySelectorAll("tbody tr")];
    rows.forEach((tr,i)=>{
      const tds=[...tr.querySelectorAll("td")].map(td=>td.textContent.trim());
      const label=tds.slice(1,2)[0]||tds[0]||"";
      parts.push(`${i+1}. ${label}.`);
    });
  });
  return parts.join("\n\n");
}

/* ====== Verificaci√≥n de enlaces ====== */
async function verifyLinksIn(outEl){
  const anchors = outEl.querySelectorAll("a[href]");
  for(const a of anchors){
    const url=a.getAttribute("href");
    try{
      await fetch(url, { method:"HEAD", mode:"no-cors" });
    }catch{
      a.style.color="#6b7280"; a.style.textDecoration="underline dotted";
      a.setAttribute("title","‚ö†Ô∏è Enlace no disponible");
      a.insertAdjacentText("afterend"," ‚ö†Ô∏è");
    }
  }
}

/* ====== Memoria de sesi√≥n ====== */
let sessionCtx = { lastStudent: null };
function updateSessionContextFromQuestion(text){
  const m = text.match(/estudiante\s+([A-Za-z√Å√â√ç√ì√ö√ë√°√©√≠√≥√∫'¬¥` ]+)/i);
  if(m){ sessionCtx.lastStudent = m[1].trim(); }
}
function enrichQueryWithContext(text){
  if(sessionCtx.lastStudent){
    return `${text}. (Contexto: estudiante ${sessionCtx.lastStudent})`;
  }
  return text;
}

/* ====== Normalizar listas/tables ====== */
function normalizeLists(lists){
  if(!Array.isArray(lists)) return [];
  return lists.map((entry,i)=>{
    if(Array.isArray(entry)){
      const flat=entry.every(x=>typeof x==="string"||typeof x==="number");
      return {title:`Lista ${i+1}`, items: flat? entry : entry.map(x=>Array.isArray(x)? x.join(" ") : String(x))};
    }else if(entry && typeof entry==="object"){
      return {title: entry.title||`Lista ${i+1}`, items: Array.isArray(entry.items)? entry.items: []};
    }else{
      return {title:`Lista ${i+1}`, items:[String(entry)]};
    }
  });
}

/* ====== Render ====== */
function renderAnswer(data){
  let html="";
  const generalTxt = data.general || data.answer || data.text || "";
  if(generalTxt){ html += `<h3>Respuesta</h3>` + generalToOrderedListHTML(generalTxt); }

  const lists=normalizeLists(data.lists||[]);
  lists.forEach(l=>{
    html += `<h3>${esc(l.title||"Lista")}</h3><ol>` + l.items.map(it=>`<li>${esc(it)}</li>`).join("") + `</ol>`;
  });

  (data.tables||[]).forEach(t=>{
    const cols = t.columns||[];
    const rows = t.rows||[];
    const withNum = rows.map((r,idx)=>[String(idx+1), ...r]);
    html += `<h3>${esc(t.title||"Tabla")}</h3><table><thead><tr>`;
    html += ["#", ...cols].map(c=>`<th>${esc(c)}</th>`).join("");
    html += `</tr></thead><tbody>`;
    withNum.forEach(r=>{ html += `<tr>` + r.map(x=>`<td>${esc(x)}</td>`).join("") + `</tr>`; });
    html += `</tbody></table>`;
  });

  out.innerHTML = html || "<em>Sin contenido.</em>";

  verifyLinksIn(out);

  // TTS: leer TODO desde el HTML final
  TTS.enabled = true;
  const txt = textForTTSFromHTML(out.innerHTML);
  TTS.stopAll();
  TTS.loadFromText(txt);
  TTS.start(0);
}

/* ====== TTS manager ====== */
const TTS={
  enabled:false, chunks:[], i:0, utter:null, paused:false, speaking:false, textCache:"",
  makeChunks(text,maxLen=360){
    const res=[]; const parts=String(text).split(/(\.|\?|!|\n)/);
    let buf=""; for(let i=0;i<parts.length;i+=2){ const seg=(parts[i]||"")+(parts[i+1]||"");
      if((buf+seg).length<=maxLen) buf+=seg; else{ if(buf.trim()) res.push(buf.trim()); buf=seg; } }
    if(buf.trim()) res.push(buf.trim()); return res;
  },
  loadFromOut(){ this.textCache=textForTTSFromHTML(out.innerHTML); this.chunks=this.makeChunks(this.textCache); this.i=0; },
  loadFromText(t){ this.textCache=String(t||""); this.chunks=this.makeChunks(this.textCache); this.i=0; },
  speakNext(){
    if(!this.enabled || this.i>=this.chunks.length){ this.finish(); return; }
    const u=new SpeechSynthesisUtterance(this.chunks[this.i++]);
    if(selectedVoice) u.voice=selectedVoice;
    u.lang=(selectedVoice?.lang)||"es-ES"; u.rate=0.98; u.pitch=1.08; u.volume=1;
    u.onstart=()=>{ this.speaking=true; this.paused=false; if(vid){ vid.loop=true; vid.play().catch(()=>{});} };
    u.onend =()=>{ this.speakNext(); };
    u.onerror=()=>{ this.speakNext(); };
    this.utter=u; speechSynthesis.speak(u);
  },
  start(fromIndex=0){
    if(typeof speechSynthesis==="undefined" || !this.chunks.length) return;
    this.enabled=true; if(fromIndex>=0) this.i=fromIndex;
    speechSynthesis.cancel(); this.speakNext();
  },
  pause(){ if(this.speaking && !this.paused){ speechSynthesis.pause(); this.paused=true; if(vid) vid.pause(); } },
  resume(){ if(this.paused){ speechSynthesis.resume(); this.paused=false; if(vid) vid.play().catch(()=>{}); }
           else if(!this.speaking && this.enabled){ this.speakNext(); } },
  restartFromStart(){ this.enabled=true; this.loadFromOut(); this.start(0); },
  finish(){ this.speaking=false; this.paused=false; this.utter=null; if(vid){ vid.loop=false; vid.pause(); } },
  stopAll(){ this.enabled=false; this.paused=false; this.speaking=false; this.utter=null;
             if(typeof speechSynthesis!=="undefined") speechSynthesis.cancel();
             if(vid){ vid.loop=false; vid.pause(); } }
};

/* ====== Helpers de red ====== */
function withTimeout(promise, ms, controller){
  let t; const timeout = new Promise((_,rej)=> t=setTimeout(()=>{ try{controller?.abort()}catch{}; rej(new Error("timeout")) }, ms));
  return Promise.race([promise.finally(()=>clearTimeout(t)), timeout]);
}
async function fetchJSON(url, opts={}, ms=12000){
  const ctrl = new AbortController();
  const res = await withTimeout(fetch(url, {...opts, signal: ctrl.signal}), ms, ctrl);
  const data = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

/* ====== Secuencia preferente: GPT ‚Üí fallback answer ‚Üí (si no reconocido) GPT ====== */
async function ask(){
  const text=q.value.trim(); if(!text) return;
  if (btnSend.disabled) return; // anti reentrada
  btnSend.disabled=true;
  const old=btnSend.textContent; btnSend.textContent="Enviando‚Ä¶";
  showProcessing(true); statusEl.textContent=""; // sin loader inferior

  try{
    const enriched = enrichQueryWithContext(text);

    // 1) Intento principal: GPT (lenguaje natural)
    let data = null, gptError=null;
    try{
      data = await fetchJSON(`${API_BASE}${GPT_PATH}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify({ q: enriched })
      }, 12000);
    }catch(e){ gptError=e; }

    // 2) Si GPT falla o viene vac√≠o, usar /api/answer
    if(!data || data.ok===false || !data.general){
      try{
        data = await fetchJSON(`${API_BASE}${FALLBACK_PATH}?q=${encodeURIComponent(enriched)}`, {
          headers:{ "Accept":"application/json" }
        }, 12000);
      }catch(e2){
        // Si tambi√©n falla, reintento final a GPT
        if(gptError) throw gptError;
        else throw e2;
      }
    }

    // 3) Si la respuesta del fallback es ‚Äúconsulta no reconocida‚Ä¶‚Äù, forzar segundo intento con GPT
    if(isUnrecognized(data)){
      try{
        const retry = await fetchJSON(`${API_BASE}${GPT_PATH}`, {
          method:"POST",
          headers:{ "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify({ q: enriched })
        }, 14000);
        if(retry && retry.ok!==false && retry.general){
          data = retry; // reemplazar por la buena
        }
      }catch(_){ /* si no se puede, dejamos la respuesta actual */ }
    }

    if(!data || data.ok===false) throw new Error(data?.error || data?.general || "Sin respuesta");
    renderAnswer(data);
    persistSession(text, data, out.innerHTML);
    updateSessionContextFromQuestion(text);

  }catch(e){
    out.innerHTML = `<pre style="color:var(--err)">${esc(String(e))}</pre>`;
    persistSession(text, {}, out.innerHTML);
  }finally{
    btnSend.disabled=false; btnSend.textContent=old; showProcessing(false);
  }
}

/* ====== Exportar con preguntas + respuestas ====== */
function getExportHTML(){
  const all = getSessions();
  if(!all.length) return "<em>Sin contenido</em>";
  return `
    <h2>Reporte Lexium (Preguntas y Respuestas)</h2>
    ${all.map((s,i)=>`
      <section style="margin:14px 0">
        <h3>${i+1}. Pregunta</h3>
        <p>${esc(s.question)}</p>
        <h3>Respuesta</h3>
        ${s.html || "<em>(sin respuesta)</em>"}
      </section>
    `).join("")}
  `;
}
function printHTML(html){
  const iframe = document.createElement('iframe');
  iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
  iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
  document.body.appendChild(iframe);
  const doc = iframe.contentWindow || iframe.contentDocument;
  const idoc = doc.document || doc;
  idoc.open(); idoc.write(html); idoc.close();
  setTimeout(()=>{ try{ (iframe.contentWindow || iframe).focus(); (iframe.contentWindow || iframe).print(); }catch{} }, 80);
  setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch{} }, 30000);
}
selExport.addEventListener("change", ()=>{
  const v=selExport.value; selExport.value="";
  const exportHTML = `<!doctype html><html><head><meta charset="utf-8"><title>Lexium - Export</title>
    <style>body{font:16px/1.5 system-ui;margin:28px;color:#111}
           table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:6px}</style>
    </head><body>${getExportHTML()}</body></html>`;

  if(v==="pdf"){
    try{ printHTML(exportHTML); }
    catch(_){
      const w=window.open("", "_blank", "noopener,noreferrer");
      if(w){ w.document.open(); w.document.write(exportHTML); w.document.close(); w.focus(); w.print(); }
    }
    return;
  }
  if(v==="xls"||v==="doc"){
    const mime = v==="xls" ? "application/vnd.ms-excel" : "application/msword";
    const blob=new Blob([`<html><body>${getExportHTML()}</body></html>`],{type:mime});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`reporte_lexium.${v}`; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),500);
  }
});

/* ====== Botones ====== */
btnSend.addEventListener("click", ask);
btnDict.addEventListener("click", toggleDict);
btnToggleAV.addEventListener("click", ()=>{
  if(!TTS.enabled){ TTS.enabled=true; TTS.loadFromOut(); TTS.start(TTS.i); btnToggleAV.textContent="‚è∏ Silenciar voz"; return; }
  if(TTS.paused){ TTS.resume(); btnToggleAV.textContent="‚è∏ Silenciar voz"; }
  else if(TTS.speaking){ TTS.pause(); btnToggleAV.textContent="‚ñ∂ Reanudar voz"; }
  else { TTS.resume(); btnToggleAV.textContent="‚è∏ Silenciar voz"; }
});
btnReplay.addEventListener("click", ()=>{ TTS.restartFromStart(); btnToggleAV.textContent="‚è∏ Silenciar voz"; });
btnClear.addEventListener("click", ()=>{ q.value=""; out.innerHTML=""; TTS.stopAll(); });
btnNew.addEventListener("click", ()=>{ 
  sessionCtx = { lastStudent:null }; // romper contexto
  q.value=""; out.innerHTML=""; TTS.stopAll(); 
});
btnHist.addEventListener("click", openHistory);
btnHistClose.addEventListener("click", closeHistory);
btnHistClear.addEventListener("click", clearHistory);
btnHistDownload.addEventListener("click", downloadHistory);

/* ====== UX ====== */
q.addEventListener("keydown",(e)=>{ if(e.key==="Enter" && (e.ctrlKey||e.metaKey)) ask(); });

/* Ocultar cualquier rastro del loader antiguo */
statusEl.textContent="";
</script>
</body>
</html>
