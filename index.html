<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Análisis de Datos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #1a202c;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .fixed-top {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .content-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .text-section, .table-section {
            background-color: #f7fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        .button {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .button:hover {
            background-color: #4338ca;
        }
        .button-red {
            background-color: #ef4444;
        }
        .button-red:hover {
            background-color: #dc2626;
        }
        .button-yellow {
            background-color: #f59e0b;
        }
        .button-yellow:hover {
            background-color: #d97706;
        }
        .input-area {
            display: flex;
            width: 100%;
            margin-top: 1rem;
            align-items: center;
        }
        .input-area input {
            flex-grow: 1;
        }
    </style>
</head>
<body class="bg-white">
    <div class="fixed-top w-full">
        <div class="flex items-center justify-center space-x-4 mb-4 w-full">
            <!-- Se corrigió la ruta de las imágenes y el tamaño del video -->
            <img id="image-left" src="left.png" alt="Imagen Izquierda" class="rounded-lg" onerror="this.src='https://placehold.co/150x150/e2e8f0/a0aec0?text=Izquierda'">
            <video id="video-center" src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" controls muted playsinline class="rounded-lg w-1/3"></video>
            <img id="image-right" src="right.png" alt="Imagen Derecha" class="rounded-lg" onerror="this.src='https://placehold.co/150x150/e2e8f0/a0aec0?text=Derecha'">
        </div>
        <div class="flex items-center justify-center space-x-4 mb-4 w-full">
            <input type="text" id="user-input" placeholder="Ingresa tu pregunta..." class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1">
            <button id="dictate-button" class="p-3 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="send-button" class="button p-3 rounded-full">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="flex items-center justify-center space-x-4 mb-4 w-full">
            <button id="export-button" class="button">Exportar</button>
            <button id="silence-button" class="button button-red">Silenciar Voz</button>
            <button id="clear-button" class="button">Limpiar</button>
            <button id="new-session-button" class="button button-yellow">Nueva Sesión</button>
            <button id="history-button" class="button">Ver Historial</button>
        </div>
        
    </div>
    
    <div class="content-area mt-4 w-full px-4">
        <h2 class="text-xl font-semibold mb-2">Respuesta del Asistente</h2>
        <div id="text-section" class="text-section h-64">
            <p class="text-gray-500 italic">Aquí aparecerá el texto de la respuesta.</p>
        </div>

        <h2 class="text-xl font-semibold mb-2 mt-4">Tablas y Listados</h2>
        <div id="table-section" class="table-section h-64">
            <p class="text-gray-500 italic">Aquí se mostrarán las tablas y listados.</p>
        </div>
    </div>
    
    <script>
        const video = document.getElementById('video-center');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const dictateButton = document.getElementById('dictate-button');
        const silenceButton = document.getElementById('silence-button');
        const clearButton = document.getElementById('clear-button');
        const newSessionButton = document.getElementById('new-session-button');
        const exportButton = document.getElementById('export-button');
        const historyButton = document.getElementById('history-button');
        const textSection = document.getElementById('text-section');
        const tableSection = document.getElementById('table-section');

        let isVideoPlaying = false;
        let isSpeaking = false;
        let recognition;
        let sessionData = []; // Para guardar el contexto de la sesión

        // Simula la conexión con el backend
        async function getBackendResponse(prompt) {
            // Aquí iría la lógica para enviar la pregunta y los archivos al backend
            // El backend se comunicaría con GPT-5
            return new Promise(resolve => setTimeout(() => {
                const isTableRequest = prompt.toLowerCase().includes('tabla') || prompt.toLowerCase().includes('listado');
                const responseText = isTableRequest ? "Aquí tienes la tabla que solicitaste." : "Esta es una respuesta de prueba a tu pregunta.";
                const tableContent = isTableRequest ? `<table class="min-w-full divide-y divide-gray-200 mt-4"><thead><tr><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Puntuación</th></tr></thead><tbody><tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Juan</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">85</td></tr><tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">María</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">92</td></tr></tbody></table>` : '';
                resolve({ text: responseText, tables: tableContent });
            }, 1500));
        }

        async function processPrompt(prompt) {
            textSection.innerHTML = '<p class="italic text-gray-500">Analizando...</p>';
            tableSection.innerHTML = '<p class="italic text-gray-500">Analizando...</p>';
            
            // Simula el análisis de la IA
            const result = await getBackendResponse(prompt);
            
            // Mostrar la respuesta en la interfaz
            textSection.innerHTML = `<p>${result.text}</p>`;
            tableSection.innerHTML = result.tables;

            // Almacenar en la memoria de la sesión
            sessionData.push({ prompt, response: result.text, tables: result.tables });

            // Iniciar la reproducción del video y la voz
            video.play();
            isVideoPlaying = true;
            speak(result.text);

            // Detener el video cuando la voz termine
            window.speechSynthesis.onend = () => {
                video.pause();
                isVideoPlaying = false;
            };
        }

        // Lógica de selección de voz mejorada para asegurar que siempre sea femenina
        function speak(text) {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            
            // Prioriza voces femeninas específicas en español de México/Ecuador
            let femaleVoice = voices.find(voice => 
                (voice.lang === 'es-MX' || voice.lang === 'es-EC') && voice.name.toLowerCase().includes('femenina') || voice.name.toLowerCase().includes('mujer')
            );

            // Si no se encuentra una específica, busca una voz femenina en cualquier español
            if (!femaleVoice) {
                femaleVoice = voices.find(voice => 
                    voice.lang.startsWith('es-') && (voice.name.toLowerCase().includes('femenina') || voice.name.toLowerCase().includes('female'))
                );
            }

            if (femaleVoice) {
                utterance.voice = femaleVoice;
            } else {
                console.warn("No se encontró una voz femenina en español. La respuesta podría no ser femenina.");
            }

            window.speechSynthesis.speak(utterance);
            isSpeaking = true;
        }

        // Event Listeners para los botones
        sendButton.addEventListener('click', () => {
            const prompt = userInput.value.trim();
            if (prompt) {
                processPrompt(prompt);
                userInput.value = '';
            }
        });

        dictateButton.addEventListener('click', () => {
            if (typeof SpeechRecognition !== 'undefined' || typeof webkitSpeechRecognition !== 'undefined') {
                recognition = new (SpeechRecognition || webkitSpeechRecognition)();
                recognition.lang = 'es-MX';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                dictateButton.classList.add('animate-pulse');

                recognition.start();

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    userInput.value = speechResult;
                    dictateButton.classList.remove('animate-pulse');
                    processPrompt(speechResult);
                };

                recognition.onspeechend = () => {
                    recognition.stop();
                    dictateButton.classList.remove('animate-pulse');
                };

                recognition.onerror = (event) => {
                    console.error('Error de reconocimiento de voz:', event.error);
                    dictateButton.classList.remove('animate-pulse');
                };
            } else {
                alert('El reconocimiento de voz no es soportado por este navegador.');
            }
        });
        
        silenceButton.addEventListener('click', () => {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                video.pause();
                isVideoPlaying = false;
            }
        });

        clearButton.addEventListener('click', () => {
            textSection.innerHTML = '<p class="text-gray-500 italic">Aquí aparecerá el texto de la respuesta.</p>';
            tableSection.innerHTML = '<p class="text-gray-500 italic">Aquí se mostrarán las tablas y listados.</p>';
            userInput.value = '';
        });

        newSessionButton.addEventListener('click', () => {
            sessionData = []; // Borra el contexto
            clearButton.click(); // Usa la función del botón de limpiar
            // Aquí se enviaría una solicitud al backend para borrar la sesión
            alert("Nueva sesión iniciada. El contexto de la memoria ha sido borrado.");
        });

        historyButton.addEventListener('click', () => {
            window.location.href = "histo.html";
        });
        
        exportButton.addEventListener('click', () => {
            // Lógica para exportar a PDF, DOC, o XLS
            alert("La funcionalidad de exportar se encuentra en desarrollo.");
        });

        window.onload = () => {
            window.speechSynthesis.getVoices();
        };

    </script>
</body>
</html>
