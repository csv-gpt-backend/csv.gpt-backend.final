<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lexium ‚Äî Consultas 1807</title>
<style>
  :root{--bg:#fff;--fg:#111;--muted:#6b7280;--pri:#0d6efd;--bd:#e5e7eb;--err:#b91c1c}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1180px;margin:0 auto;padding:12px}

  /* Cabecera fija (video + logos + controles) */
  .hero{position:sticky;top:0;background:#fff;z-index:5;padding-top:4px;border-bottom:1px solid var(--bd)}
  .heroGrid{display:grid;grid-template-columns:1fr 3fr 1fr;align-items:center;gap:8px}
  .sideImg{display:flex;justify-content:center}
  .sideImg img{max-width:92%;height:auto;object-fit:contain;opacity:.95}
  .videoBox video{width:100%;height:auto;border:none;display:block;border-radius:10px}

  .toolbar{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin:8px 0}
  .toolbar button,.toolbar select{padding:9px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer}
  .toolbar button[disabled]{opacity:.6;cursor:not-allowed}

  /* Caja de pregunta en 1 sola l√≠nea */
  .query{width:100%;height:40px;border:1px solid var(--bd);border-radius:10px;padding:10px 12px;font-size:16px}

  /* √Årea de respuesta (scroll solo aqu√≠) */
  .out{margin:8px 0;border:1px solid var(--bd);border-radius:12px;padding:12px;overflow:auto;max-height:calc(100vh - 290px)}
  table{width:100%;border-collapse:collapse;margin:10px 0}
  th,td{border:1px solid var(--bd);padding:8px}
  th{background:#f8fafc;text-align:left}

  /* Burbuja de estado fija (arriba-izquierda) */
  .statusDock{position:fixed;top:10px;left:12px;z-index:9999;pointer-events:none}
  #status{min-width:140px;display:none;background:#fff;border:1px solid var(--bd);border-radius:10px;padding:6px 10px;box-shadow:0 2px 8px rgba(0,0,0,.06);color:var(--muted)}
  .loader{display:inline-flex;align-items:center;gap:8px;font-size:.95rem}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--pri);opacity:.8;animation:bounce 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
  @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

  .err{color:var(--err);white-space:pre-wrap}
  .hist{position:fixed;right:14px;top:10px;z-index:9999}
  .hist button{padding:8px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff}
</style>
</head>
<body>
<div class="wrap">
  <!-- Historial -->
  <div class="hist"><button id="btnHist">Historial</button></div>

  <!-- Cabecera (logos + video + controles) -->
  <div class="hero" aria-label="cabecera">
    <div class="heroGrid">
      <div class="sideImg"><img src="left.png" alt="Logo izquierdo"></div>
      <div class="videoBox">
        <video id="vid" preload="auto" muted playsinline src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"></video>
      </div>
      <div class="sideImg"><img src="right.png" alt="Logo derecho" style="transform:scale(1.03)"></div>
    </div>

    <div style="margin:8px 0">
      <input id="q" class="query" placeholder="ESCRIBE O HABLA PARA PREGUNTAR‚Ä¶" />
    </div>

    <div class="toolbar">
      <button id="btnSend">Enviar</button>
      <button id="btnDict">üé§ Dictar</button>
      <button id="btnToggleAV">‚èØ Reanudar voz</button>
      <button id="btnReplay">‚ü≥ Reproducir</button>
      <button id="btnNew">Ôºã Nueva sesi√≥n</button>
      <button id="btnClear">üßπ Limpiar</button>
      <select id="selExport">
        <option value="">Exportar‚Ä¶</option>
        <option value="pdf">PDF (vista previa)</option>
        <option value="xls">XLS</option>
        <option value="doc">DOC</option>
      </select>
    </div>
  </div>

  <!-- Estado fijo arriba-izquierda -->
  <div class="statusDock"><div id="status"></div></div>

  <!-- Respuesta -->
  <div id="out" class="out" aria-live="polite"></div>
</div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://lexium-api-nqh4ai2hnq-tl.a.run.app"; // <‚Äî cambia si tu URL es otra
const GPT_PATH = "/api/gpt";
const FALLBACK_PATH = "/api/answer";
const HEALTH_TIMEOUT_MS = 4000;
const CLIENT_TIMEOUT_MS = 15000;
const MAX_TRIES = 2;

/* ====== UI refs ====== */
const q = document.getElementById("q");
const out = document.getElementById("out");
const statusBox = document.getElementById("status");
const vid = document.getElementById("vid");
const btnSend = document.getElementById("btnSend");
const btnDict = document.getElementById("btnDict");
const btnToggleAV = document.getElementById("btnToggleAV");
const btnReplay = document.getElementById("btnReplay");
const btnNew = document.getElementById("btnNew");
const btnClear = document.getElementById("btnClear");
const selExport = document.getElementById("selExport");
const btnHist = document.getElementById("btnHist");

/* ====== Estado petici√≥n/voz ====== */
let voices = [], currentVoice = null, speaking = false, paused = false, lastSpokenText = "";
let recognizer = null;
let inFlightAbort = null;
let sendLabel = btnSend.textContent;

/* ====== Estado (arriba-izquierda) ====== */
function setStatusLoading(msg="Consultando‚Ä¶"){
  statusBox.style.display = "block";
  statusBox.innerHTML = `<span class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span>${msg}</span>`;
}
function setStatusText(msg){
  statusBox.style.display = "block";
  statusBox.textContent = msg;
}
function clearStatus(){ statusBox.style.display="none"; statusBox.textContent=""; }

/* ====== Bot√≥n Enviar: bloqueo consistente ====== */
function setUiBusy(busy){
  btnSend.disabled = !!busy;
  btnSend.textContent = busy ? "Enviando‚Ä¶" : sendLabel;
}

/* ====== Voz ====== */
function pickSpanishFemale(){
  voices = (typeof speechSynthesis !== "undefined") ? speechSynthesis.getVoices() : [];
  const es = voices.filter(v=>/^es(-|_)?/i.test(v.lang||""));
  let fem = es.find(v=>/female|femenina|mujer|M√≥nica|Monica|Conchita|Lucia/i.test(v.name||""));
  currentVoice = fem || es[0] || voices[0] || null;
}
if (typeof speechSynthesis !== "undefined") {
  pickSpanishFemale();
  window.speechSynthesis.onvoiceschanged = pickSpanishFemale;
}
function speak(text){
  if (!text || typeof speechSynthesis === "undefined") return;
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  lastSpokenText = text;
  const u = new SpeechSynthesisUtterance(text);
  if (currentVoice) u.voice = currentVoice;
  u.lang = (currentVoice && currentVoice.lang) || "es-ES";
  u.rate = 1; u.pitch = 1; u.volume = 1;
  u.onstart = ()=>{ speaking = true; paused = false; vid.play().catch(()=>{}); };
  u.onend = ()=>{ speaking = false; vid.pause(); };
  u.onerror = ()=>{ speaking = false; vid.pause(); };
  speechSynthesis.speak(u);
}
function toggleAV(){
  if (!speechSynthesis) return;
  if (speaking && !paused){ speechSynthesis.pause(); paused = true; vid.pause(); }
  else if (speaking && paused){ speechSynthesis.resume(); paused = false; vid.play().catch(()=>{}); }
  else { speak(lastSpokenText); }
}
function replay(){ if (speechSynthesis?.speaking) speechSynthesis.cancel(); speak(lastSpokenText); }

/* ====== Utils ====== */
function esc(x){ return String(x).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }

/* ====== Render ====== */
function renderAnswer(data){
  let html = "";
  if (data.general) html += `<p>${esc(data.general).replace(/\n/g,"<br>")}</p>`;
  (data.lists||[]).forEach((l,i)=>{
    const title = l.title || `Lista ${i+1}`;
    html += `<h3>${esc(title)}</h3><ol>` + (l.items||[]).map(it=>`<li>${esc(it)}</li>`).join("") + `</ol>`;
  });
  (data.tables||[]).forEach(t=>{
    const cols = t.columns||[], rows=t.rows||[];
    html += `<h3>${esc(t.title||"Tabla")}</h3><table><thead><tr>`;
    html += cols.map(c=>`<th>${esc(c)}</th>`).join("") + `</tr></thead><tbody>`;
    rows.forEach(r=>{ html += `<tr>` + r.map(x=>`<td>${esc(x)}`).join("") + `</td></tr>`; });
    html += `</tbody></table>`;
  });
  out.innerHTML = html || "<em>Sin contenido.</em>";
  if (data.general) speak(data.general);
}

/* ====== Historial ====== */
function saveSession(question, data){
  const key="lexium_sessions"; const all = JSON.parse(localStorage.getItem(key)||"[]");
  all.unshift({ts:new Date().toISOString(), q:question, data});
  localStorage.setItem(key, JSON.stringify(all.slice(0,50)));
}
function openHistory(){
  const key="lexium_sessions"; const all = JSON.parse(localStorage.getItem(key)||"[]");
  if (!all.length){ alert("Sin historial."); return; }
  const w = window.open("", "_blank","noopener,noreferrer");
  w.document.write(`<html><head><title>Historial</title><style>body{font:14px system-ui} pre{white-space:pre-wrap}</style></head><body>
  <h2>Sesiones</h2>
  ${all.map(s=>`<details><summary><b>${esc(s.ts)}</b> ‚Äî ${esc(s.q)}</summary><pre>${esc(JSON.stringify(s.data,null,2))}</pre></details>`).join("")}
  </body></html>`);
  w.document.close();
}

/* ====== Dictado ====== */
function toggleDict(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR){ alert("Dictado no soportado en este navegador."); return; }
  if (!recognizer){
    recognizer = new SR();
    recognizer.lang = "es-ES";
    recognizer.onresult = e => { const t=[...e.results].map(r=>r[0].transcript).join(" "); q.value = (q.value? q.value+" " :"")+t; };
  }
  if (recognizer.listening){ recognizer.stop(); recognizer.listening=false; btnDict.textContent="üé§ Dictar"; }
  else { recognizer.start(); recognizer.listening=true; btnDict.textContent="‚èπ Detener dictado"; }
}

/* ====== fetch con timeout ====== */
function fetchWithTimeout(url, opts={}, ms=15000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  const merged = { ...opts, signal: ctrl.signal };
  return { promise: fetch(url, merged).finally(()=>clearTimeout(t)), abort: ()=>ctrl.abort() };
}

/* Ping r√°pido */
async function preflight(){
  const { promise } = fetchWithTimeout(`${API_BASE}/healthz`, {}, HEALTH_TIMEOUT_MS);
  const r = await promise.catch(()=>null);
  return !!(r && r.ok);
}

/* ====== Enviar ====== */
async function ask(){
  if (btnSend.disabled) return;                 // evita doble clic
  const text = q.value.trim(); if (!text) return;

  // cancela petici√≥n anterior si hubiera
  if (inFlightAbort){ inFlightAbort(); inFlightAbort = null; }

  setUiBusy(true);
  if (speechSynthesis?.speaking) speechSynthesis.cancel();
  out.innerHTML = "";
  setStatusLoading("Consultando‚Ä¶");

  try{
    // health check
    const ok = await preflight();
    if (!ok){ out.innerHTML = `<pre class="err">El servicio no responde (healthz).</pre>`; return; }

    let lastErr = null;
    for (let i=1;i<=MAX_TRIES;i++){
      setStatusLoading(i===1 ? "Consultando‚Ä¶" : `Reintentando‚Ä¶ (${i}/${MAX_TRIES})`);
      const { promise, abort } = fetchWithTimeout(`${API_BASE}${GPT_PATH}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json","Accept":"application/json" },
        body: JSON.stringify({ q: text })
      }, CLIENT_TIMEOUT_MS);
      inFlightAbort = abort;

      let r;
      try{ r = await promise; }catch(e){ lastErr = e; }

      // Fallback si /api/gpt no existe
      if (r && (r.status===404 || r.status===405)){
        try{
          const f = fetchWithTimeout(`${API_BASE}${FALLBACK_PATH}?q=${encodeURIComponent(text)}`, {}, CLIENT_TIMEOUT_MS);
          inFlightAbort = f.abort;
          r = await f.promise;
        }catch(e){ lastErr = e; }
      }

      try{
        if (r && r.ok){
          const data = await r.json();
          saveSession(text, data);
          renderAnswer(data);
          clearStatus();
          return;
        }
      }catch(e){ lastErr = e; }
    }
    const msg = `No se pudo conectar con el servicio.\nDetalle: ${lastErr?.name||"Error"}: ${lastErr?.message||String(lastErr)}`;
    out.innerHTML = `<pre class="err">${esc(msg)}</pre>`;
  } finally {
    // siempre desbloquea
    setUiBusy(false);
    clearStatus();
    inFlightAbort = null;
  }
}

/* ====== Eventos ====== */
btnSend.addEventListener("click", ask);
q.addEventListener("keydown", e=>{ if (e.key==="Enter") ask(); });
btnDict.addEventListener("click", toggleDict);
btnToggleAV.addEventListener("click", toggleAV);
btnReplay.addEventListener("click", replay);
btnHist.addEventListener("click", openHistory);

/* Limpiar / Nueva sesi√≥n tambi√©n cancelan todo y desbloquean */
function haltAll(){
  if (speechSynthesis?.speaking) speechSynthesis.cancel();
  if (inFlightAbort){ inFlightAbort(); inFlightAbort=null; }
  setUiBusy(false); clearStatus();
}
btnClear.addEventListener("click", ()=>{ q.value=""; out.innerHTML=""; haltAll(); });
btnNew.addEventListener("click", ()=>{ q.value=""; out.innerHTML=""; haltAll(); });

/* Exportar */
selExport.addEventListener("change", ()=>{
  const v = selExport.value; selExport.value="";
  if (!out.innerHTML.trim()){ alert("No hay contenido que exportar."); return; }
  if (v==="pdf"){
    const w = window.open("","_blank","noopener,noreferrer");
    w.document.write(`<html><head><title>Export PDF</title></head><body>${out.innerHTML}</body></html>`);
    w.document.close(); w.focus(); w.print();
  }else if (v==="xls" || v==="doc"){
    const mime = v==="xls" ? "application/vnd.ms-excel" : "application/msword";
    const blob = new Blob([`<html><body>${out.innerHTML}</body></html>`], {type:mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `export.${v}`;
    a.click(); URL.revokeObjectURL(a.href);
  }
});
</script>
</body>
</html>
