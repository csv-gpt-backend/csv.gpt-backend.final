<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistente Lexium 1311</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f7f9fb;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #002b5c;
      color: white;
      padding: 5px 20px;
    }

    header img {
      height: 60px;
    }

    header video {
      height: 100px;
      border-radius: 10px;
      object-fit: cover;
    }

    #content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    #chat {
      max-width: 900px;
      margin: 0 auto;
      font-size: 14px;
    }

    .user, .bot {
      margin: 10px 0;
      padding: 10px 14px;
      border-radius: 10px;
      line-height: 1.5;
    }

    .user {
      background: #d8e6ff;
      align-self: flex-end;
    }

    .bot {
      background: #fff;
      border: 1px solid #ddd;
    }

    #inputBar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: #e9eef3;
      border-top: 1px solid #ccc;
    }

    #q {
      width: 60%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #bbb;
      font-size: 14px;
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 10px 12px;
      cursor: pointer;
      background: #004aad;
      color: white;
      font-weight: 600;
    }

    button:hover {
      background: #003b8a;
    }

    #loader {
      display: none;
      text-align: center;
      padding: 10px;
      font-weight: bold;
      color: #004aad;
    }

    #options {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 8px;
      font-size: 13px;
    }

    #options button {
      background: #f0f3f7;
      color: #333;
      border: 1px solid #bbb;
    }

    iframe {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <img src="left.png" alt="Izquierda">
    <video id="heroVideo" src="hero.mp4" autoplay muted loop></video>
    <img src="right.png" alt="Derecha">
  </header>

  <div id="content">
    <div id="chat"></div>
    <div id="loader">Consultando‚Ä¶</div>
  </div>

  <div id="inputBar">
    <input id="q" type="text" placeholder="ESCRIBE O HABLA PARA PREGUNTAR‚Ä¶" />
    <button id="send">Enviar</button>
    <button id="mic">üé§ Dictar</button>
    <button id="tts">‚èØ Activar voz</button>
  </div>

  <div id="options">
    <button id="replay">‚ü≥ Reproducir</button>
    <button id="new">Ôºã Nueva sesi√≥n</button>
    <button id="clear">üßπ Limpiar</button>
    <button id="export">üìÑ Exportar‚Ä¶</button>
  </div>

  <iframe id="preview"></iframe>

  <script>
    // ‚öôÔ∏è Cambia esta URL al √∫ltimo deployment activo de Cloud Run
    const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app";

    const chat = document.getElementById("chat");
    const input = document.getElementById("q");
    const loader = document.getElementById("loader");
    const video = document.getElementById("heroVideo");
    let speaking = false, voices = [], currentUtterance = null;

    // üîä TTS
    function speak(text) {
      stopSpeech();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "es-ES";
      utter.voice = speechSynthesis.getVoices().find(v => v.lang.startsWith("es"));
      utter.onstart = () => { speaking = true; video.play(); };
      utter.onend = () => { speaking = false; video.pause(); };
      speechSynthesis.speak(utter);
      currentUtterance = utter;
    }

    function stopSpeech() {
      if (speaking) speechSynthesis.cancel();
      speaking = false;
      video.pause();
    }

    // üó£ Dictado
    let recognizing = false;
    let recognition;
    if ("webkitSpeechRecognition" in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "es-ES";
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onresult = e => {
        input.value = e.results[0][0].transcript;
        send();
      };
    }

    document.getElementById("mic").onclick = () => {
      if (recognizing) {
        recognition.stop();
        recognizing = false;
      } else {
        recognition.start();
        recognizing = true;
      }
    };

    // üí¨ Env√≠o
    document.getElementById("send").onclick = send;
    input.addEventListener("keypress", e => { if (e.key === "Enter") send(); });

    async function send() {
      const q = input.value.trim();
      if (!q) return;
      append("user", q);
      input.value = "";
      loader.style.display = "block";
      stopSpeech();

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 45000);

      try {
        // Hedged request: intenta /api/gpt primero
        const r1 = fetch(`${API_BASE}/api/gpt`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ q }),
          signal: controller.signal,
        }).then(r => r.ok ? r.text() : Promise.reject());

        const r2 = fetch(`${API_BASE}/api/answer?q=${encodeURIComponent(q)}`, { signal: controller.signal })
                    .then(r => r.ok ? r.text() : Promise.reject());

        const text = await Promise.any([r1, r2]);
        append("bot", text);
        speak(text);
      } catch (err) {
        append("bot", "‚ö†Ô∏è No hay respuesta del servidor");
      } finally {
        loader.style.display = "none";
        clearTimeout(timeout);
      }
    }

    function append(role, text) {
      const div = document.createElement("div");
      div.className = role;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // üßπ Opciones
    document.getElementById("tts").onclick = () => speaking ? stopSpeech() : speak(lastBot());
    document.getElementById("replay").onclick = () => speak(lastBot());
    document.getElementById("new").onclick = () => location.reload();
    document.getElementById("clear").onclick = () => { chat.innerHTML = ""; localStorage.clear(); };
    document.getElementById("export").onclick = () => exportar();

    function lastBot() {
      const bots = [...document.querySelectorAll(".bot")];
      return bots.length ? bots[bots.length - 1].textContent : "";
    }

    // üìÑ Exportar
    function exportar() {
      const text = chat.innerText.replace(/\n\n/g, "\n");
      const blob = new Blob([text], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "conversacion.txt";
      a.click();
    }

    window.speechSynthesis.onvoiceschanged = () => {
      voices = speechSynthesis.getVoices();
    };
  </script>
</body>
</html>
