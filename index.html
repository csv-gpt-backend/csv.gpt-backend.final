<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistente Lexium</title>
<style>
  body {
    font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0;
  }
  header {
    position: fixed; top: 0; left: 0; right: 0; height: 160px;
    display: flex; align-items: center; justify-content: center;
    background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10;
  }
  header img.side { width: 100px; height: auto; }
  header video { width: 320px; height: auto; border-radius: 10px; }
  main {
    margin-top: 170px; padding: 20px;
    max-width: 900px; margin-left: auto; margin-right: auto;
  }
  #processing {
    position: fixed; top: 8px; left: 12px;
    background: #ffc107; color: #000; padding: 4px 8px;
    border-radius: 4px; font-weight: bold; display: none; z-index: 20;
  }
  #output { font-size: 14px; background: #fff; padding: 10px; border-radius: 8px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 13px; }
  th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: left; }
  th { background: #eee; }
  #controls { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
  button { cursor: pointer; }
  #historyModal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: none; align-items: center; justify-content: center;
  }
  #historyModal div {
    background: white; padding: 20px; width: 600px; max-height: 80vh;
    overflow-y: auto; border-radius: 8px;
  }
</style>
</head>
<body>
<div id="processing">Consultando‚Ä¶</div>
<header>
  <img src="left.png" class="side">
  <video id="heroVideo" src="hero.mp4" autoplay muted loop></video>
  <img src="right.png" class="side">
</header>
<main>
  <div>
    <input id="userInput" type="text" placeholder="ESCRIBE O HABLA PARA PREGUNTAR‚Ä¶" style="width:70%;padding:8px;font-size:14px;">
    <button id="btnSend">Enviar</button>
    <button id="btnDict">üé§ Dictar</button>
    <button id="btnPlayPause">‚èØ Pausar/Reanudar voz</button>
    <button id="btnReplay">‚ü≥ Reproducir</button>
    <button id="btnNew">Ôºã Nueva sesi√≥n</button>
    <button id="btnHistory">üïì Historial</button>
  </div>
  <div id="output"></div>
  <div id="controls">
    <button id="btnExportPDF">üìÑ Exportar PDF</button>
    <button id="btnExportDOC">üìù Exportar DOC</button>
    <button id="btnExportXLS">üìä Exportar XLS</button>
  </div>
</main>

<!-- Historial -->
<div id="historyModal">
  <div>
    <h3>Historial de Sesi√≥n</h3>
    <div id="historyList"></div>
    <button id="btnCloseHist">Cerrar</button>
    <button id="btnClearHist">üßπ Borrar todo</button>
    <button id="btnDownloadHist">‚¨áÔ∏è Descargar</button>
  </div>
</div>

<script>
const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app";
const FALLBACK_PATH = "/api/answer";
const STORAGE_KEY = "lexium_sessions_v2";

let currentSession = [];
let sessionContext = {}; // recuerda √∫ltimo estudiante o tema
let voices, voice;
const synth = window.speechSynthesis;

/* --- Inicializaci√≥n de voz --- */
function initVoices() {
  voices = synth.getVoices();
  voice = voices.find(v => v.lang.startsWith("es") && /female/i.test(v.name)) || voices[0];
}
window.speechSynthesis.onvoiceschanged = initVoices;
initVoices();

/* --- Loader --- */
function showProcessing(show=true){ 
  document.getElementById("processing").style.display = show ? "block" : "none";
}

/* --- Render y TTS --- */
function renderAnswer(data){
  const out = document.getElementById("output");
  let html = `<p><strong>Respuesta:</strong> ${data.general||""}</p>`;
  (data.lists||[]).forEach((list,i)=>{
    if(Array.isArray(list.items)){
      html += `<h4>${list.title||("Lista "+(i+1))}</h4><ol>`;
      list.items.forEach(it=>{html+=`<li>${it}</li>`;});
      html+="</ol>";
    } else if(Array.isArray(list)){
      html+=`<ol>`;
      list.forEach(it=>{html+=`<li>${it}</li>`;});
      html+="</ol>";
    }
  });
  (data.tables||[]).forEach(t=>{
    html += `<h4>${t.title||""}</h4><table><thead><tr>${t.columns.map(c=>`<th>${c}</th>`).join("")}</tr></thead><tbody>`;
    t.rows.forEach((r,i)=>{
      html += `<tr><td>${i+1}</td>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`;
    });
    html += `</tbody></table>`;
  });
  out.innerHTML = html;

  // reproducir voz completa
  let textToRead = `${data.general}. `;
  (data.lists||[]).forEach(l=>{
    if(l.title) textToRead += l.title + ". ";
    const items = l.items || l;
    items.forEach((it,i)=> textToRead += `${i+1}. ${it}. `);
  });
  (data.tables||[]).forEach(t=>{
    textToRead += `${t.title}. `;
    t.rows.forEach((r,i)=> textToRead += `${i+1}. ${r.join(", ")}. `);
  });
  speak(textToRead);
}

/* --- Voz --- */
function speak(txt){
  synth.cancel();
  if(!txt) return;
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = "es-MX"; u.voice = voice; u.rate = 1; u.pitch = 1;
  synth.speak(u);
}
function pauseResume(){
  if(synth.speaking){
    if(synth.paused) synth.resume(); else synth.pause();
  }
}

/* --- Enviar pregunta --- */
async function ask(){
  const btn = document.getElementById("btnSend");
  const inp = document.getElementById("userInput");
  const text = inp.value.trim();
  if(!text || btn.disabled) return;
  btn.disabled = true; showProcessing(true);
  try{
    const enriched = sessionContext.lastStudent ? `${text}. (Contexto: estudiante ${sessionContext.lastStudent})` : text;
    const r = await fetch(`${API_BASE}${FALLBACK_PATH}?q=${encodeURIComponent(enriched)}`, {headers:{"Accept":"application/json"}});
    const data = await r.json();
    renderAnswer(data);
    currentSession.push({question:text, answer:data});
    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSession));
    // actualizar contexto si detecta nombre
    const match = text.match(/estudiante\s+([A-Za-z√Å√â√ç√ì√ö√ë√°√©√≠√≥√∫\s]+)/i);
    if(match) sessionContext.lastStudent = match[1].trim();
  }catch(e){alert("Error: "+e);}
  finally{btn.disabled=false; showProcessing(false);}
}

/* --- Historial --- */
function showHistory(){
  const modal = document.getElementById("historyModal");
  const list = document.getElementById("historyList");
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
  list.innerHTML = data.map((qa,i)=>`<p><b>${i+1}. ${qa.question}</b><br>${qa.answer.general}</p>`).join("");
  modal.style.display="flex";
}
function closeHistory(){document.getElementById("historyModal").style.display="none";}
function clearHistory(){localStorage.removeItem(STORAGE_KEY);currentSession=[];alert("Historial borrado");}
function downloadHistory(){
  const data = localStorage.getItem(STORAGE_KEY)||"";
  const blob = new Blob([data],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="historial_lexium.json"; a.click();
}

/* --- Exportar --- */
function exportAll(format){
  const session = JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
  if(!session.length){alert("No hay contenido");return;}
  let text="";
  session.forEach((qa,i)=>{
    text += `\n${i+1}. PREGUNTA: ${qa.question}\nRESPUESTA:\n${qa.answer.general}\n`;
  });
  const blob = new Blob([text],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`reporte_lexium.${format}`;
  a.click();
}

/* --- Enlaces --- */
async function checkLinks(){
  const links = document.querySelectorAll("a");
  for(const l of links){
    try{
      const res = await fetch(l.href,{method:"HEAD"});
      if(!res.ok) l.style.color="gray";
    }catch{ l.style.color="gray"; }
  }
}

/* --- Eventos --- */
document.getElementById("btnSend").onclick = ask;
document.getElementById("btnPlayPause").onclick = pauseResume;
document.getElementById("btnReplay").onclick = ()=>speak(document.getElementById("output").innerText);
document.getElementById("btnNew").onclick = ()=>{sessionContext={};currentSession=[];localStorage.removeItem(STORAGE_KEY);document.getElementById("output").innerHTML="";};
document.getElementById("btnHistory").onclick = showHistory;
document.getElementById("btnCloseHist").onclick = closeHistory;
document.getElementById("btnClearHist").onclick = clearHistory;
document.getElementById("btnDownloadHist").onclick = downloadHistory;
document.getElementById("btnExportPDF").onclick = ()=>exportAll("pdf");
document.getElementById("btnExportDOC").onclick = ()=>exportAll("doc");
document.getElementById("btnExportXLS").onclick = ()=>exportAll("xls");
</script>
</body>
</html>
