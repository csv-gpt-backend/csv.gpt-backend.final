<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lexium ¬∑ Chat</title>
  <style>
    :root{
      --bg:#0b0f17;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#38bdf8;--ok:#22c55e;
      --warn:#f59e0b;--danger:#ef4444;--border:#273244;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--muted);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn.primary{background:var(--accent);color:#001018;border-color:#22a5dc}
    .btn.ok{background:var(--ok);color:#001008;border-color:#149a46}
    .btn.ghost{background:transparent}
    .tag{font-size:12px;opacity:.75}
    textarea{width:100%;min-height:92px;resize:vertical;background:#0f1522;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px;outline:none}
    .chat{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .bubble{padding:12px 14px;border-radius:12px;border:1px solid var(--border)}
    .bubble.user{background:#132034}
    .bubble.ai{background:#121e17}
    .split{display:grid;grid-template-columns:1fr 320px;gap:14px}
    .panel{position:sticky;top:12px}
    .hlist{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
    .hitem{padding:10px;border:1px dashed var(--border);border-radius:10px;background:#0f1624}
    .hitem small{opacity:.6}
    .muted{opacity:.8}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .dropdown{position:relative;display:inline-block}
    .menu{position:absolute;z-index:10;min-width:220px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px;margin-top:6px;display:none}
    .menu.show{display:block}
    .menu .item{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;cursor:pointer}
    .menu .item:hover{background:var(--muted)}
    .right{margin-left:auto}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    /* Modal simple para PDF preview y para Historial en pantallas peque√±as */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.show{display:flex}
    .modal .box{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:900px;width:100%;max-height:85vh;display:flex;flex-direction:column}
    .box header, .box footer{padding:10px 12px;border-bottom:1px solid var(--border)}
    .box footer{border-top:1px solid var(--border);border-bottom:none}
    .box .content{padding:0 12px 12px 12px;overflow:auto}
    iframe.pdf{width:100%;height:70vh;border:0;border-radius:10px}
    @media (max-width:980px){.split{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <h2 style="margin:0">Lexium ¬∑ Chat</h2>
      <span class="tag">Cloud Run servicio: <span class="mono">lexium-gpt5</span></span>
      <div class="right toolbar">
        <button id="btnHistorial" class="btn">üïò Historial</button>
        <div class="dropdown">
          <button id="btnExportar" class="btn">‚¨áÔ∏è Exportar‚Ä¶</button>
          <div id="menuExportar" class="menu" role="menu" aria-labelledby="btnExportar">
            <div class="item" data-export="word">üìù Exportar a Word (.doc)</div>
            <div class="item" data-export="pdf">üìÑ Exportar a PDF (con preview)</div>
            <div class="item" data-export="csv">üßæ Exportar a CSV (.csv)</div>
          </div>
        </div>
        <button id="btnLimpiar" class="btn ghost">üßπ Limpiar</button>
      </div>
    </div>

    <div class="split">
      <main class="card">
        <label class="sr" for="prompt">Pregunta</label>
        <textarea id="prompt" placeholder="Escribe tu pregunta... (Ctrl+Enter para enviar)"></textarea>

        <div class="toolbar" style="margin-top:10px">
          <button id="btnEnviar" class="btn primary">Enviar</button>
          <button id="btnDictado" class="btn">üé§ Dictar</button>
          <button id="btnToggleVoz" class="btn">‚èØ Activar voz</button>
          <button id="btnReproducir" class="btn">‚ü≥ Reproducir</button>
          <button id="btnNueva" class="btn">Ôºã Nueva sesi√≥n</button>
          <span id="estado" class="tag">Listo</span>
        </div>

        <div class="divider"></div>

        <section id="chat" class="chat" aria-live="polite" aria-busy="false"></section>

        <audio id="tts" preload="auto"></audio>
      </main>

      <aside class="panel">
        <div class="card">
          <b>Sesi√≥n</b>
          <div class="muted">ID: <span id="sid" class="mono"></span></div>
          <div class="muted">Mensajes: <span id="count">0</span></div>
          <div class="muted">Voz: <span id="vozLabel">desactivada</span></div>
        </div>
        <div class="card">
          <b>Historial (vista r√°pida)</b>
          <div id="histShort" class="hlist"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal Historial (modo lista completa en m√≥viles) -->
  <div id="modalHistorial" class="modal" role="dialog" aria-modal="true" aria-labelledby="ttlHist">
    <div class="box">
      <header>
        <b id="ttlHist">Historial de conversaciones</b>
      </header>
      <div class="content">
        <div id="histFull" class="hlist"></div>
      </div>
      <footer class="row">
        <button id="btnCerrarHist" class="btn">Cerrar</button>
        <span class="right tag">Guardado local en tu navegador</span>
      </footer>
    </div>
  </div>

  <!-- Modal PDF Preview -->
  <div id="modalPDF" class="modal" role="dialog" aria-modal="true" aria-labelledby="ttlPDF">
    <div class="box">
      <header class="row">
        <b id="ttlPDF">Vista previa PDF</b>
        <a id="lnkPDF" class="btn right" href="#" download="lexium_chat.pdf">Descargar PDF</a>
      </header>
      <div class="content">
        <iframe class="pdf" id="pdfFrame"></iframe>
      </div>
      <footer class="row">
        <button id="btnCerrarPDF" class="btn">Cerrar</button>
      </footer>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    // ‚õ≥ ACTUALIZA ESTA URL con tu endpoint de Cloud Run:
    const API_BASE = "https://TU-SERVICIO-a.run.app"; // p.ej. https://lexium-gpt5-xxxxx.a.run.app

    // ========= ESTADO GLOBAL =========
    const el = (id) => document.getElementById(id);
    const chatEl = el('chat');
    const ttsEl  = el('tts');
    const estadoEl = el('estado');
    const countEl = el('count');
    const sidEl = el('sid');
    const vozLabelEl = el('vozLabel');
    const histShortEl = el('histShort');
    const histFullEl  = el('histFull');

    let sessionId = makeId();
    let messages = []; // {role:'user'|'assistant', text, at}
    let voiceEnabled = false;
    let isSending = false; // üîí evita doble disparo
    let lastAudioBlobUrl = null;

    sidEl.textContent = sessionId;

    // ========= UTIL =========
    function makeId(){ return 'S' + Math.random().toString(36).slice(2,10); }
    function ts(){ return new Date().toISOString(); }

    function addMsg(role, text){
      messages.push({ role, text, at: ts() });
      renderChat();
      countEl.textContent = String(messages.length);
      persistHistory();
      refreshHistoryViews();
    }

    function bubble(role, text){
      const div = document.createElement('div');
      div.className = 'bubble ' + (role === 'user' ? 'user' : 'ai');
      div.innerText = text;
      return div;
    }

    function renderChat(){
      chatEl.innerHTML = '';
      messages.forEach(m => chatEl.appendChild(bubble(m.role, m.text)));
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setEstado(txt){ estadoEl.textContent = txt; }

    // ========= HISTORIAL (LocalStorage) =========
    const LS_KEY = 'lexium_history_v2';
    function persistHistory(){
      // Guardamos como lista de sesiones, cada una con id y transcript
      const store = loadAllHistory();
      const idx = store.findIndex(s => s.sessionId === sessionId);
      const snap = { sessionId, at: ts(), transcript: messages };
      if (idx >= 0) store[idx] = snap; else store.unshift(snap);
      localStorage.setItem(LS_KEY, JSON.stringify(store).slice(0, 5_000_000)); // defensivo
    }
    function loadAllHistory(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      }catch{ return []; }
    }
    function refreshHistoryViews(){
      const all = loadAllHistory();
      // Vista corta (sidebar)
      histShortEl.innerHTML = '';
      all.slice(0,8).forEach(s => {
        const div = document.createElement('div');
        div.className = 'hitem';
        const firstQ = (s.transcript.find(m => m.role==='user')||{}).text || '(sin pregunta)';
        div.innerHTML = `<small class="mono">${s.sessionId}</small><br>${escapeHtml(firstQ).slice(0,120)}‚Ä¶`;
        div.title = s.sessionId;
        div.onclick = () => loadSession(s.sessionId);
        histShortEl.appendChild(div);
      });

      // Vista completa (modal)
      histFullEl.innerHTML = '';
      all.forEach(s => {
        const div = document.createElement('div');
        div.className = 'hitem';
        const human = new Date(s.at).toLocaleString();
        const preview = s.transcript.map(m => (m.role==='user'?'T√∫: ':'IA: ') + m.text).join('\n').slice(0,500);
        div.innerHTML = `<b>${s.sessionId}</b> ¬∑ <small>${human}</small><div class="muted" style="white-space:pre-wrap;margin-top:6px">${escapeHtml(preview)}${s.transcript.length>0?'‚Ä¶':''}</div>`;
        const row = document.createElement('div');
        row.className = 'row';
        const btnAbrir = mkBtn('Abrir', () => loadSession(s.sessionId));
        const btnBorrar = mkBtn('Eliminar', () => { deleteSession(s.sessionId); refreshHistoryViews(); });
        row.append(btnAbrir, btnBorrar);
        div.appendChild(row);
        histFullEl.appendChild(div);
      });
    }
    function deleteSession(id){
      const all = loadAllHistory().filter(s => s.sessionId !== id);
      localStorage.setItem(LS_KEY, JSON.stringify(all));
    }
    function loadSession(id){
      const found = loadAllHistory().find(s => s.sessionId === id);
      if(!found) return;
      sessionId = found.sessionId;
      messages = found.transcript || [];
      sidEl.textContent = sessionId;
      renderChat();
      setEstado('Sesi√≥n cargada');
      closeModal('modalHistorial');
    }
    function mkBtn(label, fn){
      const b = document.createElement('button');
      b.className = 'btn'; b.textContent = label; b.onclick = fn; return b;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    // ========= EXPORTACIONES =========
    function asPlainTranscript(){
      return messages.map(m => `[${m.role.toUpperCase()}] ${m.text}`).join('\n\n');
    }
    function exportWord(){
      // Mantiene el esquema viejo basado en HTML -> .doc (funcionaba perfecto)
      const html =
`<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head><meta charset="utf-8"><title>Lexium</title></head>
<body>
<h2>Lexium ¬∑ Sesi√≥n ${sessionId}</h2>
${messages.map(m => `<p><b>${m.role==='user'?'T√∫':'IA'}:</b> ${escapeHtml(m.text).replace(/\n/g,'<br>')}</p>`).join('\n')}
</body></html>`;
      const blob = new Blob([html], {type: 'application/msword'});
      const url = URL.createObjectURL(blob);
      download(url, `lexium_${sessionId}.doc`);
      URL.revokeObjectURL(url);
    }
    function exportPDF(){
      // Genera un PDF simple (sin librer√≠as externas) usando <iframe> + print-to-PDF compatible
      const html =
`<!doctype html><html><head><meta charset="utf-8"><style>
body{font:14px/1.45 -apple-system,Segoe UI,Roboto,Ubuntu,Arial;padding:20px}
.b{font-weight:bold} .mt{margin-top:8px}
</style></head><body>
<h2>Lexium ¬∑ Sesi√≥n ${sessionId}</h2>
${messages.map(m => `<div class="mt"><span class="b">${m.role==='user'?'T√∫':'IA'}:</span> ${escapeHtml(m.text).replace(/\n/g,'<br>')}</div>`).join('')}
</body></html>`;
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      // Mostramos preview en modal con iframe
      openModal('modalPDF');
      const frame = el('pdfFrame');
      frame.src = url;
      // Tambi√©n habilitamos descarga como .pdf via print-to-pdf (se descargar√° como HTML,
      // pero los visores modernos permiten "Imprimir" a PDF desde el preview).
      const dl = el('lnkPDF');
      dl.href = url;
    }
    function exportCSV(){
      // ‚úÖ Reemplaza Excel por CSV (con BOM para abrir bien en Excel)
      const rows = [['session_id','timestamp','role','text']];
      messages.forEach(m => rows.push([sessionId, m.at, m.role, m.text.replace(/\r?\n/g,' ') ]));
      const csv = rows.map(r => r.map(cell => {
        const s = String(cell).replace(/"/g,'""');
        return `"${s}"`;
      }).join(',')).join('\r\n');
      const BOM = '\ufeff'; // Byte Order Mark para Excel
      const blob = new Blob([BOM + csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      download(url, `lexium_${sessionId}.csv`);
      URL.revokeObjectURL(url);
      setEstado('CSV generado');
    }
    function download(url, filename){
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    }

    // ========= ENV√çO (un solo disparo) =========
    async function enviar(){
      if(isSending) return; // üîí evita doble disparo
      const prompt = el('prompt').value.trim();
      if(!prompt){ setEstado('Escribe una pregunta'); return; }

      try{
        isSending = true;
        lockUI(true);
        setEstado('Enviando‚Ä¶');
        addMsg('user', prompt);

        // Llamada al backend
        const res = await fetch(`${API_BASE}/chat`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            sessionId,
            messages, // el backend puede tomar el historial
          }),
        });

        if(!res.ok){
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        const text = data.text || '(sin texto)';
        addMsg('assistant', text);

        // TTS: soporta audioUrl directo o base64 { audioBase64, mime }
        if(voiceEnabled){
          await playTTS(data);
        }
        setEstado('Listo');
      }catch(err){
        console.error(err);
        setEstado('Error: ' + (err.message||''));
      }finally{
        lockUI(false);
        isSending = false; // üîì listo para siguiente env√≠o
      }
    }

    function lockUI(lock){
      el('btnEnviar').disabled = lock;
      el('btnDictado').disabled = lock;
      el('btnToggleVoz').disabled = lock;
      el('btnReproducir').disabled = lock || !lastAudioBlobUrl;
    }

    // ========= TTS =========
    async function playTTS(data){
      // Queremos lectura completa: esperamos canplay, luego reproducimos y resolvemos al terminar
      try{
        // limpiar anterior
        if(lastAudioBlobUrl){ URL.revokeObjectURL(lastAudioBlobUrl); lastAudioBlobUrl = null; }

        if(data.audioUrl){
          ttsEl.src = data.audioUrl;
        }else if(data.audioBase64){
          const mime = data.mime || 'audio/mpeg';
          const bin = b64ToArrayBuffer(data.audioBase64);
          const blob = new Blob([bin], {type: mime});
          lastAudioBlobUrl = URL.createObjectURL(blob);
          ttsEl.src = lastAudioBlobUrl;
        }else{
          // Si no viene audio, pedimos al endpoint /tts (opcional, si tu backend lo expone)
          const last = messages[messages.length-1]?.text || '';
          const tRes = await fetch(`${API_BASE}/tts`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text: last, sessionId })
          });
          if(tRes.ok){
            const b = await tRes.blob();
            lastAudioBlobUrl = URL.createObjectURL(b);
            ttsEl.src = lastAudioBlobUrl;
          }
        }

        await new Promise((resolve, reject) => {
          const onEnd=()=>{ cleanup(); resolve(); };
          const onErr=()=>{ cleanup(); reject(new Error('Fallo al reproducir TTS')); };
          const cleanup=()=>{
            ttsEl.removeEventListener('ended', onEnd);
            ttsEl.removeEventListener('error', onErr);
          };
          ttsEl.addEventListener('ended', onEnd, {once:true});
          ttsEl.addEventListener('error', onErr, {once:true});
          // Aseguramos que cargue antes de play
          ttsEl.oncanplay = ()=> { ttsEl.oncanplay = null; ttsEl.play().catch(onErr); };
          // Fallback si ya est√° listo
          if(ttsEl.readyState >= 2){ ttsEl.play().catch(onErr); }
        });
      }catch(e){
        console.warn('TTS warning:', e);
      }
    }
    function b64ToArrayBuffer(base64){
      const binary_string = atob(base64);
      const len = binary_string.length;
      const bytes = new Uint8Array(len);
      for (let i=0;i<len;i++){ bytes[i]=binary_string.charCodeAt(i); }
      return bytes.buffer;
    }

    // ========= UI: Eventos =========
    el('btnEnviar').addEventListener('click', enviar);

    // √öNICO manejador del form: Ctrl+Enter env√≠a; Enter inserta salto (evita doble disparo)
    el('prompt').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
        e.preventDefault();
        enviar();
      }
    });

    el('btnNueva').addEventListener('click', ()=>{
      sessionId = makeId();
      sidEl.textContent = sessionId;
      messages = [];
      renderChat();
      persistHistory();
      refreshHistoryViews();
      setEstado('Nueva sesi√≥n');
    });

    // Dictado (placeholder sin Web Speech para no multiplicar eventos)
    el('btnDictado').addEventListener('click', ()=>{
      alert('Dictado de voz: integraremos Web Speech o endpoint STT cuando lo indiques.');
    });

    // Voz on/off
    el('btnToggleVoz').addEventListener('click', ()=>{
      voiceEnabled = !voiceEnabled;
      vozLabelEl.textContent = voiceEnabled ? 'activada' : 'desactivada';
      el('btnToggleVoz').textContent = voiceEnabled ? '‚è∏ Desactivar voz' : '‚èØ Activar voz';
    });

    // Reproducir √∫ltimo audio
    el('btnReproducir').addEventListener('click', ()=>{
      if(ttsEl.src){ ttsEl.currentTime = 0; ttsEl.play().catch(()=>{}); }
    });

    // Limpiar chat actual
    el('btnLimpiar').addEventListener('click', ()=>{
      messages = [];
      renderChat();
      persistHistory();
      refreshHistoryViews();
      setEstado('Sesi√≥n vaciada');
    });

    // Exportar men√∫
    const menu = el('menuExportar');
    el('btnExportar').addEventListener('click', ()=>{
      menu.classList.toggle('show');
    });
    window.addEventListener('click', (e)=>{
      if(!e.target.closest('.dropdown')) menu.classList.remove('show');
    });
    menu.addEventListener('click', (e)=>{
      const item = e.target.closest('.item'); if(!item) return;
      const kind = item.dataset.export;
      if(kind==='word') exportWord();
      else if(kind==='pdf') exportPDF();
      else if(kind==='csv') exportCSV();
      menu.classList.remove('show');
    });

    // Historial bot√≥n: abre modal completo
    el('btnHistorial').addEventListener('click', ()=> openModal('modalHistorial'));
    el('btnCerrarHist').addEventListener('click', ()=> closeModal('modalHistorial'));

    // PDF modal
    el('btnCerrarPDF').addEventListener('click', ()=>{
      // Limpia el iframe para liberar URL
      const frame = el('pdfFrame');
      const old = frame.src; frame.src='about:blank';
      if(old.startsWith('blob:')) URL.revokeObjectURL(old);
      closeModal('modalPDF');
    });

    function openModal(id){ el(id).classList.add('show'); }
    function closeModal(id){ el(id).classList.remove('show'); }

    // Primera carga
    refreshHistoryViews();

  </script>
</body>
</html>
