<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asistente Lexium 1400</title>
<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#6b7280; --pri:#0d6efd; --bd:#e5e7eb;
    --heroH: 65vh; --wrapW: 1180px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  /* ===== Bloque superior fijo ===== */
  .mediaBar{position:fixed; top:0; left:0; width:100vw; z-index:50; background:#fff; pointer-events:none}
  .mediaBar *{pointer-events:none}
  .mediaInner{max-width:var(--wrapW); margin:0 auto; padding:12px;}
  .heroGrid{display:grid; grid-template-columns:1fr 3fr 1.16fr; align-items:center; gap:8px;}
  .sideImg{display:flex; justify-content:center; height:var(--heroH); margin:0;}
  .sideImg img{max-width:100%; height:100%; object-fit:contain; opacity:.95}
  .videoBox{height:var(--heroH); margin:0;}
  .videoBox video{width:100%; height:100%; object-fit:cover; display:block; border-radius:10px}
  /* ===== Contenido (scroll) ===== */
  .contentWrap{max-width:var(--wrapW); margin:0 auto; padding:12px; padding-top:calc(var(--heroH) + 8px);}
  .toolbar{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:8px 0}
  .toolbar button, .toolbar select{padding:9px 14px; border:1px solid var(--bd); border-radius:10px; background:#fff; cursor:pointer}
  .toolbar button:hover{background:#f5f7fb}
  .toolbar button[disabled]{opacity:.6; cursor:not-allowed}
  .hist{position:fixed; right:14px; top:10px; z-index:60}
  .hist button{padding:8px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff}
  .query{width:100%; height:42px; border:1px solid var(--bd); border-radius:10px; padding:10px 12px; font-size:16px; line-height:20px; box-sizing:border-box}
  .out{margin:8px 0; border:1px solid var(--bd); border-radius:12px; padding:12px; overflow:auto; white-space:pre-wrap; max-height:65vh}
  .muted{color:var(--muted); font-size:.9rem}
  table{width:100%; border-collapse:collapse; margin:10px 0}
  th,td{border:1px solid var(--bd); padding:8px}
  th{background:#f8fafc; text-align:left}
  .loader{display:inline-flex; align-items:center; gap:8px; font-size:.95rem; color:var(--muted)}
  .dot{width:8px; height:8px; border-radius:50%; background:var(--pri); opacity:.7; animation:bounce 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}
  .dot:nth-child(3){animation-delay:.3s}
  @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
  /* ===== Modal Historial ===== */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1000}
  .modal.show{display:flex}
  .panel{background:#fff; border-radius:14px; width:min(900px,92vw); max-height:86vh; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .panel header{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--bd)}
  .panel header h3{margin:0; font-size:18px}
  .panel .body{padding:12px 16px}
  .panel .actions{display:flex; gap:8px; align-items:center}
  .panel .actions button{padding:8px 10px; border:1px solid var(--bd); border-radius:10px; background:#fff; cursor:pointer}
  details{border:1px solid var(--bd); border-radius:10px; padding:8px 10px; margin:8px 0}
</style>
</head>
<body>

  <!-- Bot√≥n Historial -->
  <div class="hist">
    <button id="btnHist" title="Ver sesiones guardadas">Historial</button>
  </div>

  <!-- Bloque fijo -->
  <div class="mediaBar" aria-label="cabecera">
    <div class="mediaInner">
      <div class="heroGrid">
        <div class="sideImg left"><img src="left.png" alt="Logo izquierdo"/></div>
        <div class="videoBox"><video id="vid" preload="auto" muted playsinline src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"></video></div>
        <div class="sideImg right"><img src="right.png" alt="Logo derecho"/></div>
      </div>
    </div>
  </div>

  <!-- Contenido con scroll -->
  <div class="contentWrap">
    <div style="margin:10px 0 6px">
      <input id="q" class="query" type="text" placeholder="ESCRIBE O HABLA PARA PREGUNTAR‚Ä¶" autocomplete="off" />
    </div>

    <div class="toolbar">
      <button id="btnSend" title="Enviar consulta al backend">Enviar</button>
      <button id="btnDict" title="Dictar por voz (empieza / detiene)">üé§ Dictar</button>
      <button id="btnToggleAV" title="Parar/Activar voz">‚èØ Activar voz</button>
      <button id="btnReplay" title="Reproducir nuevamente la voz desde el principio">‚ü≥ Reproducir</button>
      <button id="btnNew" title="Nueva sesi√≥n (limpia y guarda la actual)">Ôºã Nueva sesi√≥n</button>
      <button id="btnClear" title="Limpiar pregunta y respuesta">üßπ Limpiar</button>
      <select id="selExport" title="Exportar lo generado (PDF muestra vista previa)">
        <option value="">Exportar‚Ä¶</option>
        <option value="pdf">PDF (vista previa)</option>
        <option value="xls">XLS</option>
        <option value="doc">DOC</option>
      </select>
    </div>

    <div id="out" class="out" aria-live="polite"></div>
    <div id="status" class="muted"></div>
  </div>

  <!-- Modal Historial -->
  <div id="histModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Historial">
      <header>
        <h3>Historial</h3>
        <div class="actions">
          <button id="btnHistDownload" title="Descargar historial JSON">‚¨áÔ∏è Descargar</button>
          <button id="btnHistClear" title="Borrar historial">üóëÔ∏è Borrar</button>
          <button id="btnHistClose" title="Cerrar">Cerrar ‚úñ</button>
        </div>
      </header>
      <div id="histBody" class="body"></div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://lexium-api-nqh4ai2hnq-tl.a.run.app".replace("https://lexium-api-nqh4ai2hnq-tl.a.run.app","https://lexium-api-nqh4ai2hnq-tl.a.run.app"); // tu Cloud Run
const PATH_ANSWER = "/api/answer";
const PATH_GPT_TOOLS = "/api/gpt?mode=tools";
const PATH_GPT_FREE  = "/api/gpt?mode=free";

/* ====== UI refs ====== */
const q = document.getElementById("q");
const out = document.getElementById("out");
const statusEl = document.getElementById("status");
const vid = document.getElementById("vid");
const btnSend = document.getElementById("btnSend");
const btnDict = document.getElementById("btnDict");
const btnToggleAV = document.getElementById("btnToggleAV");
const btnReplay = document.getElementById("btnReplay");
const btnNew = document.getElementById("btnNew");
const btnClear = document.getElementById("btnClear");
const selExport = document.getElementById("selExport");
const btnHist = document.getElementById("btnHist");
const histModal = document.getElementById("histModal");
const histBody = document.getElementById("histBody");
const btnHistClose = document.getElementById("btnHistClose");
const btnHistClear = document.getElementById("btnHistClear");
const btnHistDownload = document.getElementById("btnHistDownload");

/* ====== Utilidades ====== */
function esc(x){ return String(x).replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }
function setStatusLoading(msg="Consultando‚Ä¶"){ statusEl.innerHTML = `<span class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span>${esc(msg)}</span>`; }
function clearStatus(){ statusEl.textContent = ""; }
function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ====== Normalizador: acepta JSON o TEXTO ====== */
async function parseResp(resp){
  const ct = (resp.headers.get("content-type")||"").toLowerCase();
  if (ct.includes("application/json")) {
    try { return await resp.json(); } catch { return {}; }
  }
  const t = await resp.text().catch(()=> "");
  return t ? { general: t } : {};
}

/* ====== Render ====== */
function generalToHTML(g){
  if(!g) return "";
  const lines = g.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const bullet = /^(?:[‚Ä¢\-‚Äì*]|\d+\.)\s+/.test(lines[0]||"") || lines.length>=3;
  if(bullet){
    return `<ol>${lines.map(s=>`<li>${esc(s.replace(/^(?:[‚Ä¢\-‚Äì*]|\d+\.)\s+/, ""))}</li>`).join("")}</ol>`;
  }
  return `<p>${esc(g).replace(/\n/g,"<br>")}</p>`;
}

function renderAnswer(data){
  let html = "";
  const generalTxt = data.general || data.answer || data.text || "";
  if(generalTxt) html += generalToHTML(generalTxt);

  const lists = Array.isArray(data.lists) ? data.lists : [];
  lists.forEach((entry,i)=>{
    let items = [];
    let title = entry?.title || `Lista ${i+1}`;
    if(Array.isArray(entry)) { items = entry.map(x=>String(x)); }
    else if(entry && typeof entry==="object"){ items = Array.isArray(entry.items)? entry.items.map(String):[]; }
    if(items.length){
      html += `<h3>${esc(title)}</h3><ol>${items.map(it=>`<li>${esc(it)}</li>`).join("")}</ol>`;
    }
  });

  (data.tables||[]).forEach(t=>{
    const cols=t.columns|| (t.rows && t.rows[0] ? Object.keys(t.rows[0]) : []);
    const rows=t.rows||[];
    if(!cols.length || !rows.length) return;
    const th = cols.map(c=>`<th>${esc(c)}</th>`).join("");
    const trs = rows.map(r=>`<tr>${cols.map(c=>`<td>${esc(r[c] ?? r[cols.indexOf(c)] ?? "")}</td>`).join("")}</tr>`).join("");
    html += `<h3>${esc(t.title||"Tabla")}</h3><table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
  });

  out.innerHTML = html || "<em>Sin contenido.</em>";
  // Narraci√≥n opcional
  TTS.enabled = true; TTS.loadFromOut(); TTS.start(0);
  // Guardar historial
  setTimeout(()=> saveSession(q.value.trim(), data), 30);
}

/* ====== Escalado inteligente ====== */
const ERR_PATTERNS = [
  /consulta no reconocida/i,
  /datos insuficientes/i,
  /no hay datos/i
];

// llamada simple
async function call(method, path, body){
  const url = `${API_BASE}${path}${method==="GET" && body?.q ? `?q=${encodeURIComponent(body.q)}` : ""}`;
  const resp = await fetch(url, {
    method,
    headers: { "Content-Type":"application/json", "Accept":"application/json,text/plain" },
    body: method==="POST" ? JSON.stringify(body) : undefined
  });
  const data = await parseResp(resp);
  return { ok: resp.ok, data };
}

// orquesta: answer ‚Üí gpt tools ‚Üí gpt free
async function queryScaled(text){
  // 1) r√°pido
  let r = await call("GET", PATH_ANSWER, { q: text });
  if (r.ok && r.data && !ERR_PATTERNS.some(rx=>rx.test(JSON.stringify(r.data)))) return r.data;

  // 2) herramientas
  r = await call("POST", PATH_GPT_TOOLS, { q: text });
  if (r.ok && r.data && (r.data.general || r.data.lists || r.data.tables)) return r.data;

  // 3) libre
  r = await call("POST", PATH_GPT_FREE, { q: text });
  return r.data || { general: "Sin respuesta." };
}

/* ====== TTS ====== */
let selectedVoice=null;
function chooseVoice(){
  const vs = (typeof speechSynthesis!=="undefined") ? speechSynthesis.getVoices() : [];
  return vs.find(v=>/^es(-|$)/i.test(v.lang)) || vs[0] || null;
}
if(typeof speechSynthesis!=="undefined"){ speechSynthesis.onvoiceschanged=()=>{selectedVoice=chooseVoice()}; setTimeout(()=>{selectedVoice=chooseVoice()},150); }

const TTS={
  enabled:false, chunks:[], i:0, speaking:false,
  cut(txt,max=360){ const parts=[]; let b=""; (txt||"").split(/(\.|\?|!|\n)/).forEach((seg,idx)=>{ const s=(idx%2?seg:"") + (idx%2? "":seg); if((b+s).length<=max) b+=s; else{ if(b.trim()) parts.push(b.trim()); b=s; } }); if(b.trim()) parts.push(b.trim()); return parts; },
  loadFromOut(){ const div=document.createElement("div"); div.innerHTML=out.innerHTML; const t=div.textContent||""; this.chunks=this.cut(t); this.i=0; },
  start(){ if(!this.enabled||!this.chunks.length||typeof speechSynthesis==="undefined") return; speechSynthesis.cancel(); this.next(); },
  next(){ if(this.i>=this.chunks.length){ this.finish(); return; } const u=new SpeechSynthesisUtterance(this.chunks[this.i++]); if(selectedVoice) u.voice=selectedVoice; u.lang=(selectedVoice?.lang)||"es-ES"; u.onstart=()=>{this.speaking=true; try{vid&&vid.play()}catch{} }; u.onend=()=>this.next(); speechSynthesis.speak(u); },
  finish(){ this.speaking=false; try{vid&&vid.pause()}catch{} },
  toggle(){ this.enabled=!this.enabled; if(this.enabled){ this.loadFromOut(); this.start(); } else { if(typeof speechSynthesis!=="undefined") speechSynthesis.cancel(); this.finish(); } },
  replay(){ this.enabled=true; this.loadFromOut(); this.start(); }
};

/* ====== Historial b√°sico ====== */
const HIST_KEY="lexium_sessions_v2";
function getSessions(){ try{const s=localStorage.getItem(HIST_KEY); if(s) return JSON.parse(s);}catch{} return []; }
function setSessions(a){ try{localStorage.setItem(HIST_KEY, JSON.stringify(a));}catch{} }
function saveSession(question,data){ const all=getSessions(); all.unshift({when:Date.now(),question,summary:(data.general||"").slice(0,1500)}); setSessions(all.slice(0,100)); }
function openHistoryModal(){ const all=getSessions(); histBody.innerHTML = all.length? all.map(s=>`<details><summary><b>${new Date(s.when).toLocaleString()}</b> ‚Äî ${esc(s.question)}</summary><pre>${esc(s.summary)}</pre></details>`).join("") : "<p class='muted'>Sin historial.</p>"; histModal.classList.add("show"); }
function closeHistoryModal(){ histModal.classList.remove("show"); }

/* ====== Export ====== */
function printHTML(html){
  const iframe=document.createElement('iframe'); iframe.style.position='fixed'; iframe.style.right=0; iframe.style.bottom=0; iframe.style.width=0; iframe.style.height=0; iframe.style.border=0;
  document.body.appendChild(iframe);
  const idoc=(iframe.contentWindow||iframe).document; idoc.open(); idoc.write(html); idoc.close();
  setTimeout(()=>{ try{ (iframe.contentWindow||iframe).focus(); (iframe.contentWindow||iframe).print(); }catch{} }, 60);
  setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch{} }, 30000);
}
selExport.addEventListener("change", ()=>{
  const v=selExport.value; selExport.value="";
  if(!out.innerHTML.trim()){ alert("No hay contenido que exportar."); return; }
  if(v==="pdf"){
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Lexium - Export PDF</title>
      <style>body{font:16px/1.5 system-ui;margin:28px;color:#111}
             table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:6px}</style>
      </head><body>${out.innerHTML}</body></html>`;
    try{ printHTML(html); }catch{ const blob=new Blob([html],{type:"text/html"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="lexium_export.html"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }
  }
  if(v==="xls"||v==="doc"){
    const mime = v==="xls" ? "application/vnd.ms-excel" : "application/msword";
    const blob=new Blob([`<html><body>${out.innerHTML}</body></html>`],{type:mime});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`export.${v}`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
  }
});

/* ====== Eventos ====== */
btnSend.addEventListener("click", ask);
q.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); ask(); } });
btnDict.addEventListener("click", toggleDict);
btnToggleAV.addEventListener("click", ()=> TTS.toggle());
btnReplay.addEventListener("click", ()=> TTS.replay());
btnClear.addEventListener("click", ()=>{ q.value=""; out.innerHTML=""; clearStatus(); if(typeof speechSynthesis!=="undefined") speechSynthesis.cancel(); });
btnNew.addEventListener("click", ()=>{ saveSession(q.value.trim(), {general: (out.textContent||"").trim()}); q.value=""; out.innerHTML=""; clearStatus(); });
btnHist.addEventListener("click", openHistoryModal);
document.getElementById("btnHistClose").addEventListener("click", closeHistoryModal);
document.getElementById("histModal").addEventListener("click", e=>{ if(e.target.id==="histModal") closeHistoryModal(); });
document.getElementById("btnHistClear").addEventListener("click", ()=>{ if(confirm("¬øBorrar historial?")) localStorage.removeItem(HIST_KEY), openHistoryModal(); });
document.getElementById("btnHistDownload").addEventListener("click", ()=>{ const data=localStorage.getItem(HIST_KEY)||"[]"; const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([data],{type:"application/json"})); a.download="historial_lexium.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); });

/* ====== L√≥gica principal ====== */
async function ask(){
  const text = q.value.trim();
  if(!text) return;
  setStatusLoading("Consultando‚Ä¶");
  try{
    const data = await queryScaled(text);
    renderAnswer(data);
  }catch(e){
    out.innerHTML = `<pre style="color:#b91c1c">No se pudo obtener respuesta.\n${esc(String(e))}</pre>`;
  }finally{
    clearStatus();
  }
}

/* ====== Dictado ====== */
let recognizer=null;
function toggleDict(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert("Dictado no soportado en este navegador."); return; }
  if(!recognizer){
    recognizer=new SR(); recognizer.lang="es-ES"; recognizer.continuous=false; recognizer.interimResults=false;
    recognizer.onresult=e=>{ const t=Array.from(e.results).map(r=>r[0].transcript).join(" "); q.value=(q.value? q.value+" " : "") + t; };
  }
  if(recognizer.listening){ recognizer.stop(); recognizer.listening=false; btnDict.textContent="üé§ Dictar"; }
  else { recognizer.start(); recognizer.listening=true; btnDict.textContent="‚èπ Detener dictado"; }
}

/* Mostrar errores JS en pantalla */
window.addEventListener("error", (e)=>{
  const msg = (e?.error?.stack || e?.message || String(e)).slice(0, 600);
  statusEl.innerHTML = '<pre style="color:#b91c1c;background:#fff5f5;border:1px solid #fecaca;border-radius:8px;padding:8px;white-space:pre-wrap">JS error: '
    + esc(msg) + '</pre>';
});
</script>
</body>
</html>
