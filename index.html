<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>lllAsistente Lexium</title>
<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#6b7280; --pri:#0d6efd; --bd:#e5e7eb; --ok:#16a34a; --warn:#d97706; --err:#b91c1c;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1180px;margin:0 auto;padding:12px;}
  .hero{position:sticky;top:0;background:#fff;z-index:5;padding-top:4px;border-bottom:1px solid var(--bd)}
  .heroGrid{display:grid;grid-template-columns:1fr 3fr 1fr;align-items:center;gap:8px;}
  .sideImg{display:flex;justify-content:center}
  .sideImg img{max-width:90%;height:auto;object-fit:contain;opacity:.95}
  .videoBox video{width:100%;height:auto;border:none;display:block}
  .toolbar{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin:8px 0}
  .toolbar button, .toolbar select{
    padding:9px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer;
  }
  .toolbar button:hover{background:#f5f7fb}
  .hist{position:fixed;right:14px;top:10px;z-index:9}
  .hist button{padding:8px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  .query{width:100%;min-height:60px;border:1px solid var(--bd);border-radius:10px;padding:10px;font-size:16px}
  .out{margin:8px 0;border:1px solid var(--bd);border-radius:12px;padding:12px;overflow-x:auto}
  table{width:100%;border-collapse:collapse;margin:10px 0}
  th,td{border:1px solid var(--bd);padding:8px}
  th{background:#f8fafc;text-align:left}
  .muted{color:var(--muted);font-size:.9rem}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--bd);font-size:.85rem}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .left{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="wrap">

  <!-- bot√≥n Historial (arriba derecha) -->
  <div class="hist">
    <button id="btnHist" title="Ver sesiones guardadas">Historial</button>
  </div>

  <!-- Bloque superior fijo -->
  <div class="hero" aria-label="cabecera">
    <div class="heroGrid">
      <div class="sideImg">
        <img src="left.png" alt="Logo izquierdo" title="Santillana"/>
      </div>
      <div class="videoBox">
        <video id="vid" preload="none" muted playsinline src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"></video>
      </div>
      <div class="sideImg">
        <img src="right.png" alt="Logo derecho" title="Compartir"/>
      </div>
    </div>

    <!-- Caja de texto + barra de acciones -->
    <div style="margin:8px 0">
      <textarea id="q" class="query" rows="2" placeholder="Escribe tu pregunta (ej.: 'lista de estudiantes', 'promedio de AUTOESTIMA por paralelo', 't de Welch de AUTOESTIMA (A vs B)', o cualquier duda)"></textarea>
    </div>

    <div class="toolbar">
      <button id="btnSend" title="Enviar consulta">Enviar</button>
      <button id="btnDict" title="Dictar por voz (empieza / detiene)">üé§ Dictar</button>
      <button id="btnToggleAV" title="Parar/Activar voz y video">‚èØ Parar/Activar voz y video</button>
      <button id="btnReplay" title="Reproducir nuevamente la voz">‚ü≥ Reproducir nuevamente</button>
      <button id="btnNew" title="Nueva sesi√≥n (limpia y guarda la actual)">Ôºã Nueva sesi√≥n</button>
      <button id="btnClear" title="Limpiar pregunta y respuesta">üßπ Limpiar</button>
      <select id="selExport" title="Exportar lo generado (PDF muestra vista previa)">
        <option value="">Exportar‚Ä¶</option>
        <option value="pdf">PDF (vista previa)</option>
        <option value="xls">XLS</option>
        <option value="doc">DOC</option>
      </select>
    </div>

    <div class="row" style="margin:8px 0">
      <div class="left">
        <span id="badgeMode" class="pill"><strong>Ruta:</strong> ‚Äî</span>
        <span id="badgeTime" class="pill"><strong>Tiempo:</strong> ‚Äî</span>
      </div>
      <span class="muted">Las respuestas usan exclusivamente el CSV/TXT de tu backend.</span>
    </div>
  </div>

  <!-- Resultado -->
  <div id="out" class="out" aria-live="polite"></div>

</div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app"; // ‚Üê tu URL
// Rutas: primero /api/answer (r√°pido, GET), luego /api/gpt?mode=tools (POST), luego /api/gpt?mode=free (POST)
const PATH_ANSWER = "/api/answer";
const PATH_GPT_TOOLS = "/api/gpt?mode=tools";
const PATH_GPT_FREE  = "/api/gpt?mode=free";

/* ====== UI refs ====== */
const q = document.getElementById("q");
const out = document.getElementById("out");
const vid = document.getElementById("vid");
const btnSend = document.getElementById("btnSend");
const btnDict = document.getElementById("btnDict");
const btnToggleAV = document.getElementById("btnToggleAV");
const btnReplay = document.getElementById("btnReplay");
const btnNew = document.getElementById("btnNew");
const btnClear = document.getElementById("btnClear");
const selExport = document.getElementById("selExport");
const btnHist = document.getElementById("btnHist");
const badgeMode = document.getElementById("badgeMode");
const badgeTime = document.getElementById("badgeTime");

/* ====== Estado de voz/video ====== */
let voices = []; let currentVoice = null; let speaking = false; let paused = false; let lastSpokenText = ""; let recognizer = null;

function pickSpanishFemale(){
  voices = window.speechSynthesis.getVoices();
  const es = voices.filter(v=>/^es(-|_)/i.test(v.lang));
  let fem = es.find(v=>/female|femenina|mujer/i.test(v.name));
  currentVoice = fem || es[0] || voices[0] || null;
}
if (typeof speechSynthesis !== "undefined") {
  pickSpanishFemale();
  window.speechSynthesis.onvoiceschanged = pickSpanishFemale;
}
function speak(text){
  if (!text) return;
  lastSpokenText = text;
  const u = new SpeechSynthesisUtterance(text);
  if (currentVoice) u.voice = currentVoice;
  u.lang = (currentVoice && currentVoice.lang) || "es-ES";
  u.rate = 1; u.pitch = 1; u.volume = 1;
  u.onstart = ()=>{ speaking = true; vid.play().catch(()=>{}); };
  u.onend   = ()=>{ speaking = false; vid.pause(); };
  u.onerror = ()=>{ speaking = false; vid.pause(); };
  window.speechSynthesis.speak(u);
}
function toggleAV(){
  if (speaking && !paused){ window.speechSynthesis.pause(); paused = true; vid.pause(); }
  else if (speaking && paused){ window.speechSynthesis.resume(); paused = false; vid.play().catch(()=>{}); }
  else { speak(lastSpokenText); }
}
function replay(){ if (window.speechSynthesis.speaking) window.speechSynthesis.cancel(); speak(lastSpokenText); }

/* ====== Utilidades red/tiempos ====== */
function now(){ return performance.now(); }
function ms(n){ return `${n.toFixed(0)} ms`; }
function setBadge(mode, timeMs){
  badgeMode.innerHTML = `<strong>Ruta:</strong> ${mode}`;
  badgeTime.innerHTML = `<strong>Tiempo:</strong> ${ms(timeMs)}`;
  badgeMode.className = "pill " + (mode==="r√°pido" ? "ok" : (mode==="tools" ? "warn" : "err"));
}
function fetchWithTimeout(url, opts={}, timeoutMs=6000){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(new Error("timeout")), timeoutMs);
  return fetch(url, { ...opts, signal: ctrl.signal })
    .finally(()=>clearTimeout(id));
}
function isUnrecognized(data){
  if (!data || data.ok === false) return true;
  const g = (data.general||"").toLowerCase();
  if (g.includes("no reconocida")) return true;
  // si no hay contenido √∫til, lo tratamos como no reconocido
  const hasContent = (data.lists && data.lists.length) || (data.tables && data.tables.length) || (data.general && data.general.trim());
  return !hasContent;
}

/* ====== Render ====== */
function renderAnswer(data){
  let html = "";
  if (data.general) html += `<p>${escapeHtml(data.general).replace(/\n/g,"<br>")}</p>`;
  (data.lists||[]).forEach(l=>{
    html += `<h3>${escapeHtml(l.title||"Lista")}</h3><ol>`;
    (l.items||[]).forEach(it=> html += `<li>${escapeHtml(String(it))}</li>`);
    html += `</ol>`;
  });
  (data.tables||[]).forEach(t=>{
    const cols = t.columns||[];
    const rows = t.rows||[];
    html += `<h3>${escapeHtml(t.title||"Tabla")}</h3><table><thead><tr>`;
    cols.forEach(c=> html+=`<th>${escapeHtml(String(c))}</th>`);
    html += `</tr></thead><tbody>`;
    rows.forEach(r=>{
      html += `<tr>${r.map(x=>`<td>${escapeHtml(String(x))}</td>`).join("")}</tr>`;
    });
    html += `</tbody></table>`;
  });
  out.innerHTML = html || "<em>Sin contenido.</em>";

  if (data.general) {
    if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
    speak(data.general);
  }
}
function escapeHtml(x){return x.replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]))}

/* ====== Sesiones (historial localStorage) ====== */
function saveSession(question, data){
  const key = "lexium_sessions";
  const all = JSON.parse(localStorage.getItem(key) || "[]");
  const id = new Date().toISOString();
  all.unshift({ id, question, data });
  localStorage.setItem(key, JSON.stringify(all.slice(0,50)));
}
function openHistory(){
  const key = "lexium_sessions";
  const all = JSON.parse(localStorage.getItem(key) || "[]");
  if (!all.length) { alert("Sin historial."); return; }
  const w = window.open("", "_blank");
  const html = `
  <html><head><title>Historial</title>
  <style>body{font:14px system-ui} pre{white-space:pre-wrap}</style></head><body>
  <h2>Sesiones</h2>
  ${all.map(s=>`
    <details>
      <summary><b>${s.id}</b> ‚Äî ${escapeHtml(s.question)}</summary>
      <pre>${escapeHtml(JSON.stringify(s.data, null, 2))}</pre>
    </details>
  `).join("")}
  </body></html>`;
  w.document.write(html); w.document.close();
}

/* ====== Exportar ====== */
selExport.addEventListener("change", ()=>{
  const v = selExport.value; selExport.value="";
  if (!out.innerHTML.trim()){ alert("No hay contenido que exportar."); return; }
  if (v==="pdf"){
    const w = window.open("","_blank");
    w.document.write(`<html><head><title>Export PDF</title></head><body>${out.innerHTML}</body></html>`);
    w.document.close(); w.focus(); w.print();
  } else if (v==="xls" || v==="doc"){
    const mime = v==="xls" ? "application/vnd.ms-excel" : "application/msword";
    const blob = new Blob([`<html><body>${out.innerHTML}</body></html>`], {type:mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `export.${v}`;
    a.click();
    URL.revokeObjectURL(a.href);
  }
});

/* ====== Dictado ====== */
let recognizer=null;
function toggleDict(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert("Dictado no soportado en este navegador."); return; }
  if (!recognizer){
    recognizer = new SR();
    recognizer.lang = "es-ES";
    recognizer.continuous = false;
    recognizer.interimResults = false;
    recognizer.onresult = e=>{
      const t = Array.from(e.results).map(r=>r[0].transcript).join(" ");
      q.value = (q.value ? q.value+" " : "") + t;
    };
  }
  if (recognizer.listening){ recognizer.stop(); recognizer.listening=false; btnDict.textContent="üé§ Dictar"; }
  else { recognizer.start(); recognizer.listening=true; btnDict.textContent="‚èπ Detener dictado"; }
}

/* ====== Env√≠o con fallback (r√°pido ‚Üí tools ‚Üí free) ====== */
async function ask(){
  const text = q.value.trim();
  if (!text) return;

  out.innerHTML = '<em>Procesando‚Ä¶</em>';
  const t0 = now();

  try{
    // 1) r√°pido (GET /api/answer) ‚Äì sin preflight
    const urlFast = `${API_BASE}${PATH_ANSWER}?q=${encodeURIComponent(text)}`;
    const rFast = await fetchWithTimeout(urlFast, { headers:{ Accept:"application/json" } }, 6000);
    const dFast = await rFast.json().catch(()=>null);
    if (rFast.ok && dFast && !isUnrecognized(dFast)) {
      const dt = now()-t0; setBadge("r√°pido", dt);
      saveSession(text, dFast); renderAnswer(dFast); return;
    }

    // 2) tools (POST /api/gpt?mode=tools)
    const rTools = await fetchWithTimeout(`${API_BASE}${PATH_GPT_TOOLS}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ q: text })
    }, 9000);
    const dTools = await rTools.json().catch(()=>null);
    if (rTools.ok && dTools && !isUnrecognized(dTools)) {
      const dt = now()-t0; setBadge("tools", dt);
      saveSession(text, dTools); renderAnswer(dTools); return;
    }

    // 3) free (POST /api/gpt?mode=free) ‚Äì √∫ltimo recurso
    const rFree = await fetchWithTimeout(`${API_BASE}${PATH_GPT_FREE}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ q: text })
    }, 15000);
    const dFree = await rFree.json().catch(()=>null);
    if (rFree.ok && dFree && dFree.ok !== false) {
      const dt = now()-t0; setBadge("free", dt);
      saveSession(text, dFree); renderAnswer(dFree); return;
    }

    throw new Error((dFree?.error || dTools?.error || dFast?.error) || "Sin respuesta √∫til.");
  }catch(e){
    setBadge("error", now()-t0);
    out.innerHTML = `<pre style="color:#b91c1c">${String(e)}</pre>`;
  }
}

/* ====== Limpieza / Nueva sesi√≥n ====== */
btnClear.addEventListener("click", ()=>{ q.value=""; out.innerHTML=""; if (window.speechSynthesis.speaking) window.speechSynthesis.cancel(); });
btnNew.addEventListener("click", ()=>{ if (window.speechSynthesis.speaking) window.speechSynthesis.cancel(); q.value=""; out.innerHTML=""; });
btnSend.addEventListener("click", ask);
btnDict.addEventListener("click", toggleDict);
btnToggleAV.addEventListener("click", toggleAV);
btnReplay.addEventListener("click", replay);
btnHist.addEventListener("click", openHistory);
q.addEventListener("keydown", e=>{ if (e.key==="Enter" && (e.ctrlKey||e.metaKey)) ask(); });
</script>
</body>
</html>
