<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>hLexium ‚Äî Consultas</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
      --primary:#60a5fa; --border:#1f2937; --ok:#22c55e; --warn:#eab308; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#0b1020 0%,#0b1020 60%,#0a0f1f 100%); color:var(--text);
      overflow-y:auto;
    }
    header{
      display:flex; align-items:center; gap:12px; padding:12px 18px; border-bottom:1px solid var(--border);
      background:rgba(15,23,42,.65); position:sticky; top:0; z-index:30; backdrop-filter: blur(6px);
    }
    header .title{font-weight:700; letter-spacing:.3px}
    header .badge{font-size:12px; color:var(--muted)}

    /* --- HERO superior fijo (video + im√°genes) --- */
    .top-hero{
      position: sticky; top: 52px; z-index: 20; /* debajo del header */
      height: 65vh; /* 65% de la pantalla */
      display: grid;
      grid-template-columns: 1fr 2fr 1fr; /* img izquierda | video | img derecha */
      gap: 12px;
      padding: 10px 18px;
      background: rgba(11,16,32,.88); /* fijo visualmente */
      backdrop-filter: blur(3px);
      border-bottom: 1px solid var(--border);
    }
    .top-hero .media{ width:100%; height:100%; border-radius:12px; border:1px solid var(--border); overflow:hidden; }
    #vid{ width:100%; height:100%; object-fit:cover; display:block; background:#0b1020; }
    .side-img{ width:100%; height:100%; object-fit:cover; display:block; background:linear-gradient(180deg,#0b1020,#0f172a); }
    @media (max-width: 980px){
      .top-hero{ grid-template-columns: 1fr; height: 45vh; }
      .top-hero .media:nth-child(1), .top-hero .media:nth-child(3){ display:none; }
    }

    main{padding:18px; max-width:1200px; margin:0 auto;}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:18px}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg,rgba(17,24,39,.7),rgba(17,24,39,.4));
      border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow: 0 6px 28px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
    }
    label{display:block; color:var(--muted); margin:4px 0 8px}
    textarea{
      width:100%; min-height:140px; resize:vertical; border-radius:12px; padding:14px 12px;
      border:1px solid var(--border); outline:none; color:var(--text);
      background:rgba(15,23,42,.5);
    }
    textarea:focus{border-color:var(--primary)}
    .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px}
    button,.btn{
      appearance:none; border:1px solid var(--border); background:#121a2e; color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:all .15s ease; box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    button:hover{transform:translateY(-1px); border-color:#2a3758; background:#121b34}
    button.primary{background:linear-gradient(180deg,#1d4ed8,#1e40af); border-color:#1d4ed8}
    button.primary:hover{filter:brightness(1.05)}
    select{
      background:#121a2e; color:var(--text); border:1px solid var(--border);
      padding:10px 12px; border-radius:10px;
    }
    .status{font-size:12px; color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    #out{
      white-space:pre-wrap; /* muestra toda la respuesta con saltos */
      min-height:360px; border-radius:12px; padding:14px; border:1px solid var(--border);
      background:rgba(15,23,42,.45); overflow:auto; line-height:1.5;
    }
    .caption{font-size:12px; color:var(--muted); margin-top:6px}
    .toolbar{display:flex; align-items:center; gap:10px; justify-content:space-between; margin-top:6px}
    .left, .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <div class="title">Lexium ‚Äî Consultas</div>
    <div class="badge" id="status"></div>
  </header>

  <!-- HERO fijo: im√°genes a los lados y video al centro -->
  <section class="top-hero">
    <div class="media"><img id="imgLeft" class="side-img" alt=""></div>
    <div class="media"><video id="vid" controls muted playsinline></video></div>
    <div class="media"><img id="imgRight" class="side-img" alt=""></div>
  </section>

  <main>
    <div class="grid">
      <!-- Entrada -->
      <section class="card">
        <label for="q">Escribe tu pregunta</label>
        <textarea id="q" placeholder="Ej: lista de estudiantes, promedio de Autoestima, calificaciones &quot;Castillo D Julia&quot;, percentil 90 de Asertividad por paralelo‚Ä¶"></textarea>

        <div class="row">
          <button id="btnSend" class="primary">Enviar</button>
          <button id="btnDict">üé§ Dictar</button>
          <button id="btnToggleAV">‚èØ Activar voz</button>
          <button id="btnReplay">‚ü≥ Reproducir</button>
          <button id="btnNew">Ôºã Nueva sesi√≥n</button>
          <button id="btnClear">üßπ Limpiar</button>

          <span style="flex:1"></span>

          <label for="exportSel" style="margin:0">Exportar‚Ä¶</label>
          <select id="exportSel">
            <option value="txt">Respuesta (.txt)</option>
            <option value="json">Payload (.json)</option>
            <option value="pdf">PDF (vista previa)</option>
          </select>
          <button id="btnExport" class="btn">Guardar</button>
        </div>

        <div class="caption">Enter = Enviar ¬∑ Shift+Enter = salto de l√≠nea</div>
      </section>

      <!-- Respuesta -->
      <section class="card">
        <label>Respuesta</label>
        <div id="out">‚Äî</div>

        <div class="toolbar">
          <div class="left">
            <div class="status">Ruta: <span id="rutaHint" class="warn">‚Äî</span></div>
          </div>
          <div class="right">
            <span class="status">Tiempo: <span id="tiempoHint">‚Äî</span></span>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ====== SCRIPT ====== -->
  <script>
  /* ===== CONFIG ===== */
  // Usa el valor global si ya lo defines fuera; si no, toma la URL estable del servicio
  const API_BASE = window.API_BASE || "https://lexium-api-383217514425.southamerica-west1.run.app";
  const GPT_PATH = "/api/gpt";          // preferido
  const FALLBACK_PATH = "/api/answer";  // compat

  /* ===== UI refs ===== */
  const qEl       = document.getElementById("q");
  const outEl     = document.getElementById("out");
  const statusEl  = document.getElementById("status");
  const rutaHint  = document.getElementById("rutaHint");
  const tiempoEl  = document.getElementById("tiempoHint");

  const btnSend   = document.getElementById("btnSend");
  const btnDict   = document.getElementById("btnDict");
  const btnToggle = document.getElementById("btnToggleAV");
  const btnReplay = document.getElementById("btnReplay");
  const btnNew    = document.getElementById("btnNew");
  const btnClear  = document.getElementById("btnClear");
  const btnExport = document.getElementById("btnExport");
  const exportSel = document.getElementById("exportSel");

  const vidEl     = document.getElementById("vid");
  const imgLeft   = document.getElementById("imgLeft");
  const imgRight  = document.getElementById("imgRight");

  // Opcional: define im√°genes si quieres mostrarlas (o deja vac√≠o)
  // imgLeft.src  = "https://via.placeholder.com/600x800?text=Imagen+Izquierda";
  // imgRight.src = "https://via.placeholder.com/600x800?text=Imagen+Derecha";

  function setStatus(txt, cls=""){ if(!statusEl) return; statusEl.className="badge "+cls; statusEl.textContent=txt; }
  function setBusy(b){ if(btnSend) btnSend.disabled=b; }

  /* ===== Fetch helpers ===== */
  async function fetchJSON(url, opts = {}) {
    const r = await fetch(url, opts);
    const ct = r.headers.get("content-type") || "";
    if (!r.ok) {
      const body = ct.includes("application/json") ? await r.json().catch(()=>({})) : await r.text().catch(()=> "");
      throw new Error(`${r.status} ${r.statusText} | ${typeof body==="string"?body:JSON.stringify(body)}`);
    }
    if (ct.includes("application/json")) return r.json();
    return { answer: await r.text() };
  }

  async function callAPI(question) {
    // 1) POST /api/gpt
    try {
      return await fetchJSON(API_BASE + GPT_PATH, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ q: question })
      });
    } catch (e1) {
      console.warn("POST /api/gpt fall√≥:", e1.message);
      // 2) GET /api/answer?q=
      try {
        return await fetchJSON(API_BASE + FALLBACK_PATH + "?q=" + encodeURIComponent(question));
      } catch (e2) {
        console.warn("GET /api/answer fall√≥:", e2.message);
        // 3) POST /api/answer
        return await fetchJSON(API_BASE + FALLBACK_PATH, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ q: question })
        });
      }
    }
  }

  /* ===== Render ===== */
  function renderAnswer(data) {
    const text = (data && (data.answer || data.text)) || "Sin contenido.";
    outEl.textContent = text;
    if ("value" in outEl) outEl.value = text; // por si fuera <textarea>
    if (rutaHint) rutaHint.textContent = data?.ruta ?? "‚Äî";
    if (tiempoEl) tiempoEl.textContent = data?.tiempo_ms ? (data.tiempo_ms + " ms") : "‚Äî";
    afterRenderSpeakFull(); // leer toda la respuesta si voz activa
  }

  /* ===== Env√≠o principal ===== */
  async function send() {
    const question = (qEl.value || "").trim();
    if (!question) return;
    setStatus("Consultando‚Ä¶","warn"); setBusy(true);
    try {
      const data = await callAPI(question);
      renderAnswer(data);
      setStatus("OK","ok");
    } catch (err) {
      console.error(err);
      renderAnswer({ answer: "‚ö†Ô∏è Error consultando el servicio.\n" + err.message });
      setStatus("Error","err");
    } finally {
      setBusy(false);
    }
  }

  /* ===== Exportar ===== */
  function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
  function exportPDFPreview(text){
    const html = `
<!doctype html><html><head><meta charset="utf-8">
<title>Lexium - Exportar PDF</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:32px;line-height:1.5;color:#111827}
  h1{font-size:18px;margin:0 0 12px}
  pre{white-space:pre-wrap;font:inherit}
</style></head><body>
  <h1>Respuesta de Lexium</h1>
  <pre>${escapeHtml(text)}</pre>
</body></html>`;
    const w = window.open("", "_blank");
    w.document.open(); w.document.write(html); w.document.close();
    w.focus(); w.print();  // vista previa del navegador
  }
  function download(filename, text, type="text/plain;charset=utf-8"){
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], {type})); a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }
  btnExport?.addEventListener("click", ()=>{
    const mode = exportSel.value;
    const text = ("value" in outEl && outEl.value) ? outEl.value : outEl.textContent || "";
    if (mode === "pdf") { exportPDFPreview(text); return; }
    if (mode === "txt") { download("lexium_respuesta.txt", text); return; }
    if (mode === "json"){ download("lexium_respuesta.json", JSON.stringify({answer:text, at:new Date().toISOString()},null,2), "application/json"); return; }
  });

  /* ===== Dictado (opcional) ===== */
  let recog=null, recogOn=false;
  function initSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return null;
    const r = new SR();
    r.lang = "es-ES"; r.continuous=false; r.interimResults=false;
    r.onresult = (e)=>{ const tx = e.results?.[0]?.[0]?.transcript || ""; if(tx){ qEl.value = (qEl.value+" "+tx).trim(); } };
    r.onerror = ()=>{};
    r.onend = ()=>{ recogOn=false; btnDict && (btnDict.textContent="üé§ Dictar"); };
    return r;
  }

  /* ===== TTS: voz femenina en espa√±ol + lectura completa ===== */
  let ttsOn = false;
  let currentQueue = [];
  let speaking = false;
  let selectedVoice = null;

  const FEMALE_HINTS = [
    "female","mujer","femenina",
    "Microsoft Sabina","Microsoft Helena","Microsoft Laura","Microsoft Dalia","Microsoft Elvira","Microsoft Paloma","Microsoft Maria","Microsoft Lucia",
    "Google espa√±ol","Google US Espa√±ol","Google espa√±ol de Estados",
    "Monica","Paulina","Camila","Sofia","Elena","Isabella","Lucia","Maria","Carla"
  ];
  const SP_LANGS = ["es","es-ES","es-MX","es-US","es-419","es-AR","es-CL","es-CO","es-PE","es-EC"];

  function scoreVoice(v){
    let s = 0;
    const name = (v.name||"").toLowerCase();
    const lang = (v.lang||"").toLowerCase();
    if (SP_LANGS.some(l=>lang.startsWith(l.toLowerCase()))) s += 5;
    if (FEMALE_HINTS.some(h=>name.includes(h.toLowerCase()))) s += 5;
    if (name.includes("google")) s += 2;
    if (name.includes("microsoft")) s += 2;
    return s;
  }
  function pickFemaleSpanishVoice() {
    const voices = window.speechSynthesis.getVoices();
    if (!voices.length) return null;
    voices.sort((a,b)=>scoreVoice(b)-scoreVoice(a));
    return voices[0] || null;
  }
  function initVoice() { selectedVoice = pickFemaleSpanishVoice(); }
  if ("speechSynthesis" in window) {
    window.speechSynthesis.onvoiceschanged = () => { initVoice(); };
    setTimeout(initVoice, 200);
  }
  function chunkText(text, maxLen=320){
    const parts=[]; const units = text.split(/(\.|\?|!|\n)/); let buf="";
    for (let i=0; i<units.length; i+=2){
      const sent = (units[i]||"") + (units[i+1]||"");
      if ((buf + sent).length <= maxLen) buf += sent;
      else { if (buf.trim()) parts.push(buf.trim()); buf = sent; }
    }
    if (buf.trim()) parts.push(buf.trim());
    return parts;
  }
  function speakAll(text){
    if (!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    currentQueue = chunkText(text, 320);
    speaking = true;
    const playNext = () => {
      if (!ttsOn) { window.speechSynthesis.cancel(); speaking=false; return; }
      const next = currentQueue.shift();
      if (!next) { speaking=false; return; }
      const u = new SpeechSynthesisUtterance(next);
      if (selectedVoice) u.voice = selectedVoice;
      u.lang = (selectedVoice?.lang) || "es-ES";
      u.rate = 1; u.pitch = 1; u.volume = 1;
      u.onend = () => playNext();
      u.onerror = () => playNext();
      window.speechSynthesis.speak(u);
    };
    playNext();
  }
  function afterRenderSpeakFull(){
    if (ttsOn && outEl?.textContent) speakAll(outEl.textContent);
  }

  /* ===== Eventos ===== */
  btnSend?.addEventListener("click", send);
  btnClear?.addEventListener("click", ()=>{ outEl.textContent=""; if("value" in outEl) outEl.value=""; setStatus(""); });
  qEl?.addEventListener("keydown",(e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); } });

  btnDict?.addEventListener("click", ()=>{
    if(!recog) recog = initSTT();
    if(!recog){ alert("Dictado no disponible en este navegador."); return; }
    if(recogOn){ recog.stop(); return; }
    recogOn=true; btnDict.textContent="‚èπÔ∏è Detener dictado"; recog.start();
  });

  btnToggle?.addEventListener("click", ()=>{
    ttsOn = !ttsOn;
    btnToggle.textContent = ttsOn ? "‚è∏Ô∏è Silenciar voz" : "‚èØ Activar voz";
    if (ttsOn && outEl?.textContent) speakAll(outEl.textContent);
    if (!ttsOn) window.speechSynthesis.cancel();
  });
  btnReplay?.addEventListener("click", ()=>{ if (outEl?.textContent) { ttsOn = true; speakAll(outEl.textContent); } });
  btnNew?.addEventListener("click", ()=>{
    qEl.value=""; outEl.textContent="‚Äî"; setStatus("");
    const rh=document.getElementById("rutaHint"); const th=document.getElementById("tiempoHint");
    if (rh) rh.textContent="‚Äî"; if (th) th.textContent="‚Äî";
  });

  // Estado inicial
  setStatus("");
  </script>
</body>
</html>
