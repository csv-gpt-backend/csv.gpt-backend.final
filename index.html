<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asistente Lexium√ë√ë√ë√ë√ë√ë√ë√ë</title>
<style>
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; background:#fff; font-family: Arial, sans-serif; overflow-x:hidden; }
  /* Top (65% fijo) */
  .top {
    position: fixed; top:0; left:0; right:0; height:65vh; background:#fff;
    display:flex; align-items:center; justify-content:center; gap:20px; z-index:2; overflow:hidden;
  }
  .side {
    flex:0 0 15%; display:flex; align-items:center; justify-content:center;
  }
  .side img { max-width: 100%; height:auto; display:block; }
  .video-wrap { flex:1 1 auto; max-width: 900px; height:100%; display:flex; align-items:center; justify-content:center; }
  #v { width:100%; height:100%; object-fit:cover; border:none; }

  /* Bottom (scroll vertical) */
  .bottom {
    position: relative; margin-top:65vh; padding:16px; min-height:35vh;
  }
  #q { width:100%; height:52px; resize:none; font-size:16px; padding:10px; }
  .row { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; margin-top:10px; }
  button, select { padding:8px 12px; border:1px solid #ccc; background:#fff; border-radius:4px; cursor:pointer; }
  button:hover, select:hover { background:#f3f3f3; }
  #hist { position:fixed; top:10px; right:10px; z-index:3; }
  #out { margin-top:14px; border-top:1px solid #e5e5e5; padding-top:10px; }

  table { width:100%; border-collapse: collapse; margin-top:10px; font-size:14px; }
  th, td { border:1px solid #d9d9d9; padding:6px; text-align:left; }
  th { background:#fafafa; }
</style>
</head>
<body>
  <button id="hist" title="Ver historial de consultas">Historial</button>

  <div class="top">
    <div class="side"><img src="left.png" alt="Left logo" /></div>
    <div class="video-wrap">
      <video id="v" muted>
        <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4" />
      </video>
    </div>
    <div class="side"><img src="right.png" alt="Right logo" /></div>
  </div>

  <div class="bottom">
    <textarea id="q" placeholder="Escribe tu pregunta (o usa üé§ Dictar)‚Ä¶ m√°x 2 l√≠neas"></textarea>
    <div class="row">
      <button id="send" title="Enviar la pregunta">Enviar</button>
      <button id="dict" title="Dictar por voz (micr√≥fono)">üé§ Dictar</button>
      <button id="toggle" title="Pausar/Reanudar voz y video">‚èØÔ∏è Parar/Activar Voz y Video</button>
      <button id="replay" title="Reproducir nuevamente la √∫ltima respuesta">üîÅ Reproducir</button>
      <button id="newS" title="Comenzar nueva sesi√≥n (limpia historial local)">‚û§ Nueva sesi√≥n</button>
      <button id="clear" title="Limpiar pregunta y respuesta">üóëÔ∏è Limpiar</button>
      <select id="exportSel" title="Exportar (vista previa)">
        <option value="">Exportar‚Ä¶</option>
        <option value="pdf">PDF</option>
        <option value="xls">XLS</option>
        <option value="doc">DOC</option>
      </select>
    </div>
    <div id="out"></div>
  </div>

<script>
  // ===== CONFIG =====
  const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app";

  // ===== ELEMENTOS =====
  const v = document.getElementById("v");
  const out = document.getElementById("out");
  const qEl = document.getElementById("q");

  // ===== HISTORIAL (localStorage) =====
  function pushHist(item){
    const key = "lexium_hist";
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    arr.unshift(item);
    localStorage.setItem(key, JSON.stringify(arr.slice(0,100)));
  }
  function showHist(){
    const key = "lexium_hist";
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    if(!arr.length) { alert("Sin historial"); return; }
    const lines = arr.map((r,i)=> `${i+1}. [${new Date(r.ts).toLocaleString()}] ${r.q}`).join("\n");
    alert("Historial:\n\n" + lines);
  }
  document.getElementById("hist").onclick = showHist;

  // ===== RENDER =====
  function renderOutput(data){
    let html = "";
    if(data.general) html += `<p>${data.general}</p>`;
    (data.lists||[]).forEach(l=>{
      html += `<h4>${l.title||"Lista"}</h4><ul>`;
      (l.items||[]).forEach(it=> html += `<li>${it}</li>`);
      html += `</ul>`;
    });
    (data.tables||[]).forEach(t=>{
      html += `<h4>${t.title||"Tabla"}</h4><table><thead><tr>`;
      (t.columns||[]).forEach(c=> html += `<th>${c}</th>`);
      html += `</tr></thead><tbody>`;
      (t.rows||[]).forEach((r,idx)=>{
        const rr = Array.isArray(r) ? r : [];
        html += `<tr>${rr.map(c=>`<td>${c}</td>`).join("")}</tr>`;
      });
      html += `</tbody></table>`;
    });
    out.innerHTML = html || "<p>Sin resultados.</p>";
  }

  // ====== TTS con reanudaci√≥n exacta + voz femenina ======
  let voices = [];
  speechSynthesis.onvoiceschanged = ()=>{ voices = speechSynthesis.getVoices()||[]; };
  voices = speechSynthesis.getVoices()||[];

  function pickFemaleEsVoice(){
    const vs = voices.length?voices:speechSynthesis.getVoices();
    const langs = ["es-EC","es-MX","es-419","es-ES","es"];
    const femHints = ["female","mujer","femenina","sabina","paulina","camila","monica","isabel","elena","lupe","soledad","espa√±ol","latino"];
    // prioridad por lang + pistas femeninas
    let best = null;
    for(const v of vs){
      const ok = langs.some(l => (v.lang||"").toLowerCase().startsWith(l));
      if(!ok) continue;
      if(!best) best = v;
      const n = (v.name||"").toLowerCase();
      if(femHints.some(h => n.includes(h))) best = v;
    }
    return best || vs.find(v=> (v.lang||"").toLowerCase().startsWith("es")) || vs[0] || null;
  }

  // Fragmentaci√≥n de texto largo para voz
  function chunk(text, max=1200){
    const parts=[]; let i=0;
    while(i<text.length){
      let s = text.slice(i, i+max);
      let cut = s.lastIndexOf(". ");
      if(cut<400) cut = s.lastIndexOf(" ");
      if(cut<0) cut = s.length;
      parts.push(s.slice(0,cut+1));
      i += cut+1;
    }
    return parts.filter(x=>x.trim());
  }

  let tts = { parts:[], i:0, offset:0, last:{i:0, char:0}, paused:false };
  let current = null;
  let lastFull = "";

  function stopSpeak(){
    try{ speechSynthesis.cancel(); }catch(e){}
    current = null;
    v.loop = false;
  }

  function playFrom(i, startChar){
    if(i>=tts.parts.length){ try{ v.pause(); }catch(e){} v.loop=false; return; }
    const text = tts.parts[i].slice(startChar);
    const u = new SpeechSynthesisUtterance(text);
    const voice = pickFemaleEsVoice();
    if(voice) u.voice = voice;
    u.lang = (voice?.lang || "es-MX");
    u.rate = 1; u.pitch = 1.15;

    u.onstart = ()=>{ v.loop = true; v.play().catch(()=>{}); };
    u.onboundary = (ev)=>{
      const c = typeof ev.charIndex==="number" ? ev.charIndex : 0;
      tts.last = { i, char: startChar + c };
    };
    u.onend = ()=>{
      if(tts.paused) return;
      tts.i = i+1; tts.offset = 0;
      playFrom(tts.i, 0);
    };

    current = u;
    speechSynthesis.speak(u);
  }

  function speak(full){
    stopSpeak();
    lastFull = full;
    tts.parts = chunk(full);
    tts.i = 0; tts.offset = 0; tts.last = {i:0,char:0}; tts.paused = false;
    playFrom(0,0);
  }

  function toggleAV(){
    if(!current){
      if(lastFull && tts.parts.length){
        tts.paused = false;
        playFrom(tts.last.i, tts.last.char);
      }
      return;
    }
    tts.paused = !tts.paused;
    if(tts.paused){ stopSpeak(); v.pause(); }
    else { const {i,char} = tts.last; playFrom(i,char); }
  }

  function replay(){
    if(!lastFull) return;
    tts.paused = false; tts.last = {i:0,char:0}; speak(lastFull);
  }

  function buildSpoken(data){
    let s = (data.general||"") + ". ";
    (data.lists||[]).forEach(l=>{
      s += (l.title? l.title + ". ": "");
      (l.items||[]).forEach(it=> s += it + ". ");
    });
    (data.tables||[]).forEach(t=>{
      s += (t.title? t.title + ". " : "");
      (t.rows||[]).forEach(r => { s += (Array.isArray(r)? r.join(", ") : String(r)) + ". "; });
    });
    return s;
  }

  // ====== Eventos UI ======
  document.getElementById("send").onclick = async ()=>{
    const q = qEl.value.trim();
    if(!q) return alert("Escribe una pregunta.");
    out.innerHTML = "<p>Procesando‚Ä¶</p>";
    try{
      const r = await fetch(`${API_BASE}/api/answer?q=${encodeURIComponent(q)}`);
      const data = await r.json();
      if(!data.ok){ out.innerHTML = `<p style="color:red;">Error: ${data.error||"Consulta no reconocida"}</p>`; return; }
      renderOutput(data);
      const spoken = buildSpoken(data);
      speak(spoken);
      pushHist({ ts: Date.now(), q, data });
    }catch(e){
      out.innerHTML = `<p style="color:red;">Error de red/servidor</p>`;
    }
  };

  document.getElementById("toggle").onclick = toggleAV;
  document.getElementById("replay").onclick = replay;

  document.getElementById("clear").onclick = ()=>{
    qEl.value=""; out.innerHTML=""; stopSpeak();
  };

  document.getElementById("newS").onclick = ()=>{
    localStorage.removeItem("lexium_hist");
    qEl.value=""; out.innerHTML=""; stopSpeak();
    alert("Nueva sesi√≥n iniciada.");
  };

  // Exportar (vista previa con print)
  document.getElementById("exportSel").onchange = ()=>{
    const val = document.getElementById("exportSel").value;
    if(!val) return;
    window.print(); // vista previa
    document.getElementById("exportSel").value="";
  };

  // Dictado (opcional, simple)
  document.getElementById("dict").onclick = ()=>{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Dictado no soportado en este navegador."); return; }
    const sr = new SR(); sr.lang = "es-MX"; sr.interimResults = false; sr.maxAlternatives = 1;
    sr.onresult = (e)=>{ const t = e.results[0][0].transcript; qEl.value = t; };
    sr.start();
  };

</script>
</body>
</html>
