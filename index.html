<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MMMMLexium GPT-5</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background-color: #f4f4f9;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      background: #2d2d8a;
      color: white;
      text-align: center;
      padding: 12px 0;
      font-size: 1.3em;
      font-weight: 500;
    }

    /* === Contenedor principal fijo para video y avatar === */
    #mediaContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 220px;
      overflow: hidden;
      z-index: 10;
    }

    #avatarVideo {
      width: auto;
      height: 100%;
      object-fit: cover;
    }

    /* === Contenedor de chat === */
    #chatContainer {
      margin-top: 230px; /* deja espacio al video */
      width: 95%;
      max-width: 850px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      padding: 18px;
    }

    #out {
      min-height: 280px;
      white-space: pre-wrap;
    }

    table {
      border-collapse: collapse;
      margin: 12px 0;
      width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: left;
    }

    th {
      background: #efefef;
    }

    /* === Input === */
    #inputRow {
      display: flex;
      margin-top: 10px;
      gap: 6px;
    }

    #q {
      flex: 1;
      padding: 10px;
      border: 1px solid #bbb;
      border-radius: 6px;
      font-size: 1em;
      height: 38px;
      max-height: 38px;
      resize: none;
      overflow: hidden;
    }

    button {
      background: #2d2d8a;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 0.95em;
    }

    button:hover { background: #4242a5; }

    /* === Estado procesando === */
    #status {
      position: fixed;
      top: 8px;
      left: 12px;
      z-index: 999;
      font-size: 0.9em;
      background: rgba(255,255,255,0.7);
      padding: 4px 8px;
      border-radius: 4px;
      color: #333;
      transition: opacity 0.3s;
    }

    /* === Historial modal === */
    #historyBox {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 80%;
      max-width: 600px;
      z-index: 2000;
    }

    #historyBox h3 {
      margin-top: 0;
      color: #2d2d8a;
    }

    #historyList {
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.9em;
    }

    a.link-ok { color: #0066cc; text-decoration: none; }
    a.link-ok:hover { text-decoration: underline; }
    a.link-bad { color: #888; text-decoration: line-through; }
  </style>
</head>
<body>
  <header>LEXIUM GPT-5</header>

  <div id="mediaContainer">
    <video id="avatarVideo" autoplay loop muted>
      <source src="descarga.mp4" type="video/mp4">
    </video>
  </div>

  <div id="status" style="opacity:0;">Procesando…</div>

  <div id="chatContainer">
    <div id="out"><em>Bienvenido, puede iniciar su consulta.</em></div>

    <div id="inputRow">
      <input id="q" placeholder="Escriba su pregunta…" />
      <button id="btnSend">Enviar</button>
      <button id="btnHist">Historial</button>
      <button id="btnClear">Nueva sesión</button>
    </div>
  </div>

  <!-- Modal historial -->
  <div id="historyBox">
    <h3>Historial de preguntas</h3>
    <div id="historyList"></div>
    <div style="text-align:right;margin-top:8px;">
      <button onclick="closeHistory()">Cerrar</button>
    </div>
  </div>

<script>
const API_BASE = "https://lexium-gpt5-383217514425.southamerica-west1.run.app";
const out = document.getElementById("out");
const q = document.getElementById("q");
const btnSend = document.getElementById("btnSend");
const statusBox = document.getElementById("status");
const historyList = document.getElementById("historyList");
let history = [];

function setStatus(msg){ statusBox.style.opacity=1; statusBox.textContent=msg; }
function clearStatus(){ statusBox.style.opacity=0; }

function addToHistory(question, answerHTML){
  history.push({q:question,a:answerHTML});
}

function openHistory(){
  if(!history.length){
    historyList.innerHTML="<em>No hay historial disponible.</em>";
  } else {
    historyList.innerHTML = history.map(
      (h,i)=>`<div><b>${i+1}. ${h.q}</b><br>${h.a}</div><hr>`
    ).join("");
  }
  document.getElementById("historyBox").style.display="block";
}

function closeHistory(){ document.getElementById("historyBox").style.display="none"; }

btnSend.addEventListener("click", ask);
document.getElementById("btnClear").addEventListener("click", ()=>{out.innerHTML="";history=[];});
document.getElementById("btnHist").addEventListener("click", openHistory);

async function ask(){
  if (btnSend._busy) return;
  btnSend._busy = true;
  const text=q.value.trim(); if(!text){ btnSend._busy=false; return; }

  btnSend.disabled=true;
  const old=btnSend.textContent; btnSend.textContent="Enviando…";
  setStatus("Procesando…");

  try{
    const resp = await fetch(`${API_BASE}/api/answer?q=${encodeURIComponent(text)}`);
    const data = await resp.json();
    renderAnswer(data);
    addToHistory(text, out.innerHTML);
  }catch(e){
    out.innerHTML=`<span style="color:red;">Error: ${e}</span>`;
  }finally{
    btnSend.disabled=false; btnSend.textContent=old; clearStatus();
    btnSend._busy=false;
  }
}

async function checkLink(url){
  try{
    const r = await fetch(url, { method:"HEAD" });
    return r.ok;
  }catch{ return false; }
}

async function renderAnswer(data){
  if(!data || !data.ok){ out.innerHTML="<em>Error en respuesta.</em>"; return; }

  let html = "";
  if(data.general) html += `<p>${data.general}</p>`;

  // Listas
  if(Array.isArray(data.lists) && data.lists.length){
    for(const list of data.lists){
      const items = Array.isArray(list)?list:(list.items||[]);
      if(items.length){
        html += `<ul>` + items.map((x,i)=>`<li>${i+1}. ${x}</li>`).join("") + `</ul>`;
      }
    }
  }

  // Tablas
  if(Array.isArray(data.tables) && data.tables.length){
    for(const t of data.tables){
      html += `<h4>${t.title||""}</h4><table><thead><tr>`;
      html += t.columns.map(c=>`<th>${c}</th>`).join("");
      html += `</tr></thead><tbody>`;
      t.rows.forEach((r,i)=>{
        html += `<tr>` + r.map((c,j)=>
          `<td>${j===0 && !isNaN(parseInt(c))? (i+1) : c}</td>`).join("") + `</tr>`;
      });
      html += `</tbody></table>`;
    }
  }

  // Convertir URLs en enlaces clicables y verificar estado
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  const matches = html.match(urlRegex) || [];
  for(const url of matches){
    const ok = await checkLink(url);
    const cls = ok ? "link-ok" : "link-bad";
    const label = ok ? url : `${url} ⚠️`;
    html = html.replace(url, `<a class="${cls}" href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`);
  }

  out.innerHTML = html || "<em>Sin contenido.</em>";
}
</script>
</body>
</html>
