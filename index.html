<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistente Lexium j</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: white;
      font-family: Arial, sans-serif;
    }

    /* --- Contenedor superior con video y logos --- */
    #top-section {
      position: fixed;
      top: 0;
      width: 100%;
      height: 65vh;
      background-color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      z-index: 2;
    }

    #left-logo, #right-logo {
      position: absolute;
      top: 20%;
      width: 120px;
      height: auto;
    }

    #left-logo {
      left: 20px;
    }

    #right-logo {
      right: 20px;
    }

    #video-container {
      max-width: 720px;
      height: 100%;
    }

    #video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: none;
    }

    /* --- Secci√≥n inferior desplazable --- */
    #bottom-section {
      margin-top: 65vh;
      padding: 20px;
      overflow-y: auto;
    }

    textarea {
      width: 100%;
      height: 50px;
      resize: none;
      padding: 10px;
      font-size: 16px;
    }

    .button-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    button, select {
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
    }

    button:hover {
      background-color: #f0f0f0;
    }

    #response-area {
      margin-top: 20px;
      padding: 10px;
      border-top: 1px solid #ddd;
    }

    /* Tabla numerada */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f9f9f9;
    }

    /* Bot√≥n historial */
    #historial-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 3;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 8px 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Bot√≥n historial -->
  <button id="historial-btn" title="Ver historial de consultas">Historial</button>

  <!-- Secci√≥n superior con video y logos -->
  <div id="top-section">
    <img id="left-logo" src="left.png" alt="Logo Izquierdo">
    <div id="video-container">
      <video id="assistant-video" muted>
        <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
      </video>
    </div>
    <img id="right-logo" src="right.png" alt="Logo Derecho">
  </div>

  <!-- Secci√≥n inferior con scroll -->
  <div id="bottom-section">
    <textarea id="user-input" placeholder="Escribe tu pregunta o usa el micr√≥fono (m√°x 2 l√≠neas)..."></textarea>

    <div class="button-row">
      <button id="send-btn" title="Enviar la pregunta">Enviar</button>
      <button id="dictate-btn" title="Dictar usando micr√≥fono">üé§ Dictar</button>
      <button id="toggle-voice-video-btn" title="Pausar/Reanudar voz y video">‚èØÔ∏è Parar/Activar Voz y Video</button>
      <button id="replay-btn" title="Reproducir nuevamente la √∫ltima respuesta">üîÅ Reproducir</button>
      <button id="new-session-btn" title="Iniciar una nueva sesi√≥n">‚û§ Nueva sesi√≥n</button>
      <button id="clear-btn" title="Limpiar texto y respuesta">üóëÔ∏è Limpiar</button>
      <select id="export-select" title="Exportar con vista previa antes de descargar">
        <option value="">Exportar...</option>
        <option value="pdf">PDF</option>
        <option value="xls">XLS</option>
        <option value="doc">DOC</option>
      </select>
    </div>

    <div id="response-area"></div>
  </div>

  <script>
    const API_BASE = "https://lexium-api-383217514425.southamerica-west1.run.app/api";

    const sendBtn = document.getElementById('send-btn');
    const userInput = document.getElementById('user-input');
    const responseArea = document.getElementById('response-area');
    const video = document.getElementById('assistant-video');
    const clearBtn = document.getElementById('clear-btn');
    const replayBtn = document.getElementById('replay-btn');
    const toggleVoiceVideoBtn = document.getElementById('toggle-voice-video-btn');
    const newSessionBtn = document.getElementById('new-session-btn');
    const exportSelect = document.getElementById('export-select');

    let lastSpokenText = "";
    let speechSynthesisUtterance;
    let isPaused = false;

    async function speakText(text) {
      const synth = window.speechSynthesis;
      synth.cancel();

      speechSynthesisUtterance = new SpeechSynthesisUtterance(text);
      speechSynthesisUtterance.lang = "es-MX"; // Espa√±ol M√©xico
      speechSynthesisUtterance.pitch = 1;
      speechSynthesisUtterance.rate = 1;

      const voices = synth.getVoices();
      const femaleVoice = voices.find(v => v.lang.startsWith('es') && v.name.toLowerCase().includes('female')) || voices.find(v => v.lang.startsWith('es'));
      if (femaleVoice) speechSynthesisUtterance.voice = femaleVoice;

      // Sincronizar con video
      speechSynthesisUtterance.onstart = () => {
        video.play();
      };

      speechSynthesisUtterance.onend = () => {
        video.pause();
      };

      synth.speak(speechSynthesisUtterance);
    }

    sendBtn.addEventListener('click', async () => {
      const query = userInput.value.trim();
      if (!query) return alert("Escribe una pregunta");

      responseArea.innerHTML = "Procesando...";
      try {
        const res = await fetch(`${API_BASE}/answer?q=${encodeURIComponent(query)}`);
        const data = await res.json();

        if (!data.ok) {
          responseArea.innerHTML = `<p style="color:red;">Error: ${data.error || 'Consulta no reconocida'}</p>`;
          return;
        }

        let output = `<p>${data.general || ''}</p>`;

        data.tables.forEach((table, idx) => {
          output += `<h3>${table.title}</h3><table><thead><tr>`;
          table.columns.forEach(col => output += `<th>${col}</th>`);
          output += `</tr></thead><tbody>`;
          table.rows.forEach((row, rIdx) => {
            output += `<tr><td>${rIdx + 1}</td>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
          });
          output += `</tbody></table>`;
        });

        responseArea.innerHTML = output;
        lastSpokenText = data.general + " " + data.tables.map(t => t.rows.map(r => r.join(", ")).join(". ")).join(". ");
        speakText(lastSpokenText);

      } catch (err) {
        responseArea.innerHTML = `<p style="color:red;">Error al conectar con el servidor</p>`;
      }
    });

    clearBtn.addEventListener('click', () => {
      userInput.value = "";
      responseArea.innerHTML = "";
      window.speechSynthesis.cancel();
    });

    replayBtn.addEventListener('click', () => {
      if (lastSpokenText) speakText(lastSpokenText);
    });

    toggleVoiceVideoBtn.addEventListener('click', () => {
      const synth = window.speechSynthesis;
      if (!isPaused) {
        synth.pause();
        video.pause();
        isPaused = true;
      } else {
        synth.resume();
        video.play();
        isPaused = false;
      }
    });

    newSessionBtn.addEventListener('click', () => {
      userInput.value = "";
      responseArea.innerHTML = "";
      lastSpokenText = "";
      window.speechSynthesis.cancel();
      alert("Nueva sesi√≥n iniciada.");
    });

    exportSelect.addEventListener('change', () => {
      const format = exportSelect.value;
      if (!format) return;
      window.print();
      exportSelect.value = "";
    });
  </script>
</body>
</html>
